{"version":3,"file":"annotorious-selector-pack.min.js","mappings":";CAAA,SAA2CA,EAAMC,GAC1B,iBAAZC,SAA0C,iBAAXC,OACxCA,OAAOD,QAAUD,IACQ,mBAAXG,QAAyBA,OAAOC,IAC9CD,OAAO,GAAIH,GACe,iBAAZC,QACdA,QAAqB,YAAID,KAEzBD,EAAkB,YAAIA,EAAkB,aAAK,GAAIA,EAAkB,YAAgB,aAAIC,KARzF,CASGK,MAAM,WACT,8CCVYC,wOAAAA,EAAuJ,WAAW,aAAa,SAASC,EAAEA,EAAEC,EAAEC,EAAEC,EAAEC,IAAI,SAASJ,EAAEK,EAAEJ,EAAEC,EAAEC,EAAEC,GAAG,KAAKD,EAAED,GAAG,CAAC,GAAGC,EAAED,EAAE,IAAI,CAAC,IAAII,EAAEH,EAAED,EAAE,EAAEK,EAAEN,EAAEC,EAAE,EAAEM,EAAEC,KAAKC,IAAIJ,GAAGK,EAAE,GAAGF,KAAKG,IAAI,EAAEJ,EAAE,GAAGK,EAAE,GAAGJ,KAAKK,KAAKN,EAAEG,GAAGL,EAAEK,GAAGL,IAAIC,EAAED,EAAE,EAAE,GAAG,EAAE,GAA+EN,EAAEK,EAAEJ,EAA9EQ,KAAKM,IAAIb,EAAEO,KAAKO,MAAMf,EAAEM,EAAEI,EAAEL,EAAEO,IAAMJ,KAAKQ,IAAId,EAAEM,KAAKO,MAAMf,GAAGK,EAAEC,GAAGI,EAAEL,EAAEO,IAAcT,GAAG,IAAIc,EAAEb,EAAEJ,GAAGkB,EAAEjB,EAAEkB,EAAEjB,EAAE,IAAIJ,EAAEM,EAAEH,EAAED,GAAGG,EAAEC,EAAEF,GAAGe,GAAG,GAAGnB,EAAEM,EAAEH,EAAEC,GAAGgB,EAAEC,GAAG,CAAC,IAAIrB,EAAEM,EAAEc,EAAEC,GAAGD,IAAIC,IAAIhB,EAAEC,EAAEc,GAAGD,GAAG,GAAGC,IAAI,KAAKf,EAAEC,EAAEe,GAAGF,GAAG,GAAGE,IAAI,IAAIhB,EAAEC,EAAEH,GAAGgB,GAAGnB,EAAEM,EAAEH,EAAEkB,GAAGrB,EAAEM,IAAIe,EAAEjB,GAAGiB,GAAGnB,IAAIC,EAAEkB,EAAE,GAAGnB,GAAGmB,IAAIjB,EAAEiB,EAAE,IAA3Z,CAAgapB,EAAEC,EAAEC,GAAG,EAAEC,GAAGH,EAAEqB,OAAO,EAAEjB,GAAGC,GAAG,SAASN,EAAEC,EAAED,EAAEM,GAAG,IAAIJ,EAAED,EAAED,GAAGC,EAAED,GAAGC,EAAEK,GAAGL,EAAEK,GAAGJ,EAAE,SAASI,EAAEL,EAAED,GAAG,OAAOC,EAAED,GAAG,EAAEC,EAAED,EAAE,EAAE,EAAE,IAAIE,EAAE,SAASD,QAAG,IAASA,IAAIA,EAAE,GAAGsB,KAAKC,YAAYd,KAAKM,IAAI,EAAEf,GAAGsB,KAAKE,YAAYf,KAAKM,IAAI,EAAEN,KAAKgB,KAAK,GAAGH,KAAKC,cAAcD,KAAKI,SAAS,SAASxB,EAAEF,EAAED,EAAEM,GAAG,IAAIA,EAAE,OAAON,EAAE4B,QAAQ3B,GAAG,IAAI,IAAIC,EAAE,EAAEA,EAAEF,EAAEsB,OAAOpB,IAAI,GAAGI,EAAEL,EAAED,EAAEE,IAAI,OAAOA,EAAE,OAAO,EAAE,SAASE,EAAEH,EAAED,GAAGK,EAAEJ,EAAE,EAAEA,EAAE4B,SAASP,OAAOtB,EAAEC,GAAG,SAASI,EAAEJ,EAAED,EAAEM,EAAEJ,EAAEC,GAAGA,IAAIA,EAAEgB,EAAE,OAAOhB,EAAE2B,KAAK,IAAI3B,EAAE4B,KAAK,IAAI5B,EAAE6B,MAAK,IAAK7B,EAAE8B,MAAK,IAAK,IAAI,IAAI7B,EAAEJ,EAAEI,EAAEE,EAAEF,IAAI,CAAC,IAAIC,EAAEJ,EAAE4B,SAASzB,GAAGG,EAAEJ,EAAEF,EAAEiC,KAAKhC,EAAEG,GAAGA,GAAG,OAAOF,EAAE,SAASI,EAAEN,EAAED,GAAG,OAAOC,EAAE6B,KAAKpB,KAAKQ,IAAIjB,EAAE6B,KAAK9B,EAAE8B,MAAM7B,EAAE8B,KAAKrB,KAAKQ,IAAIjB,EAAE8B,KAAK/B,EAAE+B,MAAM9B,EAAE+B,KAAKtB,KAAKM,IAAIf,EAAE+B,KAAKhC,EAAEgC,MAAM/B,EAAEgC,KAAKvB,KAAKM,IAAIf,EAAEgC,KAAKjC,EAAEiC,MAAMhC,EAAE,SAASO,EAAEP,EAAED,GAAG,OAAOC,EAAE6B,KAAK9B,EAAE8B,KAAK,SAASrB,EAAER,EAAED,GAAG,OAAOC,EAAE8B,KAAK/B,EAAE+B,KAAK,SAASnB,EAAEX,GAAG,OAAOA,EAAE+B,KAAK/B,EAAE6B,OAAO7B,EAAEgC,KAAKhC,EAAE8B,MAAM,SAASjB,EAAEb,GAAG,OAAOA,EAAE+B,KAAK/B,EAAE6B,MAAM7B,EAAEgC,KAAKhC,EAAE8B,MAAM,SAASI,EAAElC,EAAED,GAAG,OAAOC,EAAE6B,MAAM9B,EAAE8B,MAAM7B,EAAE8B,MAAM/B,EAAE+B,MAAM/B,EAAEgC,MAAM/B,EAAE+B,MAAMhC,EAAEiC,MAAMhC,EAAEgC,KAAK,SAASG,EAAEnC,EAAED,GAAG,OAAOA,EAAE8B,MAAM7B,EAAE+B,MAAMhC,EAAE+B,MAAM9B,EAAEgC,MAAMjC,EAAEgC,MAAM/B,EAAE6B,MAAM9B,EAAEiC,MAAMhC,EAAE8B,KAAK,SAASZ,EAAElB,GAAG,MAAM,CAAC4B,SAAS5B,EAAEoC,OAAO,EAAEH,MAAK,EAAGJ,KAAK,IAAIC,KAAK,IAAIC,MAAK,IAAKC,MAAK,KAAM,SAASb,EAAEpB,EAAEM,EAAEJ,EAAEC,EAAEC,GAAG,IAAI,IAAIC,EAAE,CAACC,EAAEJ,GAAGG,EAAEiB,QAAQ,MAAMpB,EAAEG,EAAEiC,QAAQhC,EAAED,EAAEiC,QAAQnC,GAAG,CAAC,IAAII,EAAED,EAAEI,KAAKgB,MAAMxB,EAAEI,GAAGH,EAAE,GAAGA,EAAEF,EAAED,EAAEO,EAAED,EAAEJ,EAAEE,GAAGC,EAAEkC,KAAKjC,EAAEC,EAAEA,EAAEL,IAAI,OAAOA,EAAEsC,UAAUC,IAAI,WAAW,OAAOlB,KAAKmB,KAAKnB,KAAKoB,KAAK,KAAKzC,EAAEsC,UAAUI,OAAO,SAAS3C,GAAG,IAAID,EAAEuB,KAAKoB,KAAKrC,EAAE,GAAG,IAAI8B,EAAEnC,EAAED,GAAG,OAAOM,EAAE,IAAI,IAAIJ,EAAEqB,KAAKsB,OAAO1C,EAAE,GAAGH,GAAG,CAAC,IAAI,IAAII,EAAE,EAAEA,EAAEJ,EAAE6B,SAASP,OAAOlB,IAAI,CAAC,IAAIC,EAAEL,EAAE6B,SAASzB,GAAGG,EAAEP,EAAEkC,KAAKhC,EAAEG,GAAGA,EAAE+B,EAAEnC,EAAEM,KAAKP,EAAEkC,KAAK5B,EAAEiC,KAAKlC,GAAG8B,EAAElC,EAAEM,GAAGgB,KAAKmB,KAAKrC,EAAEC,GAAGH,EAAEoC,KAAKlC,IAAIL,EAAEG,EAAEmC,MAAM,OAAOhC,GAAGJ,EAAEsC,UAAUM,SAAS,SAAS7C,GAAG,IAAID,EAAEuB,KAAKoB,KAAK,IAAIP,EAAEnC,EAAED,GAAG,OAAM,EAAG,IAAI,IAAIM,EAAE,GAAGN,GAAG,CAAC,IAAI,IAAIE,EAAE,EAAEA,EAAEF,EAAE6B,SAASP,OAAOpB,IAAI,CAAC,IAAIC,EAAEH,EAAE6B,SAAS3B,GAAGE,EAAEJ,EAAEkC,KAAKX,KAAKsB,OAAO1C,GAAGA,EAAE,GAAGiC,EAAEnC,EAAEG,GAAG,CAAC,GAAGJ,EAAEkC,MAAMC,EAAElC,EAAEG,GAAG,OAAM,EAAGE,EAAEiC,KAAKpC,IAAIH,EAAEM,EAAEgC,MAAM,OAAM,GAAIpC,EAAEsC,UAAUO,KAAK,SAAS9C,GAAG,IAAIA,IAAIA,EAAEqB,OAAO,OAAOC,KAAK,GAAGtB,EAAEqB,OAAOC,KAAKE,YAAY,CAAC,IAAI,IAAIzB,EAAE,EAAEA,EAAEC,EAAEqB,OAAOtB,IAAIuB,KAAKyB,OAAO/C,EAAED,IAAI,OAAOuB,KAAK,IAAIjB,EAAEiB,KAAK0B,OAAOhD,EAAEiD,QAAQ,EAAEjD,EAAEqB,OAAO,EAAE,GAAG,GAAGC,KAAKoB,KAAKd,SAASP,OAAO,GAAGC,KAAKoB,KAAKN,SAAS/B,EAAE+B,OAAOd,KAAK4B,WAAW5B,KAAKoB,KAAKrC,OAAO,CAAC,GAAGiB,KAAKoB,KAAKN,OAAO/B,EAAE+B,OAAO,CAAC,IAAInC,EAAEqB,KAAKoB,KAAKpB,KAAKoB,KAAKrC,EAAEA,EAAEJ,EAAEqB,KAAK6B,QAAQ9C,EAAEiB,KAAKoB,KAAKN,OAAO/B,EAAE+B,OAAO,GAAE,QAASd,KAAKoB,KAAKrC,EAAE,OAAOiB,MAAMrB,EAAEsC,UAAUQ,OAAO,SAAS/C,GAAG,OAAOA,GAAGsB,KAAK6B,QAAQnD,EAAEsB,KAAKoB,KAAKN,OAAO,GAAGd,MAAMrB,EAAEsC,UAAUb,MAAM,WAAW,OAAOJ,KAAKoB,KAAKxB,EAAE,IAAII,MAAMrB,EAAEsC,UAAUa,OAAO,SAASpD,EAAED,GAAG,IAAIC,EAAE,OAAOsB,KAAK,IAAI,IAAIjB,EAAEJ,EAAEE,EAAEC,EAAEkB,KAAKoB,KAAKpC,EAAEgB,KAAKsB,OAAO5C,GAAGO,EAAE,GAAGC,EAAE,GAAGJ,GAAGG,EAAEc,QAAQ,CAAC,GAAGjB,IAAIA,EAAEG,EAAE8B,MAAMpC,EAAEM,EAAEA,EAAEc,OAAO,GAAGhB,EAAEG,EAAE6B,MAAMlC,GAAE,GAAIC,EAAE6B,KAAK,CAAC,IAAItB,EAAET,EAAEF,EAAEI,EAAEwB,SAAS7B,GAAG,IAAI,IAAIY,EAAE,OAAOP,EAAEwB,SAASyB,OAAO1C,EAAE,GAAGJ,EAAE+B,KAAKlC,GAAGkB,KAAKgC,UAAU/C,GAAGe,KAAKnB,GAAGC,EAAE6B,OAAOC,EAAE9B,EAAEE,GAAGL,GAAGI,IAAID,EAAEH,EAAE2B,SAASvB,GAAGF,GAAE,GAAIC,EAAE,MAAMG,EAAE+B,KAAKlC,GAAGI,EAAE8B,KAAKjC,GAAGA,EAAE,EAAEJ,EAAEG,EAAEA,EAAEA,EAAEwB,SAAS,IAAI,OAAON,MAAMrB,EAAEsC,UAAUK,OAAO,SAAS5C,GAAG,OAAOA,GAAGC,EAAEsC,UAAUgB,YAAY,SAASvD,EAAED,GAAG,OAAOC,EAAE6B,KAAK9B,EAAE8B,MAAM5B,EAAEsC,UAAUiB,YAAY,SAASxD,EAAED,GAAG,OAAOC,EAAE8B,KAAK/B,EAAE+B,MAAM7B,EAAEsC,UAAUkB,OAAO,WAAW,OAAOnC,KAAKoB,MAAMzC,EAAEsC,UAAUmB,SAAS,SAAS1D,GAAG,OAAOsB,KAAKoB,KAAK1C,EAAEsB,MAAMrB,EAAEsC,UAAUE,KAAK,SAASzC,EAAED,GAAG,IAAI,IAAIM,EAAE,GAAGL,GAAGA,EAAEiC,KAAKlC,EAAEuC,KAAKqB,MAAM5D,EAAEC,EAAE4B,UAAUvB,EAAEiC,KAAKqB,MAAMtD,EAAEL,EAAE4B,UAAU5B,EAAEK,EAAEgC,MAAM,OAAOtC,GAAGE,EAAEsC,UAAUS,OAAO,SAAShD,EAAED,EAAEM,EAAEJ,GAAG,IAAIC,EAAEE,EAAEC,EAAEN,EAAE,EAAEO,EAAEgB,KAAKC,YAAY,GAAGnB,GAAGE,EAAE,OAAOH,EAAED,EAAEgB,EAAElB,EAAEiD,MAAMlD,EAAEM,EAAE,IAAIiB,KAAKsB,QAAQ1C,EAAED,IAAIA,EAAEQ,KAAKgB,KAAKhB,KAAKC,IAAIN,GAAGK,KAAKC,IAAIJ,IAAIA,EAAEG,KAAKgB,KAAKrB,EAAEK,KAAKmD,IAAItD,EAAEL,EAAE,MAAMC,EAAEgB,EAAE,KAAKe,MAAK,EAAG/B,EAAEkC,OAAOnC,EAAE,IAAIM,EAAEE,KAAKgB,KAAKrB,EAAEE,GAAGE,EAAED,EAAEE,KAAKgB,KAAKhB,KAAKK,KAAKR,IAAIa,EAAEnB,EAAED,EAAEM,EAAEG,EAAEc,KAAKiC,aAAa,IAAI,IAAI5C,EAAEZ,EAAEY,GAAGN,EAAEM,GAAGH,EAAE,CAAC,IAAIK,EAAEJ,KAAKQ,IAAIN,EAAEH,EAAE,EAAEH,GAAGc,EAAEnB,EAAEW,EAAEE,EAAEN,EAAEe,KAAKkC,aAAa,IAAI,IAAItB,EAAEvB,EAAEuB,GAAGrB,EAAEqB,GAAG3B,EAAE,CAAC,IAAI4B,EAAE1B,KAAKQ,IAAIiB,EAAE3B,EAAE,EAAEM,GAAGX,EAAE0B,SAASU,KAAKhB,KAAK0B,OAAOhD,EAAEkC,EAAEC,EAAElC,EAAE,KAAK,OAAOE,EAAED,EAAEoB,KAAKsB,QAAQ1C,GAAGD,EAAEsC,UAAUsB,eAAe,SAAS7D,EAAED,EAAEM,EAAEJ,GAAG,KAAKA,EAAEqC,KAAKvC,IAAIA,EAAEkC,MAAMhC,EAAEoB,OAAO,IAAIhB,GAAG,CAAC,IAAI,IAAIH,EAAE,IAAIC,EAAE,IAAIC,OAAE,EAAOE,EAAE,EAAEA,EAAEP,EAAE6B,SAASP,OAAOf,IAAI,CAAC,IAAIC,EAAER,EAAE6B,SAAStB,GAAGE,EAAEG,EAAEJ,GAAGM,GAAGqB,EAAElC,EAAEmC,EAAE5B,GAAGE,KAAKM,IAAIoB,EAAEJ,KAAKG,EAAEH,MAAMtB,KAAKQ,IAAIkB,EAAEN,KAAKK,EAAEL,QAAQpB,KAAKM,IAAIoB,EAAEH,KAAKE,EAAEF,MAAMvB,KAAKQ,IAAIkB,EAAEL,KAAKI,EAAEJ,OAAOtB,GAAGK,EAAEV,GAAGA,EAAEU,EAAEX,EAAEM,EAAEN,EAAEM,EAAEN,EAAEE,EAAEG,GAAGM,IAAIV,GAAGK,EAAEN,IAAIA,EAAEM,EAAEJ,EAAEG,GAAGR,EAAEK,GAAGL,EAAE6B,SAAS,GAAG,IAAIM,EAAEC,EAAE,OAAOpC,GAAGE,EAAEsC,UAAUY,QAAQ,SAASnD,EAAED,EAAEM,GAAG,IAAIJ,EAAEI,EAAEL,EAAEsB,KAAKsB,OAAO5C,GAAGE,EAAE,GAAGC,EAAEmB,KAAKuC,eAAe5D,EAAEqB,KAAKoB,KAAK3C,EAAEG,GAAG,IAAIC,EAAEyB,SAASU,KAAKtC,GAAGM,EAAEH,EAAEF,GAAGF,GAAG,GAAGG,EAAEH,GAAG6B,SAASP,OAAOC,KAAKC,aAAaD,KAAKwC,OAAO5D,EAAEH,GAAGA,IAAIuB,KAAKyC,oBAAoB9D,EAAEC,EAAEH,IAAIE,EAAEsC,UAAUuB,OAAO,SAAS9D,EAAED,GAAG,IAAIM,EAAEL,EAAED,GAAGE,EAAEI,EAAEuB,SAASP,OAAOnB,EAAEoB,KAAKE,YAAYF,KAAK0C,iBAAiB3D,EAAEH,EAAED,GAAG,IAAIG,EAAEkB,KAAK2C,kBAAkB5D,EAAEH,EAAED,GAAGK,EAAEY,EAAEb,EAAEuB,SAASyB,OAAOjD,EAAEC,EAAEuB,SAASP,OAAOjB,IAAIE,EAAE8B,OAAO/B,EAAE+B,OAAO9B,EAAE2B,KAAK5B,EAAE4B,KAAK9B,EAAEE,EAAEiB,KAAKsB,QAAQzC,EAAEG,EAAEgB,KAAKsB,QAAQ7C,EAAEC,EAAED,EAAE,GAAG6B,SAASU,KAAKhC,GAAGgB,KAAK4B,WAAW7C,EAAEC,IAAIL,EAAEsC,UAAUW,WAAW,SAASlD,EAAED,GAAGuB,KAAKoB,KAAKxB,EAAE,CAAClB,EAAED,IAAIuB,KAAKoB,KAAKN,OAAOpC,EAAEoC,OAAO,EAAEd,KAAKoB,KAAKT,MAAK,EAAG9B,EAAEmB,KAAKoB,KAAKpB,KAAKsB,SAAS3C,EAAEsC,UAAU0B,kBAAkB,SAASjE,EAAED,EAAEM,GAAG,IAAI,IAAIJ,EAAEC,EAAEC,EAAEG,EAAEC,EAAEC,EAAEK,EAAEqB,EAAE,IAAIC,EAAE,IAAIjB,EAAEnB,EAAEmB,GAAGb,EAAEN,EAAEmB,IAAI,CAAC,IAAIC,EAAEf,EAAEJ,EAAE,EAAEkB,EAAEI,KAAKsB,QAAQxB,EAAEhB,EAAEJ,EAAEkB,EAAEb,EAAEiB,KAAKsB,QAAQsB,GAAGhE,EAAEiB,EAAEhB,EAAEiB,EAAsCd,EAAEG,KAAKM,IAAIb,EAAE2B,KAAK1B,EAAE0B,MAAMtB,EAAEE,KAAKM,IAAIb,EAAE4B,KAAK3B,EAAE2B,MAAMtB,EAAEC,KAAKQ,IAAIf,EAAE6B,KAAK5B,EAAE4B,MAAMlB,EAAEJ,KAAKQ,IAAIf,EAAE8B,KAAK7B,EAAE6B,MAAMvB,KAAKM,IAAI,EAAEP,EAAEF,GAAGG,KAAKM,IAAI,EAAEF,EAAEN,IAAI4D,EAAExD,EAAEQ,GAAGR,EAAES,GAAG8C,EAAEhC,GAAGA,EAAEgC,EAAEjE,EAAEiB,EAAEiB,EAAEgC,EAAEhC,EAAEgC,EAAEhC,GAAG+B,IAAIhC,GAAGiC,EAAEhC,IAAIA,EAAEgC,EAAElE,EAAEiB,GAAG,OAAOjB,GAAGI,EAAEN,GAAGE,EAAEsC,UAAUyB,iBAAiB,SAAShE,EAAED,EAAEM,GAAG,IAAIJ,EAAED,EAAEiC,KAAKX,KAAKiC,YAAYhD,EAAEL,EAAEF,EAAEiC,KAAKX,KAAKkC,YAAYhD,EAAEc,KAAK8C,eAAepE,EAAED,EAAEM,EAAEJ,GAAGqB,KAAK8C,eAAepE,EAAED,EAAEM,EAAEH,IAAIF,EAAE4B,SAASyC,KAAKpE,IAAIA,EAAEsC,UAAU6B,eAAe,SAASpE,EAAED,EAAEM,EAAEJ,GAAGD,EAAE4B,SAASyC,KAAKpE,GAAG,IAAI,IAAIC,EAAEoB,KAAKsB,OAAOzC,EAAEC,EAAEJ,EAAE,EAAED,EAAEG,GAAGK,EAAEH,EAAEJ,EAAEK,EAAEN,EAAEM,EAAEH,GAAGM,EAAEK,EAAEV,GAAGU,EAAEN,GAAGI,EAAEZ,EAAEY,EAAEN,EAAEN,EAAEY,IAAI,CAAC,IAAIuB,EAAElC,EAAE4B,SAASjB,GAAGL,EAAEH,EAAEH,EAAEiC,KAAK/B,EAAEgC,GAAGA,GAAG1B,GAAGK,EAAEV,GAAG,IAAI,IAAIgC,EAAE9B,EAAEN,EAAE,EAAEoC,GAAGpC,EAAEoC,IAAI,CAAC,IAAIjB,EAAElB,EAAE4B,SAASO,GAAG7B,EAAEC,EAAEP,EAAEiC,KAAK/B,EAAEgB,GAAGA,GAAGV,GAAGK,EAAEN,GAAG,OAAOC,GAAGP,EAAEsC,UAAUwB,oBAAoB,SAAS/D,EAAED,EAAEM,GAAG,IAAI,IAAIJ,EAAEI,EAAEJ,GAAG,EAAEA,IAAIK,EAAEP,EAAEE,GAAGD,IAAIC,EAAEsC,UAAUe,UAAU,SAAStD,GAAG,IAAI,IAAID,EAAEC,EAAEqB,OAAO,EAAEhB,OAAE,EAAON,GAAG,EAAEA,IAAI,IAAIC,EAAED,GAAG6B,SAASP,OAAOtB,EAAE,GAAGM,EAAEL,EAAED,EAAE,GAAG6B,UAAUyB,OAAOhD,EAAEsB,QAAQ3B,EAAED,IAAI,GAAGuB,KAAKI,QAAQvB,EAAEH,EAAED,GAAGuB,KAAKsB,SAAS3C,GAA5yM,UAAwB,EAAPP,GAAoCC,EAAOD,QAAQK,SAAkD,0BAARH,EAAAA,GAAQ,2CCArI,SAAS0E,KAKTA,EAAE/B,UAAY,CACZgC,GAAI,SAAUC,EAAMC,EAAUC,GAC5B,IAAIxE,EAAIoB,KAAKpB,IAAMoB,KAAKpB,EAAI,IAO5B,OALCA,EAAEsE,KAAUtE,EAAEsE,GAAQ,KAAKlC,KAAK,CAC/BqC,GAAIF,EACJC,IAAKA,IAGApD,MAGTsD,KAAM,SAAUJ,EAAMC,EAAUC,GAC9B,IAAI5E,EAAOwB,KACX,SAASuD,IACP/E,EAAKgF,IAAIN,EAAMK,GACfJ,EAASd,MAAMe,EAAKK,WAItB,OADAF,EAASG,EAAIP,EACNnD,KAAKiD,GAAGC,EAAMK,EAAUH,IAGjCO,KAAM,SAAUT,GAMd,IALA,IAAI9B,EAAO,GAAGO,MAAMiC,KAAKH,UAAW,GAChCI,IAAW7D,KAAKpB,IAAMoB,KAAKpB,EAAI,KAAKsE,IAAS,IAAIvB,QACjDlD,EAAI,EACJqF,EAAMD,EAAO9D,OAETtB,EAAIqF,EAAKrF,IACfoF,EAAOpF,GAAG4E,GAAGhB,MAAMwB,EAAOpF,GAAG2E,IAAKhC,GAGpC,OAAOpB,MAGTwD,IAAK,SAAUN,EAAMC,GACnB,IAAIvE,EAAIoB,KAAKpB,IAAMoB,KAAKpB,EAAI,IACxBmF,EAAOnF,EAAEsE,GACTc,EAAa,GAEjB,GAAID,GAAQZ,EACV,IAAK,IAAI1E,EAAI,EAAGqF,EAAMC,EAAKhE,OAAQtB,EAAIqF,EAAKrF,IACtCsF,EAAKtF,GAAG4E,KAAOF,GAAYY,EAAKtF,GAAG4E,GAAGK,IAAMP,GAC9Ca,EAAWhD,KAAK+C,EAAKtF,IAY3B,OAJCuF,EAAWjE,OACRnB,EAAEsE,GAAQc,SACHpF,EAAEsE,GAENlD,OAIX3B,EAAOD,QAAU4E,EACjB3E,EAAOD,QAAQ6F,YAAcjB,wBChE7B,sOAIA3E,EAAOD,QAAU,SAAS8F,EAAMrF,EAAGsF,GACjC,GAAItF,IAAMsF,EAAG,OAAO,EAEpB,GAAItF,GAAKsF,GAAiB,UAAZ,EAAOtF,IAA6B,UAAZ,EAAOsF,GAAe,CAC1D,GAAItF,EAAEuF,cAAgBD,EAAEC,YAAa,OAAO,EAE5C,IAAIrE,EAAQtB,EAAG4F,EACf,GAAIC,MAAMC,QAAQ1F,GAAI,CAEpB,IADAkB,EAASlB,EAAEkB,SACGoE,EAAEpE,OAAQ,OAAO,EAC/B,IAAKtB,EAAIsB,EAAgB,GAARtB,KACf,IAAKyF,EAAMrF,EAAEJ,GAAI0F,EAAE1F,IAAK,OAAO,EACjC,OAAO,EAKT,GAAII,EAAEuF,cAAgBI,OAAQ,OAAO3F,EAAE4F,SAAWN,EAAEM,QAAU5F,EAAE6F,QAAUP,EAAEO,MAC5E,GAAI7F,EAAE8F,UAAYC,OAAO3D,UAAU0D,QAAS,OAAO9F,EAAE8F,YAAcR,EAAEQ,UACrE,GAAI9F,EAAEgG,WAAaD,OAAO3D,UAAU4D,SAAU,OAAOhG,EAAEgG,aAAeV,EAAEU,WAIxE,IADA9E,GADAsE,EAAOO,OAAOP,KAAKxF,IACLkB,UACC6E,OAAOP,KAAKF,GAAGpE,OAAQ,OAAO,EAE7C,IAAKtB,EAAIsB,EAAgB,GAARtB,KACf,IAAKmG,OAAO3D,UAAU6D,eAAelB,KAAKO,EAAGE,EAAK5F,IAAK,OAAO,EAEhE,IAAKA,EAAIsB,EAAgB,GAARtB,KAAY,CAC3B,IAAIsG,EAAMV,EAAK5F,GAEf,IAAKyF,EAAMrF,EAAEkG,GAAMZ,EAAEY,IAAO,OAAO,EAGrC,OAAO,EAIT,OAAOlG,GAAIA,GAAKsF,GAAIA,KC3ClBa,EAA2B,GAG/B,SAASC,EAAoBC,GAE5B,IAAIC,EAAeH,EAAyBE,GAC5C,QAAqBE,IAAjBD,EACH,OAAOA,EAAa/G,QAGrB,IAAIC,EAAS2G,EAAyBE,GAAY,CAGjD9G,QAAS,IAOV,OAHAiH,EAAoBH,GAAUtB,KAAKvF,EAAOD,QAASC,EAAQA,EAAOD,QAAS6G,GAGpE5G,EAAOD,QCpBf6G,EAAoBlG,EAAKV,IACxB,IAAIiH,EAASjH,GAAUA,EAAOkH,WAC7B,IAAOlH,EAAiB,QACxB,IAAM,EAEP,OADA4G,EAAoBpF,EAAEyF,EAAQ,CAAEzG,EAAGyG,IAC5BA,GCLRL,EAAoBpF,EAAI,CAACzB,EAASoH,KACjC,IAAI,IAAIT,KAAOS,EACXP,EAAoBjG,EAAEwG,EAAYT,KAASE,EAAoBjG,EAAEZ,EAAS2G,IAC5EH,OAAOa,eAAerH,EAAS2G,EAAK,CAAEW,YAAY,EAAMC,IAAKH,EAAWT,MCJ3EE,EAAoBjG,EAAI,CAAC4G,EAAKC,IAAUjB,OAAO3D,UAAU6D,eAAelB,KAAKgC,EAAKC,iECG9EC,oBCGSC,EAAgB,WAAH,MACxB,iBAAkBC,QAChBC,UAAUC,eAAiB,GACzBD,UAAUE,iBAAmB,GCTtBC,EAAgB,6BAEvBC,EAAgB,SAAAC,GACpB,IAAMC,EAAOD,EAAGE,aAAa,SAC7B,OAAOD,EAAO,IAAIE,IAAIF,EAAKG,MAAM,MAAQ,IAAID,KAKlCE,EAAW,SAACL,EAAIM,GAC3B,IAAMC,EAAaR,EAAcC,GACjCO,EAAWC,IAAIF,GACfN,EAAGS,aAAa,QAASzC,MAAM0C,KAAKH,GAAYI,KAAK,OAG1CC,EAAc,SAACZ,EAAIM,GAC9B,IAAMC,EAAaR,EAAcC,GACjCO,EAAU,OAAQD,GAEM,IAApBC,EAAWM,KACbb,EAAGc,gBAAgB,SAEnBd,EAAGS,aAAa,QAASzC,MAAM0C,KAAKH,GAAYI,KAAK,OAG5CI,EAAW,SAACf,EAAIM,GAAS,OACpCP,EAAcC,GAAIgB,IAAIV,IFtBpBW,EAAQ,IAAIC,WAAW,IACZ,SAASC,IAEtB,IAAK3B,KAGHA,EAAoC,oBAAX4B,QAA0BA,OAAO5B,iBAAmB4B,OAAO5B,gBAAgB6B,KAAKD,SAA+B,oBAAbE,UAAgE,mBAA7BA,SAAS9B,iBAAkC8B,SAAS9B,gBAAgB6B,KAAKC,WAGrO,MAAM,IAAIC,MAAM,4GAIpB,OAAO/B,EAAgByB,GGjBzB,8HCMA,EAJA,SAAkBO,GAChB,MAAuB,iBAATA,GAAqBC,EAAAA,KAAWD,ICKhD,IAFA,IAAIE,EAAY,GAEPvJ,EAAI,EAAGA,EAAI,MAAOA,EACzBuJ,EAAUhH,MAAMvC,EAAI,KAAOoG,SAAS,IAAIoD,OAAO,IAoBjD,MCNA,EApBA,SAAYC,EAASC,EAAKC,GAExB,IAAIC,GADJH,EAAUA,GAAW,IACFI,SAAWJ,EAAQT,KAAOA,KAK7C,GAHAY,EAAK,GAAe,GAAVA,EAAK,GAAY,GAC3BA,EAAK,GAAe,GAAVA,EAAK,GAAY,IAEvBF,EAAK,CACPC,EAASA,GAAU,EAEnB,IAAK,IAAI3J,EAAI,EAAGA,EAAI,KAAMA,EACxB0J,EAAIC,EAAS3J,GAAK4J,EAAK5J,GAGzB,OAAO0J,EAGT,ODRF,SAAmBI,GACjB,IAAIH,EAAS3E,UAAU1D,OAAS,QAAsBqF,IAAjB3B,UAAU,GAAmBA,UAAU,GAAK,EAG7EqE,GAAQE,EAAUO,EAAIH,EAAS,IAAMJ,EAAUO,EAAIH,EAAS,IAAMJ,EAAUO,EAAIH,EAAS,IAAMJ,EAAUO,EAAIH,EAAS,IAAM,IAAMJ,EAAUO,EAAIH,EAAS,IAAMJ,EAAUO,EAAIH,EAAS,IAAM,IAAMJ,EAAUO,EAAIH,EAAS,IAAMJ,EAAUO,EAAIH,EAAS,IAAM,IAAMJ,EAAUO,EAAIH,EAAS,IAAMJ,EAAUO,EAAIH,EAAS,IAAM,IAAMJ,EAAUO,EAAIH,EAAS,KAAOJ,EAAUO,EAAIH,EAAS,KAAOJ,EAAUO,EAAIH,EAAS,KAAOJ,EAAUO,EAAIH,EAAS,KAAOJ,EAAUO,EAAIH,EAAS,KAAOJ,EAAUO,EAAIH,EAAS,MAAMI,cAMzf,IAAKC,EAASX,GACZ,MAAMY,UAAU,+BAGlB,OAAOZ,ECNAa,CAAUN,qzDCnBkB,IAEhBO,EAAa,WAEhC,WAAYC,EAAYC,GAAM,iIAkBtB,SAACC,EAAWC,GAClB,OAAO,IAAIJ,EAAc,EAAD,KAAM,EAAKK,YAAeF,GAAS,OAAQ,EAAKD,MAASE,OAClF,mBA0EU,SAAAE,GACT,IAAQC,EAAW,EAAKF,WAAhBE,OAER,GAAIA,EAAOC,SAKT,OAHkB9E,MAAMC,QAAQ4E,EAAOC,UACrCD,EAAOC,SAAW,CAAED,EAAOC,WAEZC,MAAK,SAAApK,GAAC,OAAIA,EAAEiK,OAASA,QArGxClJ,KAAKiJ,WAAaJ,EAClB7I,KAAK8I,KAAOA,UAqHb,SAlHD,2BAkBA,SAAQQ,GACN,MAAoB,gBAAhBA,MAAAA,OAAK,EAALA,EAAOJ,QAEAlJ,KAAKiJ,aAAeK,EAAML,eAEzBjJ,KAAKiJ,WAAWM,KAAOD,EAAML,WAAWM,KAG3CC,GAAAA,CAAOxJ,KAAKiJ,WAAYK,EAAML,eAExC,sBACD,WAAU,MACR,OAAgB,QAAhB,EAAOjJ,KAAK8I,YAAI,aAAT,EAAWW,QACnB,oBACD,WAAe,MACb,OAAgB,QAAhB,EAAOzJ,KAAK8I,YAAI,aAAT,EAAWY,WAMpB,cAEA,WACE,OAAO1J,KAAKiJ,WAAWM,KACxB,gBAED,WACE,OAAOvJ,KAAKiJ,WAAWC,OACxB,sBAED,WACE,OAAOlJ,KAAKiJ,WAAWU,aACxB,gBAED,WACE,OAAO3J,KAAKiJ,WAAWW,OACxB,kBAED,WACE,OAAO5J,KAAKiJ,WAAWE,SAGzB,kBACA,WACE,OAAQ7E,MAAMC,QAAQvE,KAAKiJ,WAAWW,MACpC5J,KAAKiJ,WAAWW,KAAO,CAAE5J,KAAKiJ,WAAWW,OAC5C,IASD,SAAWC,GACT7J,KAAKiJ,WAAWW,KAAOC,IAGzB,sBAXA,SAASC,GACP,IAAK,IAAL,MAA2BlF,OAAOmF,QAAQD,GAAM,eAAC,CAA5C,gBAAO/E,EAAG,KAAEiF,EAAK,KACpBhK,KAAK8I,KAAK/D,GAAOiF,KAEpB,mBAQD,WACE,OAAQ1F,MAAMC,QAAQvE,KAAKiJ,WAAWE,QACpCnJ,KAAKiJ,WAAWE,OAAS,CAAEnJ,KAAKiJ,WAAWE,UAO/C,iBAcA,WACE,OAAOnJ,KAAKoJ,SAAS,qBAAqBa,QAG5C,iBACA,WACE,OAAOjK,KAAKoJ,SAAS,wBAAwBc,QAG/C,eACA,WACE,OAAOlK,KAAKoJ,SAAS,wBAAwBe,6EAC9C,EAzH+B,g2BAyH/B,EAzHkBvB,EAAa,UAQhB,SAAAwB,GACd,IAAMC,EAAO,CACX,WAAY,mCACZ,KAAQ,aACR,GAAM,IAAF,OAAMvC,KACV,KAAQ,IAGV,OAAO,IAAIc,EAAc,EAAD,KAAMyB,GAASD,OCf3C,IAKqBE,EAAS,WAE5B,WAAYnB,EAAQS,GAAM,iIASlB,SAAAb,GAEN,IAAMwB,EAAS,IAAID,EAMnB,OALAC,EAAOtB,WAAauB,KAAKC,MAAMD,KAAK7B,UAAU,EAAKM,aAE/CF,IACFwB,EAAOtB,WAAa,OAAKsB,EAAOtB,YAAeF,IAE1CwB,KACR,mBAiCU,SAAArB,GACT,IAAQC,EAAW,EAAKF,WAAhBE,OAER,GAAIA,EAAOC,SAKT,OAHkB9E,MAAMC,QAAQ4E,EAAOC,UACrCD,EAAOC,SAAW,CAAED,EAAOC,WAEZC,MAAK,SAAApK,GAAC,OAAIA,EAAEiK,OAASA,QAEzC,uBAec,WACb,IAAMrK,EAAI+F,OAAO8F,OAAO,GAAI,EAAKzB,WAAY,CAC3C,WAAY,mCACZ,KAAQ,aACR,GAAM,IAAF,OAAMnB,OAGZ,OAAO,IAAIc,EAAc/J,MAlFzBmB,KAAKiJ,WAAa,CAChBC,KAAM,YACNU,KAAMA,GAAQ,GACdT,OAAAA,WAsEH,SAlED,sBAYA,WACE,OAAOnJ,KAAKiJ,WAAWC,OACxB,gBAED,WACE,OAAOlJ,KAAKiJ,WAAWW,OACxB,kBAED,WACE,OAAO5J,KAAKiJ,WAAWE,SACxB,mBAED,WACE,OAAQ7E,MAAMC,QAAQvE,KAAKiJ,WAAWE,QACpCnJ,KAAKiJ,WAAWE,OAAS,CAAEnJ,KAAKiJ,WAAWE,UAG/C,qBACA,SAAQG,GACN,QAAKA,GAGIE,GAAAA,CAAOxJ,KAAKiJ,WAAYK,EAAML,cAExC,kBAED,WACE,OAAQ3E,MAAMC,QAAQvE,KAAKiJ,WAAWW,MACpC5J,KAAKiJ,WAAWW,KAAO,CAAE5J,KAAKiJ,WAAWW,QAC5C,iBAeD,WACE,OAAO5J,KAAKoJ,SAAS,qBAAqBa,QAK5C,uBAEA,WACE,OAAO,2EACR,EA5E2B,67DCL9B,IAAMU,EAAyB,+BAEzBC,EAAU7E,IAKH8E,EAAQ,8BAEnB,WAAYC,EAAGC,EAAQC,GAAK,gBAClB,IAAR,gBAAQ,oBA8BS,WACbhF,OAAOiF,iBACT,EAAKC,eAAiB,IAAID,gBAAe,WACvC,IAAME,EAAY,EAAKC,IAAIC,wBAC3B,EAA0B,EAAKD,IAAIE,QAAQC,QAAnCC,EAAK,EAALA,MAAO1K,EAAM,EAANA,OAEf,EAAK2K,MAAQtM,KAAKM,IAChB+L,EAAQL,EAAUK,MAClB1K,EAASqK,EAAUrK,QAGjB,EAAK4K,gBACP,EAAKA,eAAe,EAAKD,UAG7B,EAAKP,eAAeS,QAAQ,EAAKP,IAAIQ,gBAExC,sBAEa,SAAAC,GACZ,IAAMC,EAAK,EAAKV,IAAIW,iBAEpB,GAAInB,EAAS,CACX,IAAMoB,EAAO,EAAKZ,IAAIC,wBAEhBvL,EAAI+L,EAAII,QAAUD,EAAKlM,EACvBoM,EAAIL,EAAIM,QAAUH,EAAKE,EAE7B,EAAsB,EAAKd,IAAIC,wBAAvBe,EAAI,EAAJA,KAAMC,EAAG,EAAHA,IAId,OAHAP,EAAGhM,EAAIA,EAAIsM,EACXN,EAAGI,EAAIA,EAAIG,EAEJP,EAAGQ,gBAAgB,EAAKxB,EAAEyB,eAAeC,WAKhD,OAHAV,EAAGhM,EAAI+L,EAAIY,QACXX,EAAGI,EAAIL,EAAIa,QAEJZ,EAAGQ,gBAAgB,EAAKxB,EAAE6B,SAASH,cAE7C,qBAMY,SAAC1M,EAAGoM,GACf,IAAMU,EAAiBC,SAASC,gBAAgB1G,EAAe,KAC/DwG,EAAe7F,aAAa,QAAS,cAErC,IAAMgG,EAAQF,SAASC,gBAAgB1G,EAAe,KAEhD4G,EAAa,SAAArO,GACjB,IAAMkC,EAAIgM,SAASC,gBAAgB1G,EAAe,UAIlD,OAHAvF,EAAEkG,aAAa,KAAMjH,GACrBe,EAAEkG,aAAa,KAAMmF,GACrBrL,EAAEkG,aAAa,IAAKpI,GACbkC,GAGHoM,EAAS,EAAKlC,OAAOmC,cAAgB,EAErCC,EAAQH,EAAWC,GACzBE,EAAMpG,aAAa,QAAS,oBAE5B,IAAMqG,EAAQJ,EAAWC,EAAS,GAOlC,OANAG,EAAMrG,aAAa,QAAS,oBAE5BgG,EAAMM,YAAYD,GAClBL,EAAMM,YAAYF,GAElBP,EAAeS,YAAYN,GACpBH,KACR,sBAEa,SAACU,EAAQxN,EAAGoM,GACxB,IAAMiB,EAAQG,EAAOC,cAAc,qBACnCJ,EAAMpG,aAAa,KAAMjH,GACzBqN,EAAMpG,aAAa,KAAMmF,GAEzB,IAAMkB,EAAQE,EAAOC,cAAc,qBACnCH,EAAMrG,aAAa,KAAMjH,GACzBsN,EAAMrG,aAAa,KAAMmF,MAC1B,sBAEa,SAAAoB,GACZ,IAAMF,EAAQE,EAAOC,cAAc,qBACnC,MAAO,CACLzN,EAAG0N,WAAWJ,EAAM5G,aAAa,OACjC0F,EAAGsB,WAAWJ,EAAM5G,aAAa,WAEpC,sBAEa,SAAA8G,GACZ,IAAMH,EAAQG,EAAOC,cAAc,qBAC7BH,EAAQE,EAAOC,cAAc,qBAE7BN,EAAS,EAAKxB,OAAS,EAAKV,OAAOmC,cAAgB,GACzDC,EAAMpG,aAAa,IAAKkG,GACxBG,EAAMrG,aAAa,IAAKkG,MA/HxB,EAAKQ,cAAgB,GACrB,EAAKrC,IAAMN,EAAE4C,QAAQ,OAErB,EAAK5C,EAAIA,EACT,EAAKC,OAASA,EACd,EAAKC,IAAMA,EAGX,EAAKS,MAAQ,EAKb,IAAQkC,EAAU3C,EAAV2C,MAEkB,OADtBA,aAAiBC,SAAWD,aAAiBE,eAC/C,EAAKC,mBAAmB,EAY3B,OATD,0BAIA,WACM9N,KAAKkL,gBACPlL,KAAKkL,eAAe6C,aAEtB/N,KAAKkL,eAAiB,SACvB,EA/BkB,CAAS8C,KA2ITC,EAAI,8BAEvB,WAAYnD,EAAGC,EAAQC,GAAK,MAML,OANK,UACJ,IAAtB,cAAMF,EAAGC,EAAQC,IAAK,mBAUN,YAAsC,IAAnCkD,EAAS,EAATA,UAAWC,EAAO,EAAPA,QAASC,EAAQ,EAARA,SAEnCF,IACF,EAAKA,UAAY,SAAArC,GACf,MAAkB,EAAKwC,YAAYxC,GAA3B/L,EAAC,EAADA,EAAIoM,EAAC,EAADA,EAEP,EAAKoC,UACR,EAAK3K,KAAK,iBAAkB,CAAE7D,EAAAA,EAAGoM,EAAAA,IACjC,EAAKoC,SAAU,GAGjBJ,EAAUpO,EAAGoM,EAAGL,IAIlB,EAAKT,IAAImD,iBAAiB,YAAa,EAAKL,YAG1CC,IACF,EAAKA,QAAU,SAAAtC,GACb,GAAmB,IAAfA,EAAI2C,OAAR,CACA,MAAkB,EAAKH,YAAYxC,GAA3B/L,EAAC,EAADA,EAAIoM,EAAC,EAADA,EACZiC,EAAQrO,EAAGoM,EAAGL,KAIhBgB,SAAS0B,iBAAiB,UAAW,EAAKJ,UAGxCC,IACF,EAAKA,SAAW,SAAAvC,GACd,MAAkB,EAAKwC,YAAYxC,GAA3B/L,EAAC,EAADA,EAAIoM,EAAC,EAADA,EACZkC,EAAStO,EAAGoM,EAAGL,IAGjBgB,SAAS0B,iBAAiB,WAAY,EAAKH,cAG9C,0BAEiB,WACZ,EAAKF,WACP,EAAK9C,IAAIqD,oBAAoB,YAAa,EAAKP,WAE7C,EAAKC,SACPtB,SAAS4B,oBAAoB,UAAW,EAAKN,SAE3C,EAAKC,UACPvB,SAAS4B,oBAAoB,WAAY,EAAKL,aACjD,gBAMO,SAACvC,EAAK6C,EAAoBC,GAEhC,MAAkB,EAAKN,YAAYxC,GAA3B/L,EAAC,EAADA,EAAIoM,EAAC,EAADA,EACZ,EAAK0C,aAAa9O,EAAGoM,EAAGwC,EAAoB7C,EAAK8C,MAClD,uBAUc,SAAA9C,GACb,MAAM,IAAIhE,MAAM8C,MACjB,8BAEqB,SAAC9B,EAAYgG,GACjC,MAAM,IAAIhH,MAAM8C,MAnFhB,EAAK8C,cAAgB,GAIrB,EAAKa,SAAU,EAAM,EAwEtB,OAvEA,mCACD,SAAiBb,GACfzN,KAAKyN,cAAgBA,IACtB,qBAkED,WACE,MAAM,IAAI5F,MAAM8C,OACjB,EAhFsB,CAASE,67BAgGlCoD,EAAKa,SAAW,SAAAjG,GACd,MAAM,IAAIhB,MAAM8C,ICrPlB,IAAMA,EAAyB,+BAEVoE,GAAa,0sBAEhC,WAAYlG,EAAYiC,EAAGC,EAAQC,GAAK,YAGT,mGAHS,WA6B1B,SAAAnC,GACZ,MAAM,IAAIhB,MAAM8C,OA7BM,qBAAtB,cAAMG,EAAGC,EAAQC,2FAEjB,EAAKnC,WAAaA,EAAW,EAY/B,SATA,yBAKA,WACE,MAAM,IAAIhB,MAAM8C,4EAGlB,EAjBgC,CAASE,8GCGpC,IAAMmE,GAAoB,SAACnG,EAAY8E,GAC5C,IAAMvE,EAAWP,EAAWO,SAAS,oBAErC,GAAIA,MAAAA,GAAAA,EAAU6F,WAAWC,WAAW,oCAAqC,CACvE,IAAQlF,EAAUZ,EAAVY,MAEFmF,EAASnF,EAAMoF,SAAS,KAAOpF,EAAMqF,UAAUrF,EAAM3J,QAAQ,KAAO,EAAG2J,EAAM3J,QAAQ,MAAQ,QAG7C,w1BAFvC2J,EAAMoF,SAAS,KAAOpF,EAAMqF,UAAUrF,EAAM3J,QAAQ,KAAO,GAAK2J,EAAMqF,UAAUrF,EAAM3J,QAAQ,KAAO,IAExFqG,MAAM,KAAK4I,IAAI9B,YAAW,GAAhD1N,EAAC,KAAEoM,EAAC,KAAEqD,EAAC,KAAEzQ,EAAC,KAShB,MAP6B,YAAzBqQ,EAAO3G,gBACT1I,EAAIA,EAAI6N,EAAM6B,aAAgB,IAC9BtD,EAAIA,EAAIyB,EAAM8B,cAAgB,IAC9BF,EAAIA,EAAI5B,EAAM6B,aAAgB,IAC9B1Q,EAAIA,EAAI6O,EAAM8B,cAAgB,KAGzB,CAAE3P,EAAAA,EAAGoM,EAAAA,EAAGqD,EAAAA,EAAGzQ,EAAAA,ksBCvBf,IAGM4Q,GAAa,SAAC5P,EAAGoM,EAAGyB,EAAOgC,GAAY,gBDyDtB,SAAC7P,EAAGoM,EAAGqD,EAAGzQ,EAAG6O,EAAOgC,GAAY,MAC5B,aAAhCA,MAAAA,OAAY,EAAZA,EAAcnH,eAjBc,SAAC1I,EAAGoM,EAAGqD,EAAGzQ,EAAG6O,GACzC,IAAMiC,EAAK9P,EAAI6N,EAAM6B,aAAgB,IAC/BK,EAAK3D,EAAIyB,EAAM8B,cAAgB,IAC/BK,EAewBP,EAff5B,EAAM6B,aAAgB,IAC/BO,EAc2BjR,EAdlB6O,EAAM8B,cAAgB,IAErC,MAAO,CACLhL,OAAQkJ,EAAMqC,IACd5G,SAAU,CACRF,KAAM,mBACN+F,WAAY,oCACZjF,MAAO,gBAAF,OAAkB4F,EAAE,YAAIC,EAAE,YAAIC,EAAE,YAAIC,KAO3CE,CAAsBnQ,EAAGoM,EC1DH,EAAG,ED0DSyB,GA/BV,SAAC7N,EAAGoM,EAAGqD,EAAGzQ,EAAG6O,GAAK,MAAM,CAClDlJ,OAAQkJ,MAAAA,OAAK,EAALA,EAAOqC,IACf5G,SAAU,CACRF,KAAM,mBACN+F,WAAY,oCACZjF,MAAO,cAAF,OAAgBlK,EAAC,YAAIoM,EAAC,YA2BDqD,EA3BM,YA2BHzQ,KAA7BoR,CAAoBpQ,EAAGoM,EC3DD,EAAG,ED2DOyB,GC3D/BwC,CAAerQ,EAAGoM,EAAG,EAAG,EAAGyB,EAAOgC,IAAa,IAClDS,YAAa,CACXlN,KAAM,i6CCL2B,IAEhBmN,GAAa,8sBAEhC,WAAYxH,EAAYiC,EAAGC,EAAQC,GAAK,4GACJ,MAAlC,cAAMnC,EAAYiC,EAAGC,EAAQC,IAAK,kBAwBnB,kBACf,EAAKsF,YAAY,EAAKC,UAAM,mBAMrB,WACP,EAAKC,WAAY,KAClB,wBAEa,SAAA3E,GACZ,GAAmB,IAAfA,EAAI2C,QAEJ,EAAKgC,UAAW,CAClB,MAAe,EAAKnC,YAAYxC,GAAzB/L,EAAC,EAADA,EAAGoM,EAAC,EAADA,EAEV,EAAKuE,YAAY,EAAKF,MAAOzQ,EAAGoM,GAEhC,IAAM/C,EAASuG,GAAW5P,EAAGoM,EAAG,EAAKlB,IAAI2C,MAAO,EAAK5C,OAAO4E,cAC5D,EAAKhM,KAAK,SAAUwF,OAEvB,sBAEW,WACV,EAAKqH,WAAY,KAClB,wBAEa,SAAA3H,GACZ,MAAiBmG,GAAkBnG,EAAY,EAAKmC,IAAI2C,OAAhD7N,EAAC,EAADA,EAAGoM,EAAC,EAADA,EACX,EAAKuE,YAAY,EAAKF,MAAOzQ,EAAGoM,MApDhC,EAAKd,IAAImD,iBAAiB,YAAa,EAAKmC,aAC5C,EAAKtF,IAAImD,iBAAiB,UAAW,EAAKoC,WAE1C,MAAiB3B,GAAkBnG,EAAYmC,EAAI2C,OAA3C7N,EAAC,EAADA,EAAGoM,EAAC,EAADA,EAgBY,OAdvB,EAAK0E,UAAY/D,SAASC,gBAAgB1G,EAAe,KAEzD,EAAKyK,aAAehE,SAASC,gBAAgB1G,EAAe,KAC5D,EAAKyK,aAAa9J,aAAa,QAAS,oCAExC,EAAKwJ,MAAQ,EAAKO,WAAWhR,EAAGoM,GAChC,EAAKqE,MAAMhC,iBAAiB,YAAa,EAAKwC,QAE9C,EAAKF,aAAaxD,YAAY,EAAKkD,OAEnC,EAAKK,UAAUvD,YAAY,EAAKwD,cAChC/F,EAAEuC,YAAY,EAAKuD,WAGnB,EAAKJ,WAAY,EAAM,EA0CxB,SAzCA,yBAKD,WACE,OAAOxQ,KAAK6Q,eACb,qBA4BD,WACE7Q,KAAKoL,IAAIqD,oBAAoB,YAAazO,KAAK0Q,aAC/C1Q,KAAKoL,IAAIqD,oBAAoB,UAAWzO,KAAK2Q,WAE7C3Q,KAAK4Q,UAAUhF,WAAWoF,YAAYhR,KAAK4Q,WAC3C,wHACD,EAlE+B,CAAS7B,qkCCHG,IAEzBkC,GAAS,8sBAE5B,WAAYnG,EAAGC,EAAQC,GAAK,MAoCkC,mGApClC,SACJ,MAAtB,cAAMF,EAAGC,EAAQC,IAAK,gBAGT,SAAClL,EAAGoM,EAAGxI,EAAGmI,GAAQ,MAEzBhD,EAAkD,QAAxC,EAAGgD,EAAI1C,OAAOuE,QAAQ,0BAAkB,aAArC,EAAuC7E,WAK1D,GAAKA,GFfc,SAAAA,GAAU,YACS,WAAX,QAA7B,EAAAA,EAAWM,OAAOiH,mBAAW,aAA7B,EAA+BlN,MEcTgO,CAAQrI,GAU1B,EAAKlF,KAAK,cAV6B,CACvC,IAAMwN,EAAU,EAAKL,WAAWhR,EAAGoM,GACnC,EAAKoE,YAAYa,GAEjB,EAAKrG,EAAEuC,YAAY8D,GAEnBA,EAAQtI,WAAa,IAAIyB,EAAUoF,GAAW5P,EAAGoM,EAAG,EAAKlB,IAAI2C,MAAO,EAAK5C,OAAO4E,eAEhF,EAAKhM,KAAK,WAAYwN,OAIzB,iBAEM,eAEN,gCAQqB,SAAAtI,GAAU,OAC9B,IAAIwH,GAAcxH,EAAY,EAAKiC,EAAG,EAAKC,OAAQ,EAAKC,QAAI,EAH7D,SA/BA,2BA2BD,WAGE,OAAO,4EACR,EAnC2B,CAASiD,GA0CvCgD,GAAUG,WAAa,QAEvBH,GAAUnC,SAAW,SAAAjG,GAEnB,OAAO,GC/CT,IAaMwI,GAAW,SAAAC,GAGf,IAAMC,EAAU,SAAAjL,GACdhC,MAAM0C,KAAKV,EAAGkL,YAAYC,SAAQ,SAAAlL,GAC5BA,EAAKrD,KAAKgM,WAAW,OACvB5I,EAAGc,gBAAgBb,EAAKrD,UAKxBwO,EAAUJ,EAAIK,qBAAqB,UAQzC,OAPArN,MAAM0C,KAAK0K,GAASE,UAAUH,SAAQ,SAAAnL,GAAE,OACtCA,EAAGsF,WAAWoF,YAAY1K,MAG5BiL,EAAQD,GACRhN,MAAM0C,KAAKsK,EAAIO,iBAAiB,MAAMJ,QAAQF,GAEvCD,GAGIQ,GAAqB,SAAAjJ,GAChC,IApCyBkJ,EAMnBC,EA8BA5I,EAAWP,EAAWO,SAAS,eACrC,GAAIA,EAAU,CACZ,IAAM6I,EAAS,IAAIC,UAGXlI,EAAUZ,EAAVY,MACFsH,EAAMW,EAAOE,gBAAgBnI,EAAO,iBAGpCoI,EAAmBd,EAAIe,aAAajM,GACpCkM,EAAwBhB,EAAIiB,mBAAmB,MAErD,OAAIH,GAAoBE,EACfjB,GAASC,GAAKkB,WAEdnB,IAnDcU,EAmDcT,EA7CjCU,GAJa,IAAIS,eACAC,kBAAkBX,EAAYY,iBAG9BC,QAAQ,QAAS,eAAF,OAAiBxM,EAAa,QAErD,IAAI8L,WACUC,gBAAgBH,EAAY,iBACpCW,kBAyCwBH,aAKlCK,GAAkB,SAAAhK,GAC7B,IAAMiK,EAAQhB,GAAmBjJ,GAI3BiC,EAAI+B,SAASC,gBAAgB1G,EAAe,KAE5C+G,EAAQ2F,EAAMC,WAAU,GAC9B5F,EAAMpG,aAAa,QAAS,aAE5B,IAAMqG,EAAQ0F,EAAMC,WAAU,GAM9B,OALA3F,EAAMrG,aAAa,QAAS,aAE5B+D,EAAEuC,YAAYD,GACdtC,EAAEuC,YAAYF,GAEPrC,GAGIkI,GAAc,SAACF,EAAOnF,GACjC,IAAMR,EAAQ2F,EAAMvF,cAAc,cAAcwF,WAAU,GAC1D5F,EAAM/F,gBAAgB,SACtB+F,EAAM/F,gBAAgB,SAEtB,IAAI6L,EAAa9F,EAAM+F,YAAa,IAAIT,eAAgBC,kBAAkBvF,GAG1E,OAFA8F,EAAaA,EAAWL,QAAQ,WAAD,OAAYxM,EAAa,KAAK,IAEtD,CACL3B,OAAQkJ,MAAAA,OAAK,EAALA,EAAOqC,IACf5G,SAAU,CACRF,KAAM,cACNc,MAAO,QAAF,OAAUiJ,EAAU,aCvFzBE,GAAS,SAACL,EAAOhT,EAAGoM,EAAGvN,GAC3BmU,EAAM/L,aAAa,KAAMjH,GACzBgT,EAAM/L,aAAa,KAAMmF,GACzB4G,EAAM/L,aAAa,IAAKpI,IAwBbyU,GAAgB,SAACtI,EAAGuI,EAAIC,EAAI3U,GACvC,IAAM4U,EAAczI,EAAEyC,cAAc,cAC9BiG,EAAc1I,EAAEyC,cAAc,cAEpC4F,GAAOI,EAAaF,EAAIC,EAAI3U,GAC5BwU,GAAOK,EAAaH,EAAIC,EAAI3U,IAGjB8U,GAAgB,SAAA3I,GAC3B,IAAM0I,EAAc1I,EAAEyC,cAAc,cAMpC,MAAO,CAAE8F,GAJE7F,WAAWgG,EAAYhN,aAAa,OAIlC8M,GAHF9F,WAAWgG,EAAYhN,aAAa,OAG9B7H,EAFP6O,WAAWgG,EAAYhN,aAAa,wSC1CP,IAEpBkN,GAAU,WAE7B,WAAYC,EAAiBC,GAAQ,mIAiB5B,WACP,MAAsBH,GAAc,EAAKG,QAAjCP,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GAAI3U,EAAC,EAADA,EAEVkV,EAAOR,EAAK1U,EAAK,EAAK4Q,EAAK,EAAKA,EAAI5Q,EAAI0U,EACxCS,EAAOR,EAAK3U,EAAK,EAAKG,EAAK,EAAKA,EAAIH,EAAI2U,EAAK3U,EAEnD,EAAKoV,KAAKhN,aAAa,IAAK,SAAF,OAAW,EAAKwI,EAAC,aAAK,EAAKzQ,EAAC,cAAM,EAAKyQ,EAAC,eAAOsE,EAAE,YAAIC,EAAE,cAAMnV,EAAC,YAAIA,EAAC,kBAC9F,mBAMS,kBACR,EAAKoV,KAAKnI,WAAWoF,YAAY,EAAK+C,SA9BtC/T,KAAKuP,EAAIoE,EAAgBnE,aACzBxP,KAAKlB,EAAI6U,EAAgBlE,cAEzBzP,KAAK4T,OAASA,EAEd,MAAsBH,GAAczT,KAAK4T,QAAjCP,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GAAI3U,EAAC,EAADA,EACVkV,EAAOR,EAAK1U,EAAKqB,KAAKuP,EAAKvP,KAAKuP,EAAI5Q,EAAI0U,EACxCS,EAAOR,EAAK3U,EAAKqB,KAAKlB,EAAKkB,KAAKlB,EAAIH,EAAI2U,EAAK3U,EAEnDqB,KAAK+T,KAAOlH,SAASC,gBAAgB1G,EAAe,QACpDpG,KAAK+T,KAAKhN,aAAa,YAAa,WACpC/G,KAAK+T,KAAKhN,aAAa,QAAS,sBAEhC/G,KAAK+T,KAAKhN,aAAa,IAAK,SAAF,OAAW/G,KAAKuP,EAAC,aAAKvP,KAAKlB,EAAC,cAAMkB,KAAKuP,EAAC,eAAOsE,EAAE,YAAIC,EAAE,cAAMnV,EAAC,YAAIA,EAAC,uBAc9F,SAbA,yBAWD,WACE,OAAOqB,KAAK+T,+EACb,EA9B4B,mSCG/B,IAIqBC,GAAgB,WAEnC,WAAYC,EAASC,EAASpJ,EAAGE,GAAK,mIA+B7B,SAACmJ,EAAWC,GACnB,MAAwC,EAAKpJ,IAAI2C,MAAzC6B,EAAY,EAAZA,aAAcC,EAAa,EAAbA,cAGtB,EAAK1C,MAAMtD,MAAM4K,QAAU,KAE3B,IAAM9E,EAAI4E,EAAY,EAAKG,OAAO,GAC5BxV,EAAIsV,EAAY,EAAKE,OAAO,GAC5B3V,EAAIQ,KAAKM,IAAI,EAAGN,KAAKmD,IAAI,SAAAiN,EAAK,GAAC,SAAGzQ,EAAK,GAAG,IAAO,GAEjDuU,EAAK,EAAKiB,OAAO,GAAK/E,EAAI,EAC1B+D,EAAK,EAAKgB,OAAO,GAAKxV,EAAI,EAE3BuU,EAAG1U,EAAI,GAAK0U,EAAK1U,EAAI6Q,GAAkB8D,EAAG3U,EAAI,GAAK2U,EAAK3U,EAAI8Q,IAEjE2D,GAAc,EAAKQ,OAAQP,EAAIC,EAAI3U,GACnC,EAAKoV,KAAKQ,aACX,iCAEuB,kBACtB,EAAKX,OAAOvI,2BAAuB,uBAEvB,WACZ,OAAO,IAAIf,EAAU0I,GAAY,EAAKjG,MAAO,EAAK/B,IAAI2C,WACvD,mBAES,WACR,EAAKZ,MAAMnB,WAAWoF,YAAY,EAAKjE,OAEvC,EAAKgH,KAAO,KACZ,EAAKH,OAAS,KACd,EAAK7G,MAAQ,QA7Db/M,KAAKsU,OAAS,CAAEL,EAASC,GAEzBlU,KAAKgL,IAAMA,EAEXhL,KAAK+M,MAAQF,SAASC,gBAAgB1G,EAAe,KAErDpG,KAAK4T,OFNiB,SAACP,EAAIC,EAAI3U,GACjC,IAAMmM,EAAI+B,SAASC,gBAAgB1G,EAAe,KAC5CoN,EAAe3G,SAASC,gBAAgB1G,EAAe,UACvDmN,EAAe1G,SAASC,gBAAgB1G,EAAe,UAW7D,OATAmN,EAAYxM,aAAa,QAAS,aAClCoM,GAAOI,EAAaF,EAAIC,EEAqB,GFE7CE,EAAYzM,aAAa,QAAS,aAClCoM,GAAOK,EAAaH,EAAIC,EEHqB,GFK7CxI,EAAEuC,YAAYmG,GACd1I,EAAEuC,YAAYkG,GAEPzI,EERSkC,CAAWiH,EAASC,GAClClU,KAAK4T,OAAO7M,aAAa,QAAS,iBAElC/G,KAAK+T,KAAO,IAAIS,GAAKxJ,EAAI2C,MAAO3N,KAAK4T,QAKrC5T,KAAK+M,MAAMtD,MAAMgL,cAAgB,OAIjCzU,KAAK+M,MAAMtD,MAAM4K,QAAU,OAE3BrU,KAAK+M,MAAMM,YAAYrN,KAAK+T,KAAK5C,SACjCnR,KAAK+M,MAAMM,YAAYrN,KAAK4T,QAE5B9I,EAAEuC,YAAYrN,KAAK+M,eAKpB,SAJA,yBAED,WACE,OAAO/M,KAAK4T,iFACb,EA/BkC,wvBCRrC,IAAMc,GAAY,WAAWC,KAAK1O,UAAU2O,WAEtCC,GAAc,SAACC,EAAOhV,EAAGoM,EAAGqD,EAAGzQ,GACnCgW,EAAM/N,aAAa,QAASwI,GAC5BuF,EAAM/N,aAAa,SAAUjI,GAGzB4V,IACFI,EAAM/N,aAAa,IAAK,GACxB+N,EAAM/N,aAAa,IAAK,GACxB+N,EAAM/N,aAAa,YAAa,aAAF,OAAejH,EAAC,aAAKoM,EAAC,QAEpD4I,EAAM/N,aAAa,IAAKjH,GACxBgV,EAAM/N,aAAa,IAAKmF,KAiDfiD,GAAS,SAAC2D,EAAOjK,EAAYgG,GAExC,IAAKA,EACH,OAAOiE,EAGT,IAAM3D,EAASN,EAAWkG,QAAO,SAACC,EAAQ3R,GACxC,IAAM8L,EAAS9L,EAAGwF,GAElB,IAAKsG,EACH,OAAO6F,EAET,GAAsB,iBAAX7F,GAAuBA,aAAkB8F,OAClDD,EAAOpO,UAAYoO,EAAOpO,UAAY,GAAH,OAAMoO,EAAOpO,UAAS,YAAIuI,GAAWA,OACnE,GAAIA,EAAO+F,WAAaC,KAAKC,aAClCJ,EAAOK,SAAWL,EAAOK,SAAW,GAAH,UAAOL,EAAOK,UAAQ,CAAElG,IAAU,CAACA,OAC/D,CACL,IAAQvI,EAA8BuI,EAA9BvI,UAAW6C,EAAmB0F,EAAnB1F,MAAO0H,EAAYhC,EAAZgC,QAEtBvK,IACFoO,EAAOpO,UAAYoO,EAAOpO,UAAY,GAAH,OAAMoO,EAAOpO,UAAS,YAAIA,GAAcA,GAEzE6C,IACFuL,EAAOvL,MAAQuL,EAAOvL,MAAQ,GAAH,OAAMuL,EAAOvL,MAAK,YAAIA,GAAUA,GAEzD0H,IACF6D,EAAOK,SAAWL,EAAOK,SAAW,GAAH,UAAOL,EAAOK,UAAQ,CAAElE,IAAW,CAACA,IAIzE,IAAK,IAAMpM,KAAOoK,EACZA,EAAOrK,eAAeC,IAAQA,EAAImK,WAAW,WAC/C8F,EAAOjQ,GAAOoK,EAAOpK,IAIzB,OAAOiQ,IACN,IAEKpO,EAA+BuI,EAA/BvI,UAAW6C,EAAoB0F,EAApB1F,MAAO4L,EAAalG,EAAbkG,SAK1B,GAHIzO,GACFD,EAASmM,EAAOlM,GAEd6C,EAAO,CACT,IAAM2D,EAAQ0F,EAAMvF,cAAc,cAC5BJ,EAAQ2F,EAAMvF,cAAc,cAE9BH,GAASD,GACXC,EAAMrG,aAAa,QAAS,gBAC5BoG,EAAMpG,aAAa,QAAS0C,IAE5BqJ,EAAM/L,aAAa,QAAS0C,GAOhC,IAAK,IAAM1E,KAHPsQ,GACFA,EAAS5D,SAAQ,SAAAnL,GAAE,OAtGG,SAACgP,EAAaxC,GACtC,MAAgCA,EAAMyC,UAA9BzV,EAAC,EAADA,EAAGoM,EAAC,EAADA,EAAGV,EAAK,EAALA,MAAO1K,EAAM,EAANA,OAEfgU,EAAQjI,SAASC,gBAAgB1G,EAAe,OACtD0O,EAAM/N,aAAa,QAAS,oBAE5B8N,GAAYC,EAAOhV,EAAGoM,EAAGV,EAAO1K,GAEhC,IAAMgK,EAAI+B,SAASC,gBAAgB1G,EAAe,KAClD0E,EAAEuC,YAAYiI,GAEdR,EAAMzH,YAAYvC,GAElBgI,EAAM0C,OAAOV,GAyFYW,CAAkBnP,EAAIwM,MAE7B3D,EACZA,EAAOrK,eAAeC,IAAQA,EAAImK,WAAW,UAC/C4D,EAAM/L,aAAahC,EAAKoK,EAAOpK,KAKxB2Q,GAAqB,SAAC3I,EAAOjN,EAAGoM,EAAGqD,EAAGzQ,GACjD,IAAMwW,EAAcvI,EAAMQ,cAAc,qBACpC+H,GACFT,GAAYS,EAAaxV,EAAGoM,EAAGqD,EAAGzQ,21EC9HtC,IAGqB6W,GAAc,8sBAEjC,WAAY9M,EAAYiC,EAAGC,EAAQC,GAAK,4GACJ,MAAlC,cAAMnC,EAAYiC,EAAGC,EAAQC,IAAK,WAgE1B,SAACqI,EAAIC,EAAI3U,GACjByU,GAAc,EAAKQ,OAAQP,EAAIC,EAAI3U,GACnC,EAAKoV,KAAKQ,SACVmB,GAAmB,EAAK7E,aAAcwC,EAAIC,EAAI3U,EAAGA,GAEjD,SAAsD,EAAKiX,QAAO,GAA1DC,EAAO,KAAEC,EAAQ,KAAEC,EAAW,KAAEC,EAAU,KAClD,EAAKvF,YAAYoF,EAASxC,EAAIC,EAAK3U,GACnC,EAAK8R,YAAYqF,EAAUzC,EAAK1U,EAAG2U,GACnC,EAAK7C,YAAYsF,EAAa1C,EAAIC,EAAK3U,GACvC,EAAK8R,YAAYuF,EAAY3C,EAAK1U,EAAG2U,MACtC,2BAEgB,SAAC2C,EAAkBC,EAAcC,GAChD,IAMIxX,EANE2V,EAAS,EAAK8B,YAAYF,GAE5BG,EAASF,EAASrW,EAClBwW,EAASH,EAASjK,EAClBV,EAAQ,EACR1K,EAAS,EAEW,GAApBmV,GAA6C,GAApBA,GAC3BI,EAAS/B,EAAOxU,EAChBgB,EAASwV,EAAShC,EAAOpI,EACzBvN,EAAIQ,KAAKoX,IAAIzV,GAAU,IAEvBwV,EAAShC,EAAOpI,EAChBV,EAAQ6K,EAAS/B,EAAOxU,EACxBnB,EAAIQ,KAAKoX,IAAI/K,GAAS,GAGxB,IAAM1L,EAAI0L,EAAQ,EAAI8I,EAAOxU,EAAIuW,EAC3BnK,EAAIpL,EAAS,EAAIwT,EAAOpI,EAAIoK,EAG5BjD,EAAKvT,EAFDX,KAAKoX,IAAI/K,GAEF,EACX8H,EAAKpH,EAFD/M,KAAKoX,IAAIzV,GAEF,EAMjB,GAJAsS,GAAc,EAAKQ,OAAQP,EAAIC,EAAI3U,GACnC,EAAKoV,KAAKQ,SACVmB,GAAmB,EAAK7E,aAAcwC,EAAIC,EAAI3U,EAAGA,GAEzB,GAApBsX,GAA6C,GAApBA,EAAuB,CAClD,IAAIO,EAAO,EACPC,EAAO,GACY,GAApBR,GAAyBnV,EAAS,GAAyB,GAApBmV,GAAyBnV,EAAS,KAC1E0V,EAAO,EACPC,EAAO,GAET,EAAKhG,YAAY,EAAKmF,QAAQY,GAAOnD,EAAIC,EAAK3U,GAC9C,EAAK8R,YAAY,EAAKmF,QAAQa,GAAOpD,EAAIC,EAAK3U,GAC9C,EAAK8R,YAAY,EAAKmF,QAAQ,GAAIvC,EAAK1U,EAAG2U,GAC1C,EAAK7C,YAAY,EAAKmF,QAAQ,GAAIvC,EAAK1U,EAAG2U,OACrC,CACL,IAAIoD,EAAO,EACPC,EAAO,GACa,GAApBV,GAAyBzK,EAAQ,GAAyB,GAApByK,GAAyBzK,EAAQ,KACzEkL,EAAO,EACPC,EAAO,GAET,EAAKlG,YAAY,EAAKmF,QAAQc,GAAOrD,EAAK1U,EAAG2U,GAC7C,EAAK7C,YAAY,EAAKmF,QAAQe,GAAOtD,EAAK1U,EAAG2U,GAC7C,EAAK7C,YAAY,EAAKmF,QAAQ,GAAIvC,EAAIC,EAAK3U,GAC3C,EAAK8R,YAAY,EAAKmF,QAAQ,GAAIvC,EAAIC,EAAK3U,OAE9C,mBAEQ,SAAAiY,GAAW,OAAI,SAAA/K,GACtB,EAAK+K,YAAcA,EAEnB,IAAMC,EAAM,EAAKxI,YAAYxC,GAC7B,EAAmB4H,GAAc,EAAKG,QAA9BP,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GAEZ,EAAKwD,UAAY,CAAEhX,EAAG+W,EAAI/W,EAAIuT,EAAInH,EAAG2K,EAAI3K,EAAIoH,OAC9C,wBAEa,SAAAzH,GACZ,IAAMkL,EAAY,SAACC,EAAOvX,GAAG,OAC3BuX,EAAQ,EAAI,EAAMA,EAAQvX,EAAMA,EAAMuX,GAExC,GAAI,EAAKJ,YAAa,CACpB,IAAMC,EAAM,EAAKxI,YAAYxC,GAE7B,GAAI,EAAK+K,cAAgB,EAAKhD,OAAQ,CACpC,IAAQjV,EAAM8U,GAAc,EAAKG,QAAzBjV,EAER,EAAwC,EAAKqM,IAAI2C,MAAzC6B,EAAY,EAAZA,aAAcC,EAAa,EAAbA,cAEhB4D,EAAKlU,KAAKM,IAAIsX,EAAUF,EAAI/W,EAAI,EAAKgX,UAAUhX,EAAG0P,EAAe7Q,GAAIA,GACrE2U,EAAKnU,KAAKM,IAAIsX,EAAUF,EAAI3K,EAAI,EAAK4K,UAAU5K,EAAGuD,EAAgB9Q,GAAIA,GAE5E,EAAKsY,QAAQ5D,EAAIC,EAAI3U,GACrB,EAAKgF,KAAK,SAAUqP,GAAY,EAAKY,OAAQ,EAAK5I,IAAI2C,YACjD,CAGL,IAAMuJ,EAAY,EAAKtB,QAAQvV,QAAQ,EAAKuW,aACtCO,EAAiBD,EAAY,EACjC,EAAKtB,QAAQsB,EAAY,GAAK,EAAKtB,QAAQsB,EAAY,GAEzD,EAAKE,eAAeF,EAAWC,EAAgBN,GAC/C,EAAKlT,KAAK,SAAUqP,GAAY,EAAKY,OAAQ,EAAK5I,IAAI2C,aAG3D,sBAEW,WACV,EAAKiJ,YAAc,KACnB,EAAKE,UAAY,QAClB,wBAMa,SAAAjO,GACZ,IAAMiK,EAAQhB,GAAmBjJ,GAE3BwK,EAAK7F,WAAWsF,EAAMtM,aAAa,OACnC8M,EAAK9F,WAAWsF,EAAMtM,aAAa,OACnC7H,EAAK6O,WAAWsF,EAAMtM,aAAa,MAEzC,EAAKyQ,QAAQ5D,EAAIC,EAAI3U,MAvLrB,EAAKyM,IAAImD,iBAAiB,YAAa,EAAKmC,aAC5C,EAAKtF,IAAImD,iBAAiB,UAAW,EAAKoC,WAiB1C,EAAK/D,eAAiBC,SAASC,gBAAgB1G,EAAe,KAE9D,EAAKwN,OAASf,GAAgBhK,GAC9B,EAAK+K,OAAOrG,cAAc,cACvBgB,iBAAiB,YAAa,EAAKwC,OAAO,EAAK6C,SAElD,EAAKG,KAAO,IAAIS,GAAKxJ,EAAI2C,MAAO,EAAKiG,QAErC,EAAKhH,eAAeS,YAAY,EAAK0G,KAAK5C,SAG1C,EAAKN,aAAehE,SAASC,gBAAgB1G,EAAe,KAC5D,EAAKyK,aAAa9J,aAAa,QAAS,oCACxC,EAAK8J,aAAaxD,YAAY,EAAKuG,QAEnC,MAAsBH,GAAc,EAAKG,QAAjCP,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GAAI3U,EAAC,EAADA,EA0BM,OAxBtB,EAAKiX,QAAU,CACb,CAAEvC,EAAIC,EAAK3U,GACX,CAAE0U,EAAK1U,EAAG2U,GACV,CAAED,EAAIC,EAAK3U,GACX,CAAE0U,EAAK1U,EAAG2U,IACVhE,KAAI,SAAA5Q,GACJ,SAAiBA,EAAC,GAAVoB,EAAC,KAAEoM,EAAC,KACNoB,EAAS,EAAKwD,WAAWhR,EAAGoM,GAKlC,OAHAoB,EAAOiB,iBAAiB,YAAa,EAAKwC,OAAOzD,IACjD,EAAKuD,aAAaxD,YAAYC,GAEvBA,KAGT,EAAKV,eAAeS,YAAY,EAAKwD,cACrC/F,EAAEuC,YAAY,EAAKT,gBAEnBuC,GAAO,EAAKyE,OAAQ/K,EAAYkC,EAAOsM,WAGvC,EAAKT,YAAc,KAGnB,EAAKE,UAAY,KAAK,EAkIvB,SAjIA,yBAgHD,WACE,OAAO9W,KAAK6Q,eACb,qBAYD,WACE7Q,KAAK4M,eAAehB,WAAWoF,YAAYhR,KAAK4M,gBAChD,wHACD,EAlMgC,CAASmC,qkCCN5C,IAGqBuI,GAAoB,8sBAEvC,WAAYxM,EAAGC,EAAQC,GAAK,MAGH,mGAHG,SACJ,MAAtB,cAAMF,EAAGC,EAAQC,IAAK,gBAKT,SAAClL,EAAGoM,GACjB,EAAKqL,gBAAgB,CACnBrJ,UAAW,EAAKwC,YAChBvC,QAAS,EAAKwC,YAGhB,EAAK6G,WAAa,IAAIxD,GAAiBlU,EAAGoM,EAAG,EAAKpB,EAAG,EAAKE,QAC3D,iBAEM,WACD,EAAKwM,aACP,EAAKA,WAAWC,UAChB,EAAKD,WAAa,SAErB,wBAEa,SAAC1X,EAAGoM,GAAC,OACjB,EAAKsL,WAAWE,OAAO5X,EAAGoM,MAAE,sBAElB,WACV,EAAKyL,kBACL,EAAKrJ,SAAU,EAEf,MAA0B,EAAKkJ,WAAWnM,wBAAlCG,EAAK,EAALA,MAAO1K,EAAM,EAANA,OAET8W,EAAW,EAAK7M,OAAO8M,mBAAqB,EAC5CC,EAAY,EAAK/M,OAAOgN,oBAAsB,EAEpD,GAAIvM,GAASoM,GAAY9W,GAAUgX,EAAW,CAE5C,IAAQ3G,EAAY,EAAKqG,WAAjBrG,QACRA,EAAQtI,WAAa,EAAK2O,WAAWQ,cAGrC,EAAKrU,KAAK,WAAYwN,QAEtB,EAAKxN,KAAK,UAGZ,EAAKsU,UACN,gCAMqB,SAAApP,GAAU,OAC9B,IAAI8M,GAAe9M,EAAY,EAAKiC,EAAG,EAAKC,OAAQ,EAAKC,QAlDzD,EAAKwM,WAAa,KAAK,EA+CxB,SA9CA,2BA4CD,WACE,OAA0B,MAAnBxX,KAAKwX,qFACb,EApDsC,CAASvJ,GA2DlDqJ,GAAqBlG,WAAa,SAElCkG,GAAqBxI,SAAW,SAAAjG,GAAc,MACtCO,EAAWP,EAAWO,SAAS,eACrC,GAAIA,EACF,OAAqB,QAArB,EAAOA,EAASY,aAAK,aAAd,EAAgBkO,MAAM,oBCpEjC,IAAM/E,GAAS,SAACL,EAAOhT,EAAGoM,EAAGiM,EAAIC,GAC/BtF,EAAM/L,aAAa,KAAMjH,GACzBgT,EAAM/L,aAAa,KAAMmF,GACzB4G,EAAM/L,aAAa,KAAMoR,GACzBrF,EAAM/L,aAAa,KAAMqR,IAwBdC,GAAiB,SAACvN,EAAGuI,EAAIC,EAAI6E,EAAIC,GAC5C,IAAME,EAAexN,EAAEyC,cAAc,cAC/BgL,EAAezN,EAAEyC,cAAc,cAErC4F,GAAOmF,EAAcjF,EAAIC,EAAI6E,EAAIC,GACjCjF,GAAOoF,EAAclF,EAAIC,EAAI6E,EAAIC,IAGtBI,GAAiB,SAAA1N,GAC5B,IAAMyN,EAAezN,EAAEyC,cAAc,cAOrC,MAAO,CAAE8F,GALE7F,WAAW+K,EAAa/R,aAAa,OAKnC8M,GAJF9F,WAAW+K,EAAa/R,aAAa,OAI/B2R,GAHN3K,WAAW+K,EAAa/R,aAAa,OAG3B4R,GAFV5K,WAAW+K,EAAa/R,aAAa,ySC5CP,IAEtBiS,GAAW,WAE9B,WAAY9E,EAAiB+E,GAAS,mIAiB7B,WACP,MAA2BF,GAAe,EAAKE,SAAvCrF,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GAAI6E,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GAEdtE,EAAKR,EAAK8E,EAEhB,EAAKrE,KAAKhN,aAAa,IAAK,SAAF,OAAW,EAAKwI,EAAC,aAAK,EAAKzQ,EAAC,cAAM,EAAKyQ,EAAC,eAAO8D,EAAE,YAAIS,EAAE,cAAMqE,EAAE,YAAIC,EAAE,kBAChG,mBAMS,kBACR,EAAKrE,KAAKnI,WAAWoF,YAAY,EAAK+C,SA7BtC/T,KAAKuP,EAAIoE,EAAgBnE,aACzBxP,KAAKlB,EAAI6U,EAAgBlE,cAEzBzP,KAAK0Y,QAAUA,EAEf,MAA2BF,GAAexY,KAAK0Y,SAAvCrF,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GAAI6E,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GAEdtE,EAAKR,EAAK8E,EAEhBpY,KAAK+T,KAAOlH,SAASC,gBAAgB1G,EAAe,QACpDpG,KAAK+T,KAAKhN,aAAa,YAAa,WACpC/G,KAAK+T,KAAKhN,aAAa,QAAS,sBAEhC/G,KAAK+T,KAAKhN,aAAa,IAAK,SAAF,OAAW/G,KAAKuP,EAAC,aAAKvP,KAAKlB,EAAC,cAAMkB,KAAKuP,EAAC,eAAO8D,EAAE,YAAIS,EAAE,cAAMqE,EAAE,YAAIC,EAAE,uBAahG,SAZA,yBAUD,WACE,OAAOpY,KAAK+T,+EACb,EA7B6B,mSCGhC,IAIqB4E,GAAiB,WAEpC,WAAY1E,EAASC,EAASpJ,EAAGE,GAAK,mIA+B7B,SAACmJ,EAAWC,GAEnB,EAAKrH,MAAMtD,MAAM4K,QAAU,KAE3B,IAAM9E,EAAI4E,EAAY,EAAKG,OAAO,GAC5BxV,EAAIsV,EAAY,EAAKE,OAAO,GAE5BjB,EAAK9D,EAAI,EAAI,EAAK+E,OAAO,GAAK/E,EAAI,EAAI4E,EAAY5E,EAAI,EACtD+D,EAAKxU,EAAI,EAAI,EAAKwV,OAAO,GAAKxV,EAAI,EAAIsV,EAAYtV,EAAI,EAEtDqZ,EAAKhZ,KAAKoX,IAAIhH,EAAI,GAClB6I,EAAKjZ,KAAKoX,IAAIzX,EAAI,GAExBuZ,GAAe,EAAKK,QAASrF,EAAIC,EAAI6E,EAAIC,GACzC,EAAKrE,KAAKQ,YACX,iCAEuB,kBACtB,EAAKmE,QAAQrN,2BAAuB,uBAExB,WACZ,OAAO,IAAIf,EAAU0I,GAAY,EAAKjG,MAAO,EAAK/B,IAAI2C,WACvD,mBAES,WACR,EAAKZ,MAAMnB,WAAWoF,YAAY,EAAKjE,OAEvC,EAAKgH,KAAO,KACZ,EAAK2E,QAAU,KACf,EAAK3L,MAAQ,QA3Db/M,KAAKsU,OAAS,CAAEL,EAASC,GAEzBlU,KAAKgL,IAAMA,EAEXhL,KAAK+M,MAAQF,SAASC,gBAAgB1G,EAAe,KAErDpG,KAAK0Y,QFLkB,SAACrF,EAAIC,EAAI6E,EAAIC,GACtC,IAAMtN,EAAI+B,SAASC,gBAAgB1G,EAAe,KAC5CkS,EAAgBzL,SAASC,gBAAgB1G,EAAe,WACxDmS,EAAgB1L,SAASC,gBAAgB1G,EAAe,WAW9D,OATAkS,EAAavR,aAAa,QAAS,aACnCoM,GAAOmF,EAAcjF,EAAIC,EEDsB,EFCd8E,GAEjCG,EAAaxR,aAAa,QAAS,aACnCoM,GAAOoF,EAAclF,EAAIC,EEJsB,EFId8E,GAEjCtN,EAAEuC,YAAYkL,GACdzN,EAAEuC,YAAYiL,GAEPxN,EETU8N,CAAY3E,EAASC,GACpClU,KAAK0Y,QAAQ3R,aAAa,QAAS,iBAEnC/G,KAAK+T,KAAO,IAAIS,GAAKxJ,EAAI2C,MAAO3N,KAAK0Y,SAKrC1Y,KAAK+M,MAAMtD,MAAMgL,cAAgB,OAIjCzU,KAAK+M,MAAMtD,MAAM4K,QAAU,OAE3BrU,KAAK+M,MAAMM,YAAYrN,KAAK+T,KAAK5C,SACjCnR,KAAK+M,MAAMM,YAAYrN,KAAK0Y,SAE5B5N,EAAEuC,YAAYrN,KAAK+M,eAKpB,SAJA,yBAED,WACE,OAAO/M,KAAK0Y,kFACb,EA/BmC,01ECHtC,IAGqBG,GAAe,8sBAElC,WAAYhQ,EAAYiC,EAAGC,EAAQC,GAAK,4GACJ,MAAlC,cAAMnC,EAAYiC,EAAGC,EAAQC,IAAK,WA+D1B,SAACqI,EAAIC,EAAI6E,EAAIC,GACrBC,GAAe,EAAKK,QAASrF,EAAIC,EAAI6E,EAAIC,GACzC,EAAKrE,KAAKQ,SACVmB,GAAmB,EAAK7E,aAAcwC,EAAIC,EAAI6E,EAAIC,GAElD,SAAsD,EAAKxC,QAAO,GAA1DC,EAAO,KAAEC,EAAQ,KAAEC,EAAW,KAAEC,EAAU,KAClD,EAAKvF,YAAYoF,EAASxC,EAAIC,EAAK8E,GACnC,EAAK3H,YAAYqF,EAAUzC,EAAK8E,EAAI7E,GACpC,EAAK7C,YAAYsF,EAAa1C,EAAIC,EAAK8E,GACvC,EAAK3H,YAAYuF,EAAY3C,EAAK8E,EAAI7E,MACvC,2BAEgB,SAAC2C,EAAkBC,EAAc4C,EAAY3C,GAC5D,IAAM7B,EAAS,EAAK8B,YAAYF,GAC1B6C,EAAa,EAAK3C,YAAY0C,GAEhCzC,EAASF,EAASrW,EAClBwW,EAASH,EAASjK,EAClBiM,EAAK,EACLC,EAAK,EACc,GAApBnC,GAA6C,GAApBA,EAC1BI,EAAS/B,EAAOxU,EAEhBwW,EAAShC,EAAOpI,EAGlB,IAAMV,EAAQ6K,EAAS/B,EAAOxU,EACxBgB,EAASwV,EAAShC,EAAOpI,EACzBpM,EAAI0L,EAAQ,EAAI8I,EAAOxU,EAAIuW,EAC3BnK,EAAIpL,EAAS,EAAIwT,EAAOpI,EAAIoK,EAC5B/G,EAAIpQ,KAAKoX,IAAI/K,GACb1M,EAAIK,KAAKoX,IAAIzV,GACbuS,EAAKvT,EAAIyP,EAAE,EACX+D,EAAKpH,EAAIpN,EAAE,EAajB,GAZIqZ,EAAK5I,EAAE,EACP6I,EAAKtZ,EAAE,EACY,GAApBmX,GAA6C,GAApBA,EAC1BkC,EAAKhZ,KAAKoX,IAAIjC,EAAOxU,EAAIiZ,EAAWjZ,GAEpCsY,EAAKjZ,KAAKoX,IAAIjC,EAAOpI,EAAI6M,EAAW7M,GAGtCmM,GAAe,EAAKK,QAASrF,EAAIC,EAAI6E,EAAIC,GACzC,EAAKrE,KAAKQ,SACVmB,GAAmB,EAAK7E,aAAcwC,EAAIC,EAAI6E,EAAIC,GAE1B,GAApBnC,GAA6C,GAApBA,EAAuB,CAClD,IAAIO,EAAO,EACPC,EAAO,GACY,GAApBR,GAAyBnV,EAAS,GAAyB,GAApBmV,GAAyBnV,EAAS,KAC1E0V,EAAO,EACPC,EAAO,GAET,EAAKhG,YAAY,EAAKmF,QAAQY,GAAOnD,EAAIC,EAAK8E,GAC9C,EAAK3H,YAAY,EAAKmF,QAAQa,GAAOpD,EAAIC,EAAK8E,GAC9C,EAAK3H,YAAY,EAAKmF,QAAQ,GAAIvC,EAAK8E,EAAI7E,GAC3C,EAAK7C,YAAY,EAAKmF,QAAQ,GAAIvC,EAAK8E,EAAI7E,OACtC,CACL,IAAIoD,EAAO,EACPC,EAAO,GACa,GAApBV,GAAyBzK,EAAQ,GAAyB,GAApByK,GAAyBzK,EAAQ,KACzEkL,EAAO,EACPC,EAAO,GAET,EAAKlG,YAAY,EAAKmF,QAAQc,GAAOrD,EAAK8E,EAAI7E,GAC9C,EAAK7C,YAAY,EAAKmF,QAAQe,GAAOtD,EAAK8E,EAAI7E,GAC9C,EAAK7C,YAAY,EAAKmF,QAAQ,GAAIvC,EAAIC,EAAK8E,GAC3C,EAAK3H,YAAY,EAAKmF,QAAQ,GAAIvC,EAAIC,EAAK8E,OAE9C,mBAEQ,SAAAxB,GAAW,OAAI,SAAA/K,GACtB,EAAK+K,YAAcA,EAEnB,IAAMC,EAAM,EAAKxI,YAAYxC,GAC7B,EAAmB2M,GAAe,EAAKE,SAA/BrF,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GAEZ,EAAKwD,UAAY,CAAEhX,EAAG+W,EAAI/W,EAAIuT,EAAInH,EAAG2K,EAAI3K,EAAIoH,OAC9C,wBAEa,SAAAzH,GACZ,IAAMkL,EAAY,SAACC,EAAOvX,GAAG,OAC3BuX,EAAQ,EAAI,EAAMA,EAAQvX,EAAMA,EAAMuX,GAExC,GAAI,EAAKJ,YAAa,CACpB,IAAMC,EAAM,EAAKxI,YAAYxC,GAE7B,GAAI,EAAK+K,cAAgB,EAAK8B,QAAS,CACrC,MAAmBF,GAAe,EAAKE,SAA/BP,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GAEZ,EAAwC,EAAKpN,IAAI2C,MAAzC6B,EAAY,EAAZA,aAAcC,EAAa,EAAbA,cAEhB4D,EAAK0D,EAAUF,EAAI/W,EAAI,EAAKgX,UAAUhX,EAAG0P,EAAe2I,GACxD7E,EAAKyD,EAAUF,EAAI3K,EAAI,EAAK4K,UAAU5K,EAAGuD,EAAgB2I,GAE/D,EAAKnB,QAAQ5D,EAAIC,EAAI6E,EAAIC,GACzB,EAAKzU,KAAK,SAAUqP,GAAY,EAAK0F,QAAS,EAAK1N,IAAI2C,YAClD,CAGL,IAAMuJ,EAAY,EAAKtB,QAAQvV,QAAQ,EAAKuW,aACtCO,EAAiBD,EAAY,EACjC,EAAKtB,QAAQsB,EAAY,GAAK,EAAKtB,QAAQsB,EAAY,GACnD4B,EAAa,EAAKlD,SAASsB,EAAY,GAAK,GAElD,EAAKE,eAAeF,EAAWC,EAAgB2B,EAAYjC,GAC3D,EAAKlT,KAAK,SAAUqP,GAAY,EAAK0F,QAAS,EAAK1N,IAAI2C,aAG5D,sBAEW,WACV,EAAKiJ,YAAc,KACnB,EAAKE,UAAY,QAClB,wBAMa,SAAAjO,GACZ,IAAMiK,EAAQhB,GAAmBjJ,GAE3BwK,EAAK7F,WAAWsF,EAAMtM,aAAa,OACnC8M,EAAK9F,WAAWsF,EAAMtM,aAAa,OACnC2R,EAAK3K,WAAWsF,EAAMtM,aAAa,OACnC4R,EAAK5K,WAAWsF,EAAMtM,aAAa,OAEzC,EAAKyQ,QAAQ5D,EAAIC,EAAI6E,EAAIC,MA7LzB,EAAKhN,IAAImD,iBAAiB,YAAa,EAAKmC,aAC5C,EAAKtF,IAAImD,iBAAiB,UAAW,EAAKoC,WAgB1C,EAAK/D,eAAiBC,SAASC,gBAAgB1G,EAAe,KAE9D,EAAKsS,QAAU7F,GAAgBhK,GAC/B,EAAK6P,QAAQnL,cAAc,cACxBgB,iBAAiB,YAAa,EAAKwC,OAAO,EAAK2H,UAElD,EAAK3E,KAAO,IAAIS,GAAKxJ,EAAI2C,MAAO,EAAK+K,SAErC,EAAK9L,eAAeS,YAAY,EAAK0G,KAAK5C,SAG1C,EAAKN,aAAehE,SAASC,gBAAgB1G,EAAe,KAC5D,EAAKyK,aAAa9J,aAAa,QAAS,oCACxC,EAAK8J,aAAaxD,YAAY,EAAKqL,SAEnC,MAA2BF,GAAe,EAAKE,SAAvCrF,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GAAI6E,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GA0BE,OAxBtB,EAAKxC,QAAU,CACb,CAAEvC,EAAIC,EAAK8E,GACX,CAAE/E,EAAK8E,EAAI7E,GACX,CAAED,EAAIC,EAAK8E,GACX,CAAE/E,EAAK8E,EAAI7E,IACXhE,KAAI,SAAA5Q,GACJ,SAAiBA,EAAC,GAAVoB,EAAC,KAAEoM,EAAC,KACNoB,EAAS,EAAKwD,WAAWhR,EAAGoM,GAKlC,OAHAoB,EAAOiB,iBAAiB,YAAa,EAAKwC,OAAOzD,IACjD,EAAKuD,aAAaxD,YAAYC,GAEvBA,KAGT,EAAKV,eAAeS,YAAY,EAAKwD,cACrC/F,EAAEuC,YAAY,EAAKT,gBAEnBuC,GAAO,EAAKuJ,QAAS7P,EAAYkC,EAAOsM,WAGxC,EAAKT,YAAc,KAGnB,EAAKE,UAAY,KAAK,EAyIvB,SAxIA,yBAsHD,WACE,OAAO9W,KAAK6Q,eACb,qBAaD,WACE7Q,KAAK4M,eAAehB,WAAWoF,YAAYhR,KAAK4M,gBAChD,wHACD,EAxMiC,CAASmC,qkCCN7C,IAGqBiK,GAAqB,8sBAExC,WAAYlO,EAAGC,EAAQC,GAAK,MAGH,mGAHG,SACJ,MAAtB,cAAMF,EAAGC,EAAQC,IAAK,gBAKT,SAAClL,EAAGoM,GACjB,EAAKqL,gBAAgB,CACnBrJ,UAAW,EAAKwC,YAChBvC,QAAS,EAAKwC,YAGhB,EAAK6G,WAAa,IAAImB,GAAkB7Y,EAAGoM,EAAG,EAAKpB,EAAG,EAAKE,QAC5D,iBAEM,WACD,EAAKwM,aACP,EAAKA,WAAWC,UAChB,EAAKD,WAAa,SAErB,wBAEa,SAAC1X,EAAGoM,GAAC,OACjB,EAAKsL,WAAWE,OAAO5X,EAAGoM,MAAE,sBAElB,WACV,EAAKyL,kBACL,EAAKrJ,SAAU,EAEf,MAA0B,EAAKkJ,WAAWnM,wBAAlCG,EAAK,EAALA,MAAO1K,EAAM,EAANA,OAET8W,EAAW,EAAK7M,OAAO8M,mBAAqB,EAC5CC,EAAY,EAAK/M,OAAOgN,oBAAsB,EAEpD,GAAIvM,GAASoM,GAAY9W,GAAUgX,EAAW,CAE5C,IAAQ3G,EAAY,EAAKqG,WAAjBrG,QACRA,EAAQtI,WAAa,EAAK2O,WAAWQ,cAGrC,EAAKrU,KAAK,WAAYwN,QAEtB,EAAKxN,KAAK,UAGZ,EAAKsU,UACN,gCAMqB,SAAApP,GAAU,OAC9B,IAAIgQ,GAAgBhQ,EAAY,EAAKiC,EAAG,EAAKC,OAAQ,EAAKC,QAlD1D,EAAKwM,WAAa,KAAK,EA+CxB,SA9CA,2BA4CD,WACE,OAA0B,MAAnBxX,KAAKwX,qFACb,EApDuC,CAASvJ,8YA2DnD+K,GAAsB5H,WAAa,UAEnC4H,GAAsBlK,SAAW,SAAAjG,GAAc,MACvCO,EAAWP,EAAWO,SAAS,eACrC,GAAIA,EACF,OAAqB,QAArB,EAAOA,EAASY,aAAK,aAAd,EAAgBkO,MAAM,qBCjEjC,IAIqBe,GAAkB,WAErC,WAAY3E,EAAQxJ,EAAGE,GAAK,sIAmChB,SAAAkO,GACV,IAAIC,EAAMD,EAAO5J,KAAI,SAAAxD,GAAE,iBAAQA,EAAG,GAAE,YAAIA,EAAG,OAAM7E,KAAK,KACtDkS,EAAM,IAAMA,EAAI9J,UAAU,GAC1B,EAAKjC,MAAMrG,aAAa,IAAKoS,GAC7B,EAAKhM,MAAMpG,aAAa,IAAKoS,MAC9B,iCAEuB,kBACtB,EAAK/L,MAAM/B,2BAAuB,kBAE3B,SAAA+N,GAEP,EAAKrM,MAAMtD,MAAM4K,QAAU,KAI3B,EAAKgF,SAASD,MAIf,oBAEU,SAAAA,SACT,EAAKF,OAAS,GAAH,uDAAQ,EAAKA,2kBAAM,CAAEE,IAChC,EAAKE,UAAU,EAAKJ,WAGrB,mBAMS,WACR,EAAKnM,MAAMnB,WAAWoF,YAAY,EAAKjE,OACvC,EAAKwM,SAAW,KAChB,EAAKxM,MAAQ,QACd,uBAEa,WACZ,OAAO,IAAIzC,EAAU0I,GAAY,EAAKjG,MAAO,EAAK/B,IAAI2C,WA1EtD3N,KAAKkZ,OAAS,CAAE5E,GAEhBtU,KAAKgL,IAAMA,EAEXhL,KAAK+M,MAAQF,SAASC,gBAAgB1G,EAAe,KAErDpG,KAAKuZ,SAAW1M,SAASC,gBAAgB1G,EAAe,KACxDpG,KAAKuZ,SAASxS,aAAa,QAAS,iBAEpC/G,KAAKoN,MAAQP,SAASC,gBAAgB1G,EAAe,QACrDpG,KAAKoN,MAAMrG,aAAa,QAAS,aAEjC/G,KAAKmN,MAAQN,SAASC,gBAAgB1G,EAAe,QACrDpG,KAAKmN,MAAMpG,aAAa,QAAS,aAEjC/G,KAAKsZ,UAAUtZ,KAAKkZ,QAKpBlZ,KAAKuZ,SAASlM,YAAYrN,KAAKoN,OAC/BpN,KAAKuZ,SAASlM,YAAYrN,KAAKmN,OAI/BnN,KAAK+M,MAAMtD,MAAM4K,QAAU,OAI3BrU,KAAK+M,MAAMM,YAAYrN,KAAKuZ,UAE5BzO,EAAEuC,YAAYrN,KAAK+M,eAkCpB,SAjCA,yBA+BD,WACE,OAAO/M,KAAKuZ,mFACb,EApEoC,w5CCHvC,IAAMC,GAAY,SAAA1G,GAChB,IAAM2G,EAAY3G,EAAMtM,aAAa,KAAKE,MAAM,KAC1CwS,EAAS,GACf,GAAGO,EAAU1Z,OAAS,EAAG,CACvB,IAAIwQ,EAAQkJ,EAAU,GAAGpK,UAAU,GAAGqK,OAAOhT,MAAM,KACnDwS,EAAOlY,KAAK,CAAElB,EAAG0N,WAAW+C,EAAM,IAAKrE,EAAGsB,WAAW+C,EAAM,MAE3D,IAAK,IAAI9R,EAAI,EAAGA,EAAIgb,EAAU1Z,OAAQtB,IAChC8R,EAAQkJ,EAAUhb,GAAGib,OAAOhT,MAAM,KACtCwS,EAAOlY,KAAK,CAAElB,EAAG0N,WAAW+C,EAAM,IAAKrE,EAAGsB,WAAW+C,EAAM,MAI/D,OAAO2I,GAGH3D,GAAU,SAAAzC,GACd,OAAOA,EAAMvF,cAAc,cAAcgI,WAMtBoE,GAAgB,8sBAEnC,WAAY9Q,EAAYiC,EAAGC,EAAQC,GAAK,8GACJ,MAAlC,cAAMnC,EAAYiC,EAAGC,EAAQC,IAAK,aAkExB,SAACkO,GAGX,IAAMU,EAAQ,SAAAC,GAAG,OAAI1a,KAAKya,MAAM,GAAKC,GAAO,IAExCV,EAAMD,EAAO5J,KAAI,SAAAxD,GAAE,iBAAQ8N,EAAM9N,EAAGhM,GAAE,YAAI8Z,EAAM9N,EAAGI,OAAMjF,KAAK,KAClEkS,EAAM,IAAMA,EAAI9J,UAAU,GAEZ,EAAKyD,MAAMvF,cAAc,cACjCxG,aAAa,IAAKoS,GAExB,IAAM/L,EAAQ,EAAK0F,MAAMvF,cAAc,cACvCH,EAAMrG,aAAa,IAAKoS,GAExB,MAAgC/L,EAAMmI,UAA9BzV,EAAC,EAADA,EAAGoM,EAAC,EAADA,EAAGV,EAAK,EAALA,MAAO1K,EAAM,EAANA,OAarB4U,GAAmB,EAAK7E,aAAc/Q,EAAGoM,EAAGV,EAAO1K,MACpD,mBAOQ,SAAA8V,GAAW,OAAI,SAAA/K,GACtB,EAAK+K,YAAcA,EACnB,IAAMC,EAAM,EAAKxI,YAAYxC,GAC7B,EAAKiL,UAAY,CAAEhX,EAAG+W,EAAI/W,EAAGoM,EAAG2K,EAAI3K,OACrC,wBAEa,SAAAL,GACZ,IAAMkL,EAAY,SAACC,EAAO8C,EAAOra,GAAG,OAClCuX,EAAQ8C,EAAQ,GAAK9C,EAASA,EAAQ8C,EAAQra,EAAMA,EAAMuX,EAAQ8C,GAEpE,GAAI,EAAKlD,YAAa,CACpB,IAAMC,EAAM,EAAKxI,YAAYxC,GAE7B,EAAgC0J,GAAQ,EAAKzC,OAArChT,EAAC,EAADA,EAAGoM,EAAC,EAADA,EAAGV,EAAK,EAALA,MAAO1K,EAAM,EAANA,OAErB,GAAI,EAAK8V,cAAgB,EAAK9D,MAAO,CAEnC,MAAwC,EAAK9H,IAAI2C,MAAzC6B,EAAY,EAAZA,aAAcC,EAAa,EAAbA,cAEhBsK,EAAKhD,EAAUjX,EAAG+W,EAAI/W,EAAI,EAAKgX,UAAUhX,EAAG0P,EAAehE,GAC3DwO,EAAKjD,EAAU7K,EAAG2K,EAAI3K,EAAI,EAAK4K,UAAU5K,EAAGuD,EAAgB3O,GAE5DqM,EAAQ,EAAK2F,MAAMvF,cAAc,cACjC0M,EAAgBT,GAAUrM,GAAOmC,KAAI,SAAAxD,GAAE,MAAK,CAAEhM,EAAGgM,EAAGhM,EAAIia,EAAI7N,EAAGJ,EAAGI,EAAI8N,MAE5E,EAAKlD,UAAYD,EAEjB,EAAKyC,UAAUW,GAEf,EAAKtW,KAAK,SAAUqP,GAAY,EAAKF,MAAO,EAAK9H,IAAI2C,aAa1D,sBAEW,SAAA9B,GACV,EAAK+K,YAAc,KACnB,EAAKE,UAAY,QAClB,wBAMa,SAAAjO,GACZ,IAAMqQ,EAASM,GAAU1H,GAAmBjJ,IAC5C,EAAKyQ,UAAUJ,MAChB,oBAES,WACR,EAAKtM,eAAehB,WAAWoF,YAAY,EAAKpE,gBAChD,qDA/JA,EAAKxB,IAAImD,iBAAiB,YAAa,EAAKmC,aAC5C,EAAKtF,IAAImD,iBAAiB,UAAW,EAAKoC,WAiB1C,EAAK/D,eAAiBC,SAASC,gBAAgB1G,EAAe,KAE9D,EAAK0M,MAAQD,GAAgBhK,GAO7B,EAAKgI,aAAehE,SAASC,gBAAgB1G,EAAe,KAC5D,EAAKyK,aAAa9J,aAAa,QAAS,oCACxC,EAAK8J,aAAaxD,YAAY,EAAKyF,OAEnC,EAAKlG,eAAeS,YAAY,EAAKwD,cACrC/F,EAAEuC,YAAY,EAAKT,gBAEnBuC,GAAO,EAAK2D,MAAOjK,EAAYkC,EAAOsM,WAEtC,EAAKvE,MAAMvF,cAAc,cACtBgB,iBAAiB,YAAa,EAAKwC,OAAO,EAAK+B,QAElD,MAAgCyC,GAAQ,EAAKzC,OAsBvB,OAtBb,EAADhT,EAAI,EAADoM,EAAQ,EAALV,MAAa,EAAN1K,OAmBrB,EAAK8V,YAAc,KAGnB,EAAKE,UAAY,KAAK,EAyFvB,SAxFA,yBAsFD,WACE,OAAO9W,KAAK6Q,uFACb,EA3JkC,CAAS9B,qkCC1B9C,IAGqBmL,GAAsB,8sBAEzC,WAAYpP,EAAGC,EAAQC,GAAK,MAGF,mGAHE,SACJ,MAAtB,cAAMF,EAAGC,EAAQC,IAAK,gBAKT,SAAClL,EAAGoM,GACjB,EAAKiO,YAAa,EAElB,EAAK5C,gBAAgB,CACnBrJ,UAAW,EAAKwC,YAChBvC,QAAS,EAAKwC,UACdvC,SAAU,EAAKgM,aAGjB,EAAK5C,WAAa,IAAIyB,GAAmB,CAAEnZ,EAAGoM,GAAK,EAAKpB,EAAG,EAAKE,QACjE,iBAEM,WACL,EAAK2M,kBAEL,EAAKwC,YAAa,EAEd,EAAK3C,aACP,EAAKA,WAAWC,UAChB,EAAKD,WAAa,SAErB,wBAEa,SAAC1X,EAAGoM,GAAC,OACjB,EAAKsL,WAAWE,OAAO,CAAE5X,EAAGoM,OAAI,sBAEtB,SAACpM,EAAGoM,GACd,EAAKkO,WAAWta,EAAGoM,MACpB,uBAEY,SAACpM,EAAGoM,GACf,EAAKiO,YAAa,EAElB,EAAK3C,WAAW6B,SAAS,CAAEvZ,EAAGoM,IAE9B,EAAKyL,kBAEL,MAA0B,EAAKH,WAAWnM,wBAAlCG,EAAK,EAALA,MAAO1K,EAAM,EAANA,OAET8W,EAAW,EAAK7M,OAAO8M,mBAAqB,EAC5CC,EAAY,EAAK/M,OAAOgN,oBAAsB,EAEpD,GAAIvM,GAASoM,GAAY9W,GAAUgX,EAAW,CAE5C,IAAMhF,EAAQ,EAAK0E,WAAWrG,QAC9B2B,EAAMjK,WAAa,EAAK2O,WAAWQ,cAEnC,EAAKrU,KAAK,WAAYmP,QAEtB,EAAKnP,KAAK,UAGZ,EAAKsU,UACN,gCAMqB,SAAApP,GAAU,OAC9B,IAAI8Q,GAAiB9Q,EAAY,EAAKiC,EAAG,EAAKC,OAAQ,EAAKC,QA/D3D,EAAKmP,YAAa,EAAM,EA4DzB,SA3DA,2BAyDD,WACE,OAAOna,KAAKma,qFACb,EAjEwC,CAASlM,iqDAwEpDiM,GAAuB9I,WAAa,WAEpC8I,GAAuBpL,SAAW,SAAAjG,GAAc,MACxCO,EAAWP,EAAWO,SAAS,eACrC,GAAIA,EACF,OAAsB,QAAd,EAAAA,EAASY,aAAK,aAAd,EAAgBkO,MAAM,qBAAsB9O,EAASY,MAAMqQ,cAAcjL,SAAS,MC7E9F,IAIqBkL,GAAsB,WAEzC,WAAYhG,EAAQxJ,EAAGE,GAAK,sIAsChB,SAAAkO,GACV,IACqB,EADjB3S,EAAM,GAAG,KACE2S,GAAM,IAArB,IAAK,EAAL,qBAAsB,KAAbqB,EAAE,QACLC,EAAM,GACV,GAAID,EAAGxa,OAAO,EAAE,KACE,EADF,KACAwa,GAAE,IAAhB,IAAK,EAAL,qBAAkB,KAAT3a,EAAC,QACJA,IAEA4a,GADU,KAARA,EACG,WAAQ5a,EAAE,GAAE,YAAIA,EAAE,IAGlB,YAASA,EAAE,GAAE,YAAIA,EAAE,MAG7B,8BACA2G,GAAMiU,IAEV,8BACDjU,GAAM,KACN,EAAK6G,MAAMrG,aAAa,IAAKR,GAC7B,EAAK4G,MAAMpG,aAAa,IAAKR,MAC9B,iCAEuB,WACtBkU,QAAQrb,IAAI,wBAAyB,EAAKgO,OAC1C,EAAKA,MAAM/B,2BACZ,kBACU,SAAA+N,GAEP,EAAKrM,MAAMtD,MAAM4K,QAAU,KAC3B,IAAMqG,EAAO,EAAKxB,OAAO,EAAKA,OAAOnZ,OAAS,GAAG4B,MAAM,EAAG,EAAKuX,OAAO,EAAKA,OAAOnZ,OAAS,GAAGA,OAAS,GACnG4a,EAAS,EAAKzB,OAAOvX,MAAM,GAAG,GAC5B6V,EAAa,GAAH,UAAQkD,GAAI,CAAEtB,EAAIsB,EAAK,KACvCC,EAAS3Z,KAAKwW,GACd,EAAK8B,UAAUqB,MAEhB,oBAEQ,SAAAvB,GAGT,GAAI,EAAKF,OAAO,EAAKA,OAAOnZ,OAAS,GAAGA,OAAO,EAAE,CAC/C,IAAM2a,EAAO,EAAKxB,OAAO,EAAKA,OAAOnZ,OAAS,GAAG4B,MAAM,EAAG,EAAKuX,OAAO,EAAKA,OAAOnZ,OAAS,GAAGA,OAAS,GACjG6a,EAAaF,EAAKA,EAAK3a,OAAS,GACzBZ,KAAKmD,IAAI8W,EAAG,GAAKwB,EAAW,GAAI,GAAKzb,KAAKmD,IAAI8W,EAAG,GAAKwB,EAAW,GAAI,GACvE,IACT,EAAK1B,OAAO,EAAKA,OAAOnZ,OAAS,GAAK,GAAH,UAAQ2a,GAAI,CAAEtB,EAAIsB,EAAK,KAC1D,EAAKpB,UAAU,EAAKJ,cAItB,EAAKA,OAAO,EAAKA,OAAOnZ,OAAS,GAAK,CAACqZ,EAAGA,GAE1C,EAAKE,UAAU,EAAKJ,WAEvB,gBACM,WACLuB,QAAQrb,IAAI,OAAO,EAAK8Z,OAAO,EAAKA,OAAOnZ,OAAS,GAAGA,QACnD,EAAKmZ,OAAO,EAAKA,OAAOnZ,OAAS,GAAGA,OAAO,EAC7C,EAAKmZ,OAAO,EAAKA,OAAOnZ,OAAS,GAAGgB,MAEhC,EAAKmY,OAAOnZ,OAAO,GACrB,EAAKmZ,OAAOnY,SAGjB,mBACS,WAER,EAAKmY,OAAOlY,KAAK,OAElB,mBAMS,WACR,EAAK+L,MAAMnB,WAAWoF,YAAY,EAAKjE,OACvC,EAAK8N,aAAe,KACpB,EAAK9N,MAAQ,QACd,uBAEa,WACZ,OAAO,IAAIzC,EAAU0I,GAAY,EAAKjG,MAAO,EAAK/B,IAAI2C,WAxHtD3N,KAAKkZ,OAAS,GACdlZ,KAAKkZ,OAAOlY,KAAK,CAAEsT,EAAQA,IAE3BtU,KAAKgL,IAAMA,EAEXhL,KAAK+M,MAAQF,SAASC,gBAAgB1G,EAAe,KAErDpG,KAAK6a,aAAehO,SAASC,gBAAgB1G,EAAe,KAC5DpG,KAAK6a,aAAa9T,aAAa,QAAS,iBAExC/G,KAAKoN,MAAQP,SAASC,gBAAgB1G,EAAe,QACrDpG,KAAKoN,MAAMrG,aAAa,QAAS,aAEjC/G,KAAKmN,MAAQN,SAASC,gBAAgB1G,EAAe,QACrDpG,KAAKmN,MAAMpG,aAAa,QAAS,aAEjC/G,KAAKsZ,UAAUtZ,KAAKkZ,QAMpBlZ,KAAK6a,aAAaxN,YAAYrN,KAAKoN,OACnCpN,KAAK6a,aAAaxN,YAAYrN,KAAKmN,OAInCnN,KAAK+M,MAAMtD,MAAM4K,QAAU,OAK3BrU,KAAK+M,MAAMM,YAAYrN,KAAK6a,cAE5B/P,EAAEuC,YAAYrN,KAAK+M,eA6EpB,SA5EA,yBA0ED,WACE,OAAO/M,KAAK6a,uFACb,EAlHwC,u+FCH3C,IAAMrB,GAAY,SAAC1G,GAGjB,IAEgC,EAD1BgI,EAAa,GAAG,KADHC,GAAuBjI,EAAMvF,cAAc,cAAciE,WAAW3R,EAAEmb,YAEzD,IAAhC,IAAK,EAAL,qBAAkC,KAEL,EAFpBvB,EAAS,QACZP,EAAS,GAAE,KACGO,GAAS,IAA3B,IAAK,EAAL,qBAA6B,KAApBlJ,EAAK,QACR3Q,EAAI,CACNE,EAAE0N,WAAW+C,EAAM,IACnBrE,EAAEsB,WAAW+C,EAAM,KAErB2I,EAAOlY,KAAKpB,IACb,8BACDkb,EAAW9Z,KAAKkY,IACjB,8BAED,OAAO4B,GAEHC,GAAyB,SAAAE,GAC7B,IAAIC,EAASD,EAAQvU,MAAM,KACvByU,EAAY,GAmBhB,OAlBAD,EAAQzJ,SAAQ,SAAU2J,EAAQC,GAChC,GAAID,EAAOrb,OAAO,EAAE,CAClB,IAAIub,EAAS,IAKbF,GADAA,GADAA,GADAA,GADAA,EAAOA,EAAOxI,QAAQ,MAAM,MACdA,QAAQ,MAAM,MACdA,QAAQ,KAAK,KACbA,QAAQ,MAAM,MACdA,QAAQ,MAAM,MACFlM,MAAM,KACnB+K,SAAQ,SAASuF,EAAOqE,GACnCC,EAAOta,KAAK,CAACwM,WAAWwJ,EAAMtQ,MAAM,KAAK,IAAI6U,QAAQ,GAAG1W,WAAW2I,WAAWwJ,EAAMtQ,MAAM,KAAK,IAAI6U,QAAQ,GAAG1W,gBAE5GyW,EAAO,KAAOA,EAAOA,EAAOvb,OAAS,IACvCub,EAAOta,KAAKsa,EAAO,IAErBH,EAAUna,KAAKsa,OAGZH,GAuCYK,GAAoB,8sBAEvC,WAAY3S,EAAYiC,EAAGC,EAAQC,GAAK,8GACJ,MAAlC,cAAMnC,EAAYiC,EAAGC,EAAQC,IAAK,aA0ExB,SAACkO,GACX,IAI4B,EAJtBU,EAAQ,SAAAC,GAAG,OACjB1a,KAAKya,MAAM,GAAKC,GAAO,IAEnBV,EAAM,GAAE,KACUD,GAAM,IAA5B,IAAK,EAAL,qBAA6B,KAApBO,EAAS,QAChBN,GAAO,IACP,IAC2B,EADvBsC,GAAQ,EAAI,KACEhC,GAAS,IAA3B,IAAK,EAAL,qBAA4B,KAAnBlJ,EAAK,QACRkL,GACFA,GAAQ,EACRtC,GAAO5I,EAAMzQ,EAAE+E,WAAa,IAAM0L,EAAMrE,EAAErH,YAE1CsU,GAAO,KAAOS,EAAMrJ,EAAMzQ,GAAG+E,WAAa,IAAM+U,EAAMrJ,EAAMrE,GAAGrH,YAElE,8BACDsU,GAAO,MACR,8BACa,EAAKrG,MAAMvF,cAAc,cACjCxG,aAAa,IAAKoS,GAExB,IAAM/L,EAAQ,EAAK0F,MAAMvF,cAAc,cACvCH,EAAMrG,aAAa,IAAKoS,GAIxB,MAAgC/L,EAAMmI,UAA9BzV,EAAC,EAADA,EAAGoM,EAAC,EAADA,EAAGV,EAAK,EAALA,MAAO1K,EAAM,EAANA,OACrB4U,GAAmB,EAAK7E,aAAc/Q,EAAGoM,EAAGV,EAAO1K,MACpD,mBAQQ,SAAA8V,GAAW,OAAI,SAAA/K,GACtB,EAAK+K,YAAcA,EACnB,IAAMC,EAAM,EAAKxI,YAAYxC,GAC7B,EAAKiL,UAAY,CAAEhX,EAAG+W,EAAI/W,EAAGoM,EAAG2K,EAAI3K,OACrC,wBAEa,SAAAL,GACU,IAEdgL,EAFJ,EAAKD,cAEDC,EAAM,EAAKxI,YAAYxC,GAEzB,EAAK+K,cAAgB,EAAK9D,MAAO,WACnC,IAM4B,EANtBiH,EAAKlD,EAAI/W,EAAI,EAAKgX,UAAUhX,EAC5Bka,EAAKnD,EAAI3K,EAAI,EAAK4K,UAAU5K,EAI5B+N,EAAgB,GAAE,KAFRT,GAAU,EAAK1G,QAGH,IAA5B,IAAK,EAAL,qBAA6B,KAApBoG,EAAM,QACbe,EAAcjZ,KAAKkY,EAAO5J,KAAI,SAAAxD,GAAE,MAC7B,CAAEhM,EAAGgM,EAAGhM,EAAIia,EAAI7N,EAAGJ,EAAGI,EAAI8N,QAC9B,8BAED,EAAKlD,UAAYD,EAEjB,EAAKyC,UAAUW,GAEf,IADA,IAAIxb,EAAI,EACR,MAA8Bwb,EAAa,eAAjB,KACJxI,SAAQ,SAAC3F,EAAI4P,QACAtW,IAAzB,EAAKwQ,QAAQnX,GAAGid,IAClB,EAAKjL,YAAY,EAAKmF,QAAQnX,GAAGid,GAAM5P,EAAGhM,EAAGgM,EAAGI,MAEpDzN,GAAG,EAGP,EAAKkF,KAAK,SAAU,SACfqP,GAAY,EAAKF,MAAO,EAAK9H,IAAI2C,QAAM,IAC1CyC,YAAa,CACXlN,KAAM,mBA3ByB,GA8B9B,WACL,IAI+B,EAJ3BgU,GAAa,EACbyE,EAAe,EACfC,GAAQ,EAAK,KAEE,EAAKhG,SAAO,IAA/B,IAAK,EAAL,qBAAgC,KAAvBtI,EAAM,QACTA,EAAOjN,QAAQ,EAAKuW,aAAa,GACnCM,EAAY5J,EAAOjN,QAAQ,EAAKuW,aAChCgF,GAAM,GAEDA,IACHD,GAAgB,IAGrB,8BAED,IAI4B,EAJxBlC,EAAYD,GAAU,EAAK1G,OAEzBmH,EAAgB,GAClB4B,EAAmB,EAAC,KACLpC,GAAS,IAA5B,IAAK,EAAL,qBAA6B,KAApBP,EAAM,QACT2C,IAAqBF,EAAa,WACpC,IAAIG,EAAY,GAChB5C,EAAOzH,SAAQ,SAAUzH,EAAOvL,GAC1BA,IAAMyY,EACR4E,EAAU9a,KAAK6V,GAEfiF,EAAU9a,KAAKgJ,MAGnBiQ,EAAcjZ,KAAK8a,GATiB,GAWpC7B,EAAcjZ,KAAKkY,GAErB2C,GAAmB,GACpB,8BAED,EAAKvC,UAAUW,GACf4B,EAAmB,EAAC,IACW,EADX,KACD,EAAKjG,SAAO,IAA/B,IAAK,EAAL,qBAAgC,KAAvBtI,EAAM,QACTuO,IAAqBF,GAEvB,EAAKlL,YAAYnD,EAAO4J,GAAYL,EAAI/W,EAAG+W,EAAI3K,GAEjD2P,GAAmB,GAEpB,8BAED,EAAKlY,KAAK,SAAU,SACfqP,GAAY,EAAKF,MAAO,EAAK9H,IAAI2C,QAAM,IAC1CyC,YAAa,CACXlN,KAAM,mBAnDL,OAwDV,sBAEW,SAAA2I,GACV,EAAK+K,YAAc,KACnB,EAAKE,UAAY,QAClB,wBAMa,SAAAjO,GACZ,IAAMqQ,EAASM,GAAU1H,GAAmBjJ,IAC5C,EAAKyQ,UAAUJ,MAChB,oBAES,WACR,EAAKtM,eAAehB,WAAWoF,YAAY,EAAKpE,gBAChD,qDA/NA,EAAKxB,IAAImD,iBAAiB,YAAa,EAAKmC,aAC5C,EAAKtF,IAAImD,iBAAiB,UAAW,EAAKoC,WAiB1C,EAAK/D,eAAiBC,SAASC,gBAAgB1G,EAAe,KAE9D,EAAK0M,MAjDe,SAAAjK,GACtB,IAAMiK,EAAQhB,GAAmBjJ,IAXA,SAAAA,GACjC,IACIoS,EADanJ,GAAmBjJ,GACbrC,aAAa,KACnBuU,GAAuBE,GAWxCc,CAAoBlT,GAIpB,IAAMiC,EAAI+B,SAASC,gBAAgB1G,EAAe,KAE5C+G,EAAQ2F,EAAMC,WAAU,GAC9B5F,EAAMpG,aAAa,QAAS,aAE5B,IAAMqG,EAAQ0F,EAAMC,WAAU,GAM9B,OALA3F,EAAMrG,aAAa,QAAS,aAE5B+D,EAAEuC,YAAYD,GACdtC,EAAEuC,YAAYF,GAEPrC,EA8BQ+H,CAAgBhK,GAM7B,EAAKgI,aAAehE,SAASC,gBAAgB1G,EAAe,KAC5D,EAAKyK,aAAa9J,aAAa,QAAS,oCACxC,EAAK8J,aAAaxD,YAAY,EAAKyF,OACnC,IAAI2G,EAAYD,GAAU,EAAK1G,OAC/B,EAAK8C,QAAU,GAAE,IACW,EADX,KACE6D,GAAS,IAA5B,IAAK,EAAL,qBAA6B,KAApBP,EAAM,QACb,EAAKtD,QAAQ5U,KAAKkY,EAAO5J,KAAI,SAAAxD,GAC3B,IAAMwB,EAAS,EAAKwD,WAAWhF,EAAGhM,EAAGgM,EAAGI,GAGxC,OAFAoB,EAAOiB,iBAAiB,YAAa,EAAKwC,OAAOzD,IACjD,EAAKuD,aAAaxD,YAAYC,GACvBA,OAEV,8BAGD,EAAKV,eAAeS,YAAY,EAAKwD,cACrC/F,EAAEuC,YAAY,EAAKT,gBAEnBuC,GAAO,EAAK2D,MAAOjK,EAAYkC,EAAOsM,WAEtC,EAAKvE,MAAMvF,cAAc,cACtBgB,iBAAiB,YAAa,EAAKwC,OAAO,EAAK+B,QAElD,MAAwC,EAAKA,MA1FlCvF,cAAc,cAAcgI,UA8GjB,OApBb,EAADzV,EAAI,EAADoM,EAAQ,EAALV,MAAa,EAAN1K,OAiBrB,EAAK8V,YAAc,KAGnB,EAAKE,UAAY,KAAK,EAiJvB,SAhJA,yBA8ID,WACE,OAAO9W,KAAK6Q,uFACb,EA3NsC,CAAS9B,qkCCnFlD,IAGqBiN,GAA0B,8sBAE7C,WAAYlR,EAAGC,EAAQC,GAAK,MAavB,mGAbuB,SACJ,MAAtB,cAAMF,EAAGC,EAAQC,IAAK,gBAcT,SAAClL,EAAGoM,GACjB,EAAKiO,YAAa,EAElB,EAAK5C,gBAAgB,CACnBrJ,UAAW,EAAKwC,YAChBvC,QAAS,EAAKwC,UACdvC,SAAU,EAAKgM,aAGjB,EAAK5C,WAAa,IAAI8C,GAAuB,CAAExa,EAAGoM,GAAK,EAAKpB,EAAG,EAAKE,QACrE,iBAEM,WACL,EAAK2M,kBAEL,EAAKwC,YAAa,EAEd,EAAK3C,aACP,EAAKA,WAAWC,UAChB,EAAKD,WAAa,SAErB,iBACM,WAED,EAAKA,YACP,EAAKA,WAAWyE,UAInB,oBACS,WACJ,EAAKzE,YACP,EAAKA,WAAW0E,aAInB,wBAEa,SAACpc,EAAGoM,GAAC,OACjB,EAAKsL,WAAWE,OAAO,CAAE5X,EAAGoM,OAAI,sBAEtB,SAACpM,EAAGoM,EAAGL,GACjB,GAAIA,EAAIsQ,OACN,EAAK/B,WAAWvO,QACX,GAAIA,EAAIuQ,QACb,EAAK5E,WAAWyE,WACZ,CACJ,MAA0B,EAAKzE,WAAWnM,wBAAlCG,EAAK,EAALA,MAAO1K,EAAM,EAANA,OAET8W,EAAW,EAAK7M,OAAO8M,mBAAqB,EAC5CC,EAAY,EAAK/M,OAAOgN,oBAAsB,EAEhDvM,GAASoM,GAAY9W,GAAUgX,EACjC,EAAKN,WAAW6B,SAAS,CAAEvZ,EAAGoM,KAE9B,EAAKvI,KAAK,UACV,EAAKsU,YAGV,uBAEY,SAACnY,EAAGoM,GACf,EAAKiO,YAAa,EAElB,EAAK3C,WAAW6B,SAAS,CAAEvZ,EAAGoM,IAE9B,IAAM4G,EAAQ,EAAK0E,WAAWrG,QAC9B2B,EAAMjK,WAAa,EAAK2O,WAAWQ,cACnC,EAAKrU,KAAK,WAAYmP,GAEtB,EAAKmF,UACN,gCAUqB,SAAApP,GAAU,OAC9B,IAAI2S,GAAqB3S,EAAY,EAAKiC,EAAG,EAAKC,OAAQ,EAAKC,QA/F/D,EAAKmP,YAAa,EAClBtN,SAAS0B,iBAAiB,WAAW,SAAA1C,GAEpB,KAAXA,EAAI9G,KAAc8G,EAAIuQ,SAExB,EAAKH,OAEQ,KAAXpQ,EAAI9G,KAEN,EAAKmX,aAEN,EAiFJ,SAjFO,2BA+ER,WACE,OAAOlc,KAAKma,qFACb,EAhG4C,CAASlM,GAuGxD+N,GAA2B5K,WAAa,eAExC4K,GAA2BlN,SAAW,SAAAjG,GAAc,QAClD4R,QAAQrb,IAAI,oBACZ,IAAMgK,EAAWP,EAAWO,SAAS,eAGrC,GAFAqR,QAAQrb,IAAI,WAAYgK,GACxBqR,QAAQrb,IAAkB,QAAf,EAACgK,EAASY,aAAK,aAAd,EAAgBkO,MAAM,qBAC9B9O,EACF,OAAqB,QAArB,EAAOA,EAASY,aAAK,aAAd,EAAgBkO,MAAM,4+EC/GjC,IAIqBmE,GAA4B,8sBAE/C,WAAY/H,EAAQxJ,EAAGC,EAAQC,GAAK,MA8CR,mGA9CQ,SAElC,MADA,cAAMF,EAAGC,EAAQC,IACjB,aA+CU,SAAAkO,GACV,IACqB,EADjB3S,EAAM,GAAG,KACE2S,GAAM,IAArB,IAAK,EAAL,qBAAsB,KAAbqB,EAAE,QACLC,EAAM,GACV,GAAID,EAAGxa,OAAO,EAAE,KACE,EADF,KACAwa,GAAE,IAAhB,IAAK,EAAL,qBAAkB,KAAT3a,EAAC,QACJA,IAEA4a,GADU,KAARA,EACG,WAAQ5a,EAAE,GAAE,YAAIA,EAAE,IAGlB,YAASA,EAAE,GAAE,YAAIA,EAAE,MAG7B,8BACA2G,GAAMiU,IAEV,8BACDjU,GAAM,KACN,EAAK6G,MAAMrG,aAAa,IAAKR,GAC7B,EAAK4G,MAAMpG,aAAa,IAAKR,MAC9B,kBACO,WACN,IAAMsU,EAAe,IAAIA,EAAa7H,GAAY,EAAKkG,OAAQ,EAAKlO,IAAI2C,QACxE,EAAKhK,KAAK,QAAS,CAAEmP,MAAO,EAAK+H,aAAcA,aAAAA,OAChD,kCAEuB,WACrB,OAAO,EAAKzN,MAAM/B,2BACpB,mBAEQ,SAAA+N,GAEP,EAAKrM,MAAMtD,MAAM4K,QAAU,KAC3B,EAAKiI,SAAWlD,EAChB,IAAMsB,EAAO,EAAKxB,OAAO,EAAKA,OAAOnZ,OAAS,GAAG4B,MAAM,EAAG,EAAKuX,OAAO,EAAKA,OAAOnZ,OAAS,GAAGA,OAAS,GACnG4a,EAAS,EAAKzB,OAAOvX,MAAM,GAAG,GAC5B6V,EAAa,GAAH,UAAQkD,GAAI,CAAEtB,EAAIsB,EAAK,KACvCC,EAAS3Z,KAAKwW,GACd,EAAK8B,UAAUqB,MAEhB,2BACgB,SAAAlP,GACf,EAAKA,MAAQA,EAEb,IAAM0B,EAAQ,EAAKoP,YAAYhP,cAAc,qBACvCH,EAAQ,EAAKmP,YAAYhP,cAAc,qBAEvCN,EAASxB,GAAS,EAAKV,OAAOmC,cAAgB,GAEpDC,EAAMpG,aAAa,IAAKkG,GACxBG,EAAMrG,aAAa,IAAKkG,MACzB,qBAEU,SAAAmM,GAET,GAAI,EAAKF,OAAO,EAAKA,OAAOnZ,OAAS,GAAGA,OAAO,EAAE,CAC/C,IAAM2a,EAAO,EAAKxB,OAAO,EAAKA,OAAOnZ,OAAS,GAAG4B,MAAM,EAAG,EAAKuX,OAAO,EAAKA,OAAOnZ,OAAS,GAAGA,OAAS,GACjG6a,EAAaF,EAAKA,EAAK3a,OAAS,GACzBZ,KAAKmD,IAAI8W,EAAG,GAAKwB,EAAW,GAAI,GAAKzb,KAAKmD,IAAI8W,EAAG,GAAKwB,EAAW,GAAI,GACvE,IACT,EAAK1B,OAAO,EAAKA,OAAOnZ,OAAS,GAAK,GAAH,UAAQ2a,GAAI,CAAEtB,EAAIsB,EAAK,KAC1D,EAAKpB,UAAU,EAAKJ,cAItB,EAAKA,OAAO,EAAKA,OAAOnZ,OAAS,GAAK,CAACqZ,EAAGA,GAC1C,EAAKE,UAAU,EAAKJ,WAEvB,iBACM,WACL,EAAKnY,SACN,uBAEY,WAEX,OADU,EAAKyb,qBACJ,EAAI,EAAK/Q,SACrB,gBAEK,WACA,EAAKyN,OAAO,EAAKA,OAAOnZ,OAAS,GAAGA,OAAO,EAC7C,EAAKmZ,OAAO,EAAKA,OAAOnZ,OAAS,GAAGgB,MAEhC,EAAKmY,OAAOnZ,OAAO,GACrB,EAAKmZ,OAAOnY,MAGhB,EAAKuY,UAAU,EAAKJ,WAErB,oBAES,WACR,EAAKA,OAAOlY,KAAK,OAClB,+BAKoB,WACnB,GAAI,EAAKkY,OAAO,EAAKA,OAAOnZ,OAAO,GAAGA,OAAS,EAC7C,OAAO0c,EAAAA,EAET,IAAM1C,EAAK5a,KAAKoX,IAAI,EAAK+F,SAAS,GAAK,EAAKpD,OAAO,EAAKA,OAAOnZ,OAAO,GAAG,GAAG,IACtEia,EAAK7a,KAAKoX,IAAI,EAAK+F,SAAS,GAAK,EAAKpD,OAAO,EAAKA,OAAOnZ,OAAO,GAAG,GAAG,IAE5E,OAAOZ,KAAKK,KAAKL,KAAKmD,IAAIyX,EAAI,GAAK5a,KAAKmD,IAAI0X,EAAI,IAAM,EAAKvO,SAC5D,oBAES,WACR,EAAKsB,MAAMnB,WAAWoF,YAAY,EAAKjE,OACvC,EAAK8N,aAAe,KACpB,EAAK9N,MAAQ,QACd,wBACa,WACZ,OAAO,IAAIzC,EAAU0I,GAAY,EAAKjG,MAAO,EAAK/B,IAAI2C,WAhKtD,EAAKuL,OAAS,GACd,EAAKA,OAAOlY,KAAK,CAAEsT,EAAQA,IAC3B,EAAKgI,SAAWhI,EAEhB,EAAKtJ,IAAMA,EACX,EAAKS,MAAQ,EAEb,EAAKsB,MAAQF,SAASC,gBAAgB1G,EAAe,KACrD,EAAKyU,aAAehO,SAASC,gBAAgB1G,EAAe,KAC5D,EAAKyU,aAAa9T,aAAa,QAAS,mDAExC,EAAKyQ,WAAa3K,SAASC,gBAAgB1G,EAAe,WAC1D,EAAKoR,WAAWzQ,aAAa,QAAS,kBAEtC,EAAKwV,YAAc,EAAKzL,WAAWwD,EAAO,GAAIA,EAAO,IACrD,EAAKiI,YAAY9S,MAAM4K,QAAU,OAEjC,EAAKjH,MAAQP,SAASC,gBAAgB1G,EAAe,QACrD,EAAKgH,MAAMrG,aAAa,QAAS,aAEjC,EAAKoG,MAAQN,SAASC,gBAAgB1G,EAAe,QACrD,EAAK+G,MAAMpG,aAAa,QAAS,aAEjC,EAAKuS,UAAU,EAAKJ,QAMpB,EAAK2B,aAAaxN,YAAY,EAAKmK,YACnC,EAAKqD,aAAaxN,YAAY,EAAKD,OACnC,EAAKyN,aAAaxN,YAAY,EAAKF,OACnC,EAAK0N,aAAaxN,YAAY,EAAKkP,aAInC,EAAKxP,MAAMtD,MAAM4K,QAAU,OAK3B,EAAKtH,MAAMM,YAAY,EAAKwN,cAE5B/P,EAAEuC,YAAY,EAAKN,OAAO,EAoG3B,SAnGA,yBAiGD,WACE,OAAO/M,KAAK6a,uFACb,EApJ8C,CAAShQ,GCqF7C6R,GAAiB,SAACnM,EAAO0K,GAQpC,IANA,IAIA0B,EAAGC,EAAGC,EAAGC,EAJL/d,EAAEkc,EAAQlb,OACdgd,GAAM,EACNjd,EAAEyQ,EAAM,GACRrE,EAAEqE,EAAM,GAGA9R,EAAE,EAAGA,EAAIM,EAAE,IAAKN,EACtBke,EAAG1B,EAAQxc,GAAG,GACdme,EAAG3B,EAAQxc,EAAE,GAAG,GAIbyN,GAHH2Q,EAAG5B,EAAQxc,GAAG,KAGDyN,GAFb4Q,EAAG7B,EAAQxc,EAAE,GAAG,KAEOqB,GAAK8c,EAAGD,IAAOzQ,EAAE2Q,IAAOC,EAAGD,GAAMF,IACpDI,GAAOA,GAGb,OAAOA,sxFCzGT,IAAMhC,GAAyB,SAAAE,GAC7B,IAAIC,EAASD,EAAQvU,MAAM,KACvByU,EAAY,GAmBhB,OAlBAD,EAAQzJ,SAAQ,SAAU2J,EAAQC,GAChC,GAAID,EAAOrb,OAAO,EAAE,CAClB,IAAIub,EAAS,IAKbF,GADAA,GADAA,GADAA,GADAA,EAAOA,EAAOxI,QAAQ,MAAM,MACdA,QAAQ,MAAM,MACdA,QAAQ,KAAK,KACbA,QAAQ,MAAM,MACdA,QAAQ,MAAM,MACFlM,MAAM,KACnB+K,SAAQ,SAASuF,EAAOqE,GACnCC,EAAOta,KAAK,CAACwM,WAAWwJ,EAAMtQ,MAAM,KAAK,IAAI6U,QAAQ,GAAG1W,WAAW2I,WAAWwJ,EAAMtQ,MAAM,KAAK,IAAI6U,QAAQ,GAAG1W,gBAE5GyW,EAAO,GAAG,KAAOA,EAAOA,EAAOvb,OAAS,GAAG,IAAMub,EAAO,GAAG,KAAOA,EAAOA,EAAOvb,OAAS,GAAG,IAC9Fub,EAAOta,KAAKsa,EAAO,IAErBH,EAAUna,KAAKsa,OAGZH,GAIH3B,GAAY,SAAC1G,GAGjB,IAEgC,EAD1BgI,EAAa,GAAG,KADHC,GAAuBjI,EAAMvF,cAAc,cAAciE,WAAW3R,EAAEmb,YAEzD,IAAhC,IAAK,EAAL,qBAAkC,KAEL,EAFpBvB,EAAS,QACZP,EAAS,GAAE,KACGO,GAAS,IAA3B,IAAK,EAAL,qBAA6B,KAApBlJ,EAAK,QACR3Q,EAAI,CACNE,EAAE0N,WAAW+C,EAAM,IACnBrE,EAAEsB,WAAW+C,EAAM,KAErB2I,EAAOlY,KAAKpB,IACb,8BACDkb,EAAW9Z,KAAKkY,IACjB,8BACD,OAAO4B,GAaHjI,GAAkB,SAAAhK,GACtB,IAAMiK,EAAQhB,GAAmBjJ,IARA,SAAAA,GACjC,IACIoS,EADanJ,GAAmBjJ,GACbrC,aAAa,KACnBuU,GAAuBE,GAOxCc,CAAoBlT,GAIpB,IAAMiC,EAAI+B,SAASC,gBAAgB1G,EAAe,KAE5C+G,EAAQ2F,EAAMC,WAAU,GAC9B5F,EAAMpG,aAAa,QAAS,aAE5B,IAAMqG,EAAQ0F,EAAMC,WAAU,GAK9B,OAJA3F,EAAMrG,aAAa,QAAS,aAE5B+D,EAAEuC,YAAYD,GACdtC,EAAEuC,YAAYF,GACPrC,GAGYkS,GAA0B,8sBAE7C,WAAYnU,EAAYiC,EAAGC,EAAQC,GAAK,8GACJ,MAAlC,cAAMnC,EAAYiC,EAAGC,EAAQC,IAAK,sBAgDf,SAAAc,GACnB,IAAMwB,EAAS,EAAKwD,WAAWhF,EAAGhM,EAAGgM,EAAGI,GAMxC,OALAoB,EAAOiB,iBAAiB,YAAa,EAAKwC,OAAOzD,IACjDA,EAAOiB,iBAAiB,QAAS,EAAK0O,eAAe3P,IACrD,EAAKgD,YAAYhD,GAEjB,EAAKuD,aAAaxD,YAAYC,GACvBA,KACR,2BAEgB,SAAC4P,EAASxB,GAEzB,IAAMyB,EAAaD,EAAQxB,GACrB0B,EAAa1B,IAAQwB,EAAQnd,OAAS,EAAImd,EAAQ,GAAKA,EAAQxB,EAAM,GACrE5b,GAAKqd,EAAWrd,EAAIsd,EAAWtd,GAAK,EACpCoM,GAAKiR,EAAWjR,EAAIkR,EAAWlR,GAAK,EACpCoB,EAAS,EAAK+P,aAAavd,EAAGoM,GAIpC,OAHAoB,EAAOiB,iBAAiB,YAAa,EAAKwC,OAAOzD,IAEjD,EAAKwF,MAAMzF,YAAYC,GAChBA,KACR,2BAEgB,WACfmN,QAAQrb,IAAI,mBACZ,IAAM8Z,EAASM,GAAU,EAAK1G,OAE1B,EAAKwK,SAASvd,OAAS,GAAI,WAC7B,IAIuC,EAJnCwd,GAAoB,EACpBtD,EAAgB,GAEhBuD,EAAe,GAAE,KACI,EAAKC,WAAS,IAAvC,IAAK,EAAL,qBAAwC,KAA/BC,EAAY,QACfC,EAAsBD,EAAaE,QAAO,SAACC,EAAQpf,GACrD,OAA2G,IAApG,EAAK6e,SAAShO,KAAI,SAAAuO,GAAM,OAAKA,EAAO,KAAON,GAAoBM,EAAO,KAAOpf,KAAI4B,SAAQ,MAE9Fyd,EAAoBJ,EAAaE,QAAO,SAACC,EAAQpf,GACnD,OAAO,EAAK6e,SAAShO,KAAI,SAAAuO,GAAM,OAAKA,EAAO,KAAON,GAAoBM,EAAO,KAAOpf,KAAI4B,SAAQ,IAAS,KAE3Gyd,EAAkBrM,SAAQ,SAAA3S,GAAC,OAAIA,EAAE8M,WAAWoF,YAAYlS,MACpD6e,EAAoB5d,OAAS,GAC/Byd,EAAaxc,KAAK2c,IAErB,kCAC2B,EAD3B,KACqBzE,GAAM,IAA5B,IAAK,EAAL,qBAA6B,KAApBO,EAAS,QAChB8D,GAAoB,EACpB,IAAIQ,EAAmBtE,EAAUmE,QAAO,SAACC,EAAQpf,GAC/C,OAA2G,IAApG,EAAK6e,SAAShO,KAAI,SAAAuO,GAAM,OAAKA,EAAO,KAAON,GAAoBM,EAAO,KAAOpf,KAAI4B,SAAQ,MAE9F0d,EAAiBhe,OAAS,GAC5Bka,EAAcjZ,KAAK+c,IAEtB,8BACDR,GAAoB,EACpB,IAC0C,EADtCS,EAAiB,GAAE,KACC,EAAKC,eAAa,IAA1C,IAAK,EAAL,qBAA2C,KAAlCC,EAAW,QAClBX,GAAoB,EACpB,IAAIY,EAAkBD,EAAYN,QAAO,SAACC,EAAQpf,GAChD,OAAwG,IAApG,EAAK6e,SAAShO,KAAI,SAAAuO,GAAM,OAAKA,EAAO,KAAON,GAAoBM,EAAO,KAAOpf,KAAI4B,SAAQ,MAM3F+d,EAAgBF,EAAYN,QAAO,SAACC,EAAQpf,GAC9C,OAA2G,IAApG,EAAK6e,SAAShO,KAAI,SAAAuO,GAAM,OAAKA,EAAO,KAAON,GAAoBM,EAAO,KAAOpf,KAAI4B,SAAQ,MAE9F+d,EAAcre,OAAS,GACzBie,EAAehd,KAAKod,GAEtBD,EAAgB1M,SAAQ,SAAA3S,GAAC,OAAIA,EAAE8M,WAAWoF,YAAYlS,OACvD,8BACD,EAAK2e,UAAYD,EAGjB,EAAKS,cAAgBD,EACrB,EAAKV,SAAW,GAEhB,EAAKhE,UAAUW,GAnDc,MAsDhC,4BAEiB,kBAChB,EAAKgE,cAAcxM,SAAQ,SAAA3S,GAAC,OAAIoI,EAAYpI,EAAG,kBAAY,oBAEnD,WACR,EAAK8R,UAAUhF,WAAWoF,YAAY,EAAKJ,WAE3C,EAAKxF,IAAIqD,oBAAoB,YAAa,EAAKiC,aAC/C,EAAKtF,IAAIqD,oBAAoB,UAAW,EAAKkC,WAE7C9D,SAASjD,KAAK6E,oBAAoB,UAAW,EAAK4P,WAElD,qDACD,yBAEc,SAACve,EAAGoM,GACjB,IAAMoB,EAAST,SAASC,gBAAgB1G,EAAe,UAOvD,OANAkH,EAAOvG,aAAa,QAAS,gBAE7BuG,EAAOvG,aAAa,KAAMjH,GAC1BwN,EAAOvG,aAAa,KAAMmF,GAC1BoB,EAAOvG,aAAa,IAAK,EAAI,EAAK0E,OAE3B6B,KACR,uBAMY,SAAAuJ,GACX,IAGuC,EAHjCqG,EAAU1D,GAAU,EAAK1G,OAC3B4I,GAAO,EACP4C,GAAgB,EAAC,KACI,EAAKb,WAAS,IAAvC,IAAK,EAAL,qBAAwC,KAA/BC,EAAY,QAGnB,GAFAY,GAAgB,GAChB5C,EAAMgC,EAAard,QAAQ,EAAKke,kBACrB,EACT,OAGJ,8BACA,IAI8B,EAJ1BC,EAAiB,GACjBC,GAAwB,EACxBC,EAAY,KACZC,EAAW,KAAI,KACIzB,GAAO,IAA9B,IAAK,EAAL,qBAA+B,KAAtB0B,EAAU,QAEjB,IADAH,GAAuB,KACMH,EAAa,CACxC,IAE6B,EAFzBO,EAAqB,GACrBC,GAAoB,EAAC,KACNF,GAAU,IAA7B,IAAK,EAAL,qBAA8B,KAArBG,EAAM,QACbD,GAAoB,EACpBD,EAAmB7d,KAAK+d,GACpBD,IAAqBpD,IACvBmD,EAAmB7d,KAAK6V,GACxB6H,EAAY,EAAKM,eAAeJ,EAAYE,EAAkB,GAC9DH,EAAW,EAAKK,eAAeJ,EAAYE,KAE9C,8BACDN,EAAexd,KAAK6d,QAEpBL,EAAexd,KAAK4d,IAKxB,8BACA,IAAMK,EAAe,EAAKC,mBAAmBrI,GAC7C,EAAKoH,cAAcK,GAAgB,GAAH,UAC3B,EAAKL,cAAcK,GAAc3c,MAAM,EAAG+Z,EAAI,IAAE,CACnDuD,GAAY,GACT,EAAKhB,cAAcK,GAAc3c,MAAM+Z,EAAI,KAEhD,EAAK+B,UAAUa,GAAgB,GAAH,UACvB,EAAKb,UAAUa,GAAc3c,MAAM,EAAG+Z,IAAI,CAC7CgD,EACAC,GAAQ,GACL,EAAKlB,UAAUa,GAAc3c,MAAM+Z,EAAM,KAG9C,EAAK6C,eAAe3S,WAAWoF,YAAY,EAAKuN,gBAGhD,EAAKA,eAAiBU,EAItB,EAAK3F,UAAUkF,MAChB,mBAEQ,SAAArN,GAAO,OAAI,SAAAtF,GACC,IAAfA,EAAI2C,SACR3C,EAAIsT,kBAEJ,EAAKZ,eAAiBpN,EACtB,EAAK2F,UAAY,EAAKzI,YAAYxC,GAClC,EAAKuT,eAAgB,IAAIC,MAAOC,eACjC,sBAEW,YACI,KADI,EAALC,OAEX,EAAKC,oBAER,wBAEa,SAAA3I,GACZ,IAQ2C,EARrCE,EAAY,SAACC,EAAO8C,EAAOra,GAAG,OAClCuX,EAAQ8C,EAAQ,GAAK9C,EAASA,EAAQ8C,EAAQra,EAAMA,EAAMuX,EAAQ8C,GACpE,EAAwC,EAAKhH,MA/QlCvF,cAAc,cAAcgI,UA+Q/BzV,EAAC,EAADA,EAAGoM,EAAC,EAADA,EAAGV,EAAK,EAALA,MAAO1K,EAAM,EAANA,OACrB,EAAwC,EAAKkK,IAAI2C,MAAzC6B,EAAY,EAAZA,aAAcC,EAAa,EAAbA,cAEhBsK,EAAKhD,EAAUjX,EAAG+W,EAAI/W,EAAI,EAAKgX,UAAUhX,EAAG0P,EAAehE,GAC3DwO,EAAKjD,EAAU7K,EAAG2K,EAAI3K,EAAI,EAAK4K,UAAU5K,EAAGuD,EAAgB3O,GAC9DmZ,EAAgB,GAAE,KACAT,GAAU,EAAK1G,QAAM,IAA3C,IAAK,EAAL,qBAA4C,KAAnC2M,EAAS,QACZC,EAAeD,EAAUnQ,KAAI,SAAAxD,GAAE,MAAK,CAAEA,EAAGhM,EAAIgM,EAAGI,MAChDwQ,GAAe,CAAC,EAAK5F,UAAUhX,EAAE,EAAKgX,UAAU5K,GAAIwT,GACtDzF,EAAcjZ,KAAKye,EAAUnQ,KAAI,SAAAxD,GAAE,MAChC,CAAEhM,EAAGgM,EAAGhM,EAAIia,EAAI7N,EAAGJ,EAAGI,EAAI8N,OAE7BC,EAAcjZ,KAAKye,IAEtB,8BACD,EAAK3I,UAAYD,EAGjB,EAAKyC,UAAUW,MAChB,+BAEoB,SAACpD,EAAKhL,GACzB,IAE2C,EAFvCqL,GAAa,EACbyI,EAAkB,EAAC,KACE,EAAK1B,eAAa,IAA3C,IAAK,EAAL,qBAA4C,KAAnCgB,EAAY,QAEnB,IADA/H,EAAY+H,EAAa5e,QAAQ,EAAKke,kBACrB,EACf,MAEAoB,GAAmB,GAIvB,8BACI9T,EAAIuQ,QACN,EAAKkB,SAAWhZ,MAAM0C,KAAK,IAAIP,IAAI,GAAD,UAAK,EAAK6W,UAAQ,CAAEpG,MAC5C,EAAKoG,SAASlO,SAAS8H,KACjC,EAAKoG,SAAW,CAAEpG,IAIpB,IAcwC,EAdlCgC,EAASM,GAAU,EAAK1G,OAExB8M,EAAY,EAAKtC,SAAShO,KAAI,SAAAoM,GAClC,IAAMmE,EAAW3G,EAAOyG,GAAiBzI,GACnC4I,EAAS5G,EAAOyG,GAAiBjE,GAEvC,MAAO,CACLL,MAAOK,EACP3B,GAAI+F,EAAOhgB,EAAI+f,EAAS/f,EACxBka,GAAI8F,EAAO5T,EAAI2T,EAAS3T,MAGxB6T,EAAwB,EACxB9F,EAAgB,GAAE,KACHT,GAAU,EAAK1G,QAAM,IAAxC,IAAK,EAAL,qBAAyC,KAAhCoG,EAAM,QACb,GAAI6G,IAA0BJ,EAAgB,CAC5C,IAAIK,EAAmB9G,EAAO5J,KAAI,SAACxD,EAAI4P,GACrC,GAAIA,IAAQxE,EAEV,OAAOL,EACF,GAAI,EAAKyG,SAASlO,SAASsM,GAAM,CACtC,MAAmBkE,EAAUvW,MAAK,SAAAxJ,GAAC,OAAIA,EAAEwb,QAAUK,KAA3C3B,EAAE,EAAFA,GAAIC,EAAE,EAAFA,GACZ,MAAO,CACLla,EAAG+W,EAAI/W,EAAIia,EACX7N,EAAG2K,EAAI3K,EAAI8N,GAIb,OAAOlO,KAGXmO,EAAcjZ,KAAKgf,QAEnB/F,EAAcjZ,KAAKkY,GAErB6G,GAAyB,GAC1B,8BACD,EAAKzG,UAAUW,MAChB,wBAEa,SAAApO,GACZ,GAAI,EAAK0S,eAAgB,CACvB,IAAM1H,EAAM,EAAKxI,YAAYxC,GACzB,EAAK0S,iBAAmB,EAAKzL,MAC/B,EAAKmN,YAAYpJ,GACRxP,EAAS,EAAKkX,eAAgB,cACvC,EAAK2B,mBAAmBrJ,EAAKhL,GACpBxE,EAAS,EAAKkX,eAAgB,iBACvC,EAAK4B,WAAWtJ,GAGlB,EAAKlT,KAAK,SAAUqP,GAAYwG,GAAU,EAAK1G,OAAQ,EAAK9H,IAAI2C,YAEnE,sBAEW,SAAA9B,GACV,EAAK0S,eAAiB,KACtB,EAAKzH,UAAY,QAClB,2BAEgB,SAAArL,GAAS,IACmB,EADnB,KACC,EAAKwS,eAAa,IAA3C,IAAK,EAAL,qBAAqB,QACN3O,IAAI,EAAKgB,aACvB,kCACmC,EADnC,KACqB,EAAKmN,WAAS,IAApC,IAAK,EAAL,qBAAkB,QACNnO,KAAI,SAAA8Q,GACZA,EAASrZ,aAAa,IAAK,EAAI,EAAK0E,UAEvC,kCACF,2BAEgB,SAAA6B,GAAM,OAAI,SAAAzB,GAGzB,MAFe,IAAIwT,MAAOC,UAAY,EAAKF,cAAgB,KAE9C,CACX,IAEsC,EAFlC7B,GAAoB,EACpB7B,GAAO,EAAC,KACQ,EAAKuC,eAAa,IAAtC,IAAK,EAAL,qBAAuC,KAA9Bf,EAAO,QAGd,GAFAK,GAAoB,GACpB7B,EAAMwB,EAAQ7c,QAAQiN,IACZ,EAAG,OACd,8BAEGzB,MAAAA,GAAAA,EAAKuQ,QAEF,EAAKkB,SAAShO,KAAI,SAAAuO,GAAM,OAAKA,EAAO,KAAON,GAAoBM,EAAO,KAAOnC,KAAMrb,SAAQ,IAAS,EACvG,EAAKid,SAAW,EAAKA,SAASM,QAAO,SAAAnf,GACnC,QAASA,EAAE,KAAOid,GAAOjd,EAAE,KAAO8e,MAGpC,EAAKD,SAAW,GAAH,UAAO,EAAKA,UAAQ,CAAE,CAACC,EAAkB7B,KAE3B,IAAzB,EAAK4B,SAASvd,QAAiB,EAAKud,SAAS,GAAG,KAAO5B,GAAO,EAAK4B,SAAS,GAAG,KAAOC,EACxF,EAAKD,SAAW,GAEhB,EAAKA,SAAW,CAAC,CAACC,EAAkB7B,IAIxC,EAAKpC,UAAUE,GAAU,EAAK1G,aAEjC,sBAEW,SAAAoG,GAGV,IAAMC,EAAMkH,GAAQnH,GACN,EAAKpG,MAAMvF,cAAc,cACjCxG,aAAa,IAAKoS,GAExB,IAAM/L,EAAQ,EAAK0F,MAAMvF,cAAc,cACvCH,EAAMrG,aAAa,IAAKoS,GAGxB,IAC4B,EADxBmH,EAAY,EAAC,KACKpH,GAAM,IAA5B,IAAK,EAAL,qBAA6B,KAApBO,EAAS,QAChBgB,QAAQrb,IAAI,sBAAuBqa,EAAWP,GAC9CO,EAAUhI,SAAQ,SAAC3F,EAAI4P,GACrB,EAAKjL,YAAY,EAAKwN,cAAcqC,GAAW5E,GAAM5P,EAAGhM,EAAGgM,EAAGI,MAGhE,IAAK,IAAIwP,EAAI,EAAGA,EAAIjC,EAAU1Z,OAAQ2b,IAAO,CAC3C,IAAMyB,EAAa1D,EAAUiC,GACvB0B,EAAa1B,IAAQjC,EAAU1Z,OAAS,EAAI0Z,EAAU,GAAKA,EAAUiC,EAAM,GAC3E5b,GAAKqd,EAAWrd,EAAIsd,EAAWtd,GAAK,EACpCoM,GAAKiR,EAAWjR,EAAIkR,EAAWlR,GAAK,EAEpCoB,EAAS,EAAKmQ,UAAU6C,GAAW5E,GACzCpO,EAAOvG,aAAa,KAAMjH,GAC1BwN,EAAOvG,aAAa,KAAMmF,GAE1BoU,GAAY,GACf,8BACD,IACsC,EADlCX,GAAmB,EAAC,KACJ,EAAK1B,eAAa,IAAtC,IAAK,EAAL,qBAAuC,KAA9Bf,EAAO,QACdyC,GAAmB,EAEnBzC,EAAQzL,SAAQ,SAACnE,EAAQ7O,GAEvB,IAAM8hB,EAAa,EAAKjD,SAAShO,KAAI,SAAAuO,GAAM,OAAKA,EAAO,KAAO8B,GAAmB9B,EAAO,KAAOpf,KAAI4B,SAAQ,IAAS,EAChHkgB,IAAelZ,EAASiG,EAAQ,kBAClC3G,EAAS2G,EAAQ,mBACPiT,GAAclZ,EAASiG,EAAQ,mBACzCpG,EAAYoG,EAAQ,sBAK1B,8BACA,MAAgCF,EAAMmI,UAA9BzV,EAAC,EAADA,EAAGoM,EAAC,EAADA,EAAGV,EAAK,EAALA,MAAO1K,EAAM,EAANA,OACrB4U,GAAmB,EAAK5C,MAAOhT,EAAGoM,EAAGV,EAAO1K,MAC7C,wBAEa,SAAA+H,GACZ,IAAMiK,EAAQD,GAAgBhK,GACxBqQ,EAASM,GAAU1G,GACzB,EAAKwG,UAAUJ,MAnbf,EAAK9N,IAAImD,iBAAiB,YAAa,EAAKmC,aAC5C,EAAKtF,IAAImD,iBAAiB,UAAW,EAAKoC,WAErC,EAAK9H,WAAWI,WAAsB,YACzCwR,QAAQrb,IAAI,YAAaigB,KAAKmB,OAC9B,EAAK3X,WAAWI,WAAsB,UAAIoW,KAAKmB,OAEjD3T,SAASjD,KAAK2E,iBAAiB,UAAW,EAAK8P,WAG/C,EAAKzN,UAAY/D,SAASC,gBAAgB1G,EAAe,KAGzD,EAAK0M,MAAQD,GAAgBhK,GAC7B,EAAKiK,MAAM/L,aAAa,QAAS,qDACjC,EAAK8J,aAAehE,SAASC,gBAAgB1G,EAAe,KAC5D,EAAKyK,aAAa9J,aAAa,QAAS,oCACxC,EAAK8J,aAAaxD,YAAY,EAAKyF,OACnC,IAAI8L,EAAapF,GAAU,EAAK1G,OAChC,EAAKmL,cAAgB,GACrB,EAAKR,UAAY,GAAE,IACW,EADX,KACCmB,GAAU,yBAArB1B,EAAO,QACVO,EAAY,GAChB,EAAKQ,cAAcjd,KAAKkc,EAAQ5N,KAAI,SAACxD,EAAI4P,GAGvC,OAFA+B,EAAUzc,KAAK,EAAKge,eAAe9B,EAASxB,IAC7B,EAAKwD,mBAAmBpT,OAGzC,EAAK2R,UAAUzc,KAAKyc,IAPtB,IAAK,EAAL,qBAA+B,IAQ9B,8BAeyB,OAd1B,EAAK7M,UAAUvD,YAAY,EAAKwD,cAChC/F,EAAEuC,YAAY,EAAKuD,WAEnBzB,GAAO,EAAK2D,MAAOjK,EAAYkC,EAAOsM,WACtC,EAAKvE,MAAMvF,cAAc,cACtBgB,iBAAiB,YAAa,EAAKwC,OAAO,EAAK+B,QAGlD,EAAKyL,eAAiB,KACtB,EAAKzH,UAAY,KAGjB,EAAKwG,SAAW,GAEhB,EAAK8B,cAAgB,KAAK,EAiH3B,SAhHA,yBA8GD,WACE,OAAOpf,KAAK6Q,uFACb,EAjK4C,CAAS9B,u+FC7ExD,IAGM0R,GAAO,uFAG4B,OAH5B,0BACX,YAAe,okBAAP3gB,EAAC,KAAEoM,EAAC,KAAK,MAAO,CAAC3L,KAAMT,EAAGU,KAAM0L,EAAGzL,KAAMX,EAAGY,KAAMwL,KAAK,yBAC/D,SAAYrN,EAAGsF,GAAK,OAAOtF,EAAEiB,EAAIqE,EAAErE,IAAI,yBACvC,SAAYjB,EAAGsF,GAAK,OAAOtF,EAAEqN,EAAI/H,EAAE+H,MAAI,EAH5B,CAASwU,MAOTL,IADGta,IACO,SAACmT,GACtB,IAE4B,EAFtBU,EAAQ,SAAAC,GAAG,OAAI1a,KAAKya,MAAM,GAAKC,GAAO,IACxC8G,EAAO,GAAE,KACSzH,GAAM,IAA5B,IAAK,EAAL,qBAA6B,KAApBO,EAAS,QAChBkH,GAAQ,IACR,IAC2B,EADvBlF,GAAQ,EAAI,KACEhC,GAAS,IAA3B,IAAK,EAAL,qBAA4B,KAAnBlJ,EAAK,QACRkL,GACFA,GAAQ,EACRkF,GAAQ/G,EAAMrJ,EAAMzQ,GAAG+E,WAAa,IAAM+U,EAAMrJ,EAAMrE,GAAGrH,YAEzD8b,GAAQ,KAAO/G,EAAMrJ,EAAMzQ,GAAG+E,WAAa,IAAM+U,EAAMrJ,EAAMrE,GAAGrH,YAEnE,8BACD8b,GAAQ,MACT,8BACD,OAAOA,IAEI3N,GAAc,SAACkG,EAAQvL,GAAK,MAAM,CAC7ClJ,OAAQkJ,MAAAA,OAAK,EAALA,EAAOqC,IACf5G,SAAU,CACRF,KAAM,cACNc,MAAO,iBAAF,OAAmBqW,GAAQnH,GAAO,iBAItB0H,GAAgC,gCAEnD,WAAY9V,EAAGC,EAAQC,GAAK,MAeO,OAfP,WACJ,MAAtB,cAAMF,EAAGC,EAAQC,IAAK,gBAoBT,SAAClL,EAAGoM,EAAGwC,EAAoB7C,EAAK4B,GAC7C,EAAK0M,YAAa,EAClBM,QAAQrb,IAAI,4BAA6BigB,KAAKmB,OAC9C,EAAKK,UAAYxB,KAAKmB,MACtB,EAAK/S,cAAgBA,EAInB,EAAKqT,oBAHFpS,IACwB,EAI7B,EAAKtD,IAAImD,iBAAiB,YAAa,EAAKwS,aAC5C,EAAKxJ,gBAAgB,CACnBrJ,UAAW,EAAKwC,YAChBvC,QAAS,EAAKwC,UACdvC,SAAU,EAAKgM,aAGjB,EAAK5C,WAAa,IAAI6E,GAA6B,CAAEvc,EAAGoM,GAAK,EAAKpB,EAAG,EAAKC,OAAQ,EAAKC,KACvF,EAAKwM,WAAWvU,GAAG,SAAS,YAA0B,IAAvB6P,EAAK,EAALA,MAAOkO,EAAS,EAATA,UACpClO,EAAMjK,WAAamY,EACnB,EAAKrd,KAAK,WAAYmP,GACtB,EAAKmF,aAER,iBAEM,WACL,EAAKN,kBAEL,EAAKwC,YAAa,EAEd,EAAK3C,aACP,EAAKA,WAAWC,UAChB,EAAKD,WAAa,SAErB,iBACM,WACD,EAAKA,YACP,EAAKA,WAAWyE,UAGnB,oBAGS,WACJ,EAAKzE,YACP,EAAKA,WAAW0E,aAGnB,wBAEa,SAACpc,EAAGoM,EAAGL,GACnB,EAAK2L,WAAWE,OAAO,CAAE5X,EAAGoM,OAgC7B,sBAMW,SAACpM,EAAGoM,EAAGL,GACjB,GAAIA,EAAIsQ,OACN,EAAK8E,cAAcpV,QACd,GAAIA,EAAIuQ,QACb,EAAK5E,WAAWyE,YACX,GAAIpQ,EAAIqV,SACb,EAAKhF,cACD,CACJ,MAA0B,EAAK1E,WAAWnM,wBAAlCG,EAAK,EAALA,MAAO1K,EAAM,EAANA,OAET8W,EAAW,EAAK7M,OAAO8M,mBAAqB,EAC5CC,EAAY,EAAK/M,OAAOgN,oBAAsB,EAChDvM,GAASoM,GAAY9W,GAAUgX,EACjC,EAAKN,WAAW6B,SAAS,CAAEvZ,EAAGoM,KAE9B,EAAKvI,KAAK,UACV,EAAKsU,YAGV,2BACgB,SAAAxM,GAEX,EAAK+L,YACP,EAAKA,WAAW9L,eAAeD,MAClC,0BACe,SAAC3L,EAAGoM,GAClB,EAAKiO,YAAa,EAClB,EAAK3C,WAAW6B,SAAS,CAAEvZ,EAAGoM,IAE9B,IAAM4G,EAAQ,EAAK0E,WAAWrG,QAC9B2B,EAAMjK,WAAa,EAAK2O,WAAWQ,cACnClF,EAAMjK,WAAWI,WAAsB,UAAI,EAAK4X,UAChD,EAAKld,KAAK,WAAYmP,GAEtB,EAAKmF,UACN,uBAEY,SAACnY,EAAGoM,OAChB,gCAEqB,SAAArD,GAAU,OAC9B,IAAImU,GAA2BnU,EAAY,EAAKiC,EAAG,EAAKC,OAAQ,EAAKC,QArJrE,EAAKmP,YAAa,EAClB,EAAK0G,WAAa,EAClB,EAAKM,kBAAoB,KACzB,EAAK1T,cAAgB,GACrB,EAAK2T,mBAAqB,IAAIX,GAC9B,EAAKY,OAAS,KACdrb,OAAOuI,iBAAiB,WAAW,SAAA1C,GACjB,MAAZA,EAAI9G,KAAe8G,EAAIuQ,QACzB,EAAKH,OACgB,MAAZpQ,EAAI9G,KAA2B,MAAZ8G,EAAI9G,KAChC,EAAKmX,aAGT,EAAK4E,qBAAsB,EAAM,EA6FlC,OA5FA,2BACD,WACE,OAAO9gB,KAAKma,aACb,8BAsFD,SAAiB1M,EAAe4T,GAC9BrhB,KAAKmhB,kBAAoB1T,EACzBzN,KAAKqhB,OAASA,MACf,EA9GkD,CAASpT,GA6J9D2S,GAAiCxP,WAAa,qBAE9CwP,GAAiC9R,SAAW,SAAAjG,GAAc,MAClDO,EAAWP,EAAWO,SAAS,eACrC,GAAIA,EACF,OAAqB,QAArB,EAAOA,EAASY,aAAK,aAAd,EAAgBkO,MAAM,qBCrMjC,IAAMoJ,GAAY,IAAI7a,IAAI,CACxB,QACA,SACA,UACA,WAEA,uBA2BF,SAxBqB,SAAC8a,EAAMxW,GAG1B,IAAMyW,EAAWzW,MAAAA,GAAAA,EAAQ0W,MACvB,IAAIhb,IAAIsE,EAAO0W,MAAMnS,KAAI,SAAA5Q,GAAC,OAAIA,EAAE8J,kBAAkB8Y,GAChDE,EAASla,IAAI,WACfia,EAAKG,eAAepK,IAElBkK,EAASla,IAAI,UACfia,EAAKG,eAAezQ,IAElBuQ,EAASla,IAAI,YACfia,EAAKG,eAAe1I,IAElBwI,EAASla,IAAI,aACfia,EAAKG,eAAexH,IAClBsH,EAASla,IAAI,uBACfia,EAAKG,eAAed,IAElBY,EAASla,IAAI,iBACjBia,EAAKG,eAAed","sources":["webpack://Annotorious.SelectorPack/webpack/universalModuleDefinition","webpack://Annotorious.SelectorPack/./node_modules/rbush/rbush.min.js","webpack://Annotorious.SelectorPack/../annotorious/node_modules/tiny-emitter/index.js","webpack://Annotorious.SelectorPack/../recogito-client-core/node_modules/fast-deep-equal/index.js","webpack://Annotorious.SelectorPack/webpack/bootstrap","webpack://Annotorious.SelectorPack/webpack/runtime/compat get default export","webpack://Annotorious.SelectorPack/webpack/runtime/define property getters","webpack://Annotorious.SelectorPack/webpack/runtime/hasOwnProperty shorthand","webpack://Annotorious.SelectorPack/../recogito-client-core/node_modules/uuid/dist/esm-browser/rng.js","webpack://Annotorious.SelectorPack/../annotorious/src/util/Touch.js","webpack://Annotorious.SelectorPack/../annotorious/src/util/SVG.js","webpack://Annotorious.SelectorPack/../recogito-client-core/node_modules/uuid/dist/esm-browser/regex.js","webpack://Annotorious.SelectorPack/../recogito-client-core/node_modules/uuid/dist/esm-browser/validate.js","webpack://Annotorious.SelectorPack/../recogito-client-core/node_modules/uuid/dist/esm-browser/stringify.js","webpack://Annotorious.SelectorPack/../recogito-client-core/node_modules/uuid/dist/esm-browser/v4.js","webpack://Annotorious.SelectorPack/../recogito-client-core/src/WebAnnotation.js","webpack://Annotorious.SelectorPack/../recogito-client-core/src/Selection.js","webpack://Annotorious.SelectorPack/../annotorious/src/tools/Tool.js","webpack://Annotorious.SelectorPack/../annotorious/src/tools/EditableShape.js","webpack://Annotorious.SelectorPack/../annotorious/src/selectors/RectFragment.js","webpack://Annotorious.SelectorPack/./src/point/Point.js","webpack://Annotorious.SelectorPack/./src/point/EditablePoint.js","webpack://Annotorious.SelectorPack/./src/point/PointTool.js","webpack://Annotorious.SelectorPack/../annotorious/src/selectors/EmbeddedSVG.js","webpack://Annotorious.SelectorPack/./src/circle/Circle.js","webpack://Annotorious.SelectorPack/./src/circle/CircleMask.js","webpack://Annotorious.SelectorPack/./src/circle/RubberbandCircle.js","webpack://Annotorious.SelectorPack/../annotorious/src/util/Formatting.js","webpack://Annotorious.SelectorPack/./src/circle/EditableCircle.js","webpack://Annotorious.SelectorPack/./src/circle/RubberbandCircleTool.js","webpack://Annotorious.SelectorPack/./src/ellipse/Ellipse.js","webpack://Annotorious.SelectorPack/./src/ellipse/EllipseMask.js","webpack://Annotorious.SelectorPack/./src/ellipse/RubberbandEllipse.js","webpack://Annotorious.SelectorPack/./src/ellipse/EditableEllipse.js","webpack://Annotorious.SelectorPack/./src/ellipse/RubberbandEllipseTool.js","webpack://Annotorious.SelectorPack/./src/freehand/RubberbandFreehand.js","webpack://Annotorious.SelectorPack/./src/freehand/EditableFreehand.js","webpack://Annotorious.SelectorPack/./src/freehand/RubberbandFreehandTool.js","webpack://Annotorious.SelectorPack/./src/multipolygon/RubberbandMultipolygon.js","webpack://Annotorious.SelectorPack/./src/multipolygon/EditableMultipolygon.js","webpack://Annotorious.SelectorPack/./src/multipolygon/RubberbandMultipolygonTool.js","webpack://Annotorious.SelectorPack/./src/betterMultipolygon/RubberbandBetterMultipolygon.js","webpack://Annotorious.SelectorPack/../annotorious/src/util/Geom2D.js","webpack://Annotorious.SelectorPack/./src/betterMultipolygon/EditableBetterMultipolygon.js","webpack://Annotorious.SelectorPack/./src/betterMultipolygon/RubberbandBetterMultipolygonTool.js","webpack://Annotorious.SelectorPack/./src/index.js"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"Annotorious\"] = factory();\n\telse\n\t\troot[\"Annotorious\"] = root[\"Annotorious\"] || {}, root[\"Annotorious\"][\"SelectorPack\"] = factory();\n})(self, function() {\nreturn ","!function(t,i){\"object\"==typeof exports&&\"undefined\"!=typeof module?module.exports=i():\"function\"==typeof define&&define.amd?define(i):(t=t||self).RBush=i()}(this,function(){\"use strict\";function t(t,r,e,a,h){!function t(n,r,e,a,h){for(;a>e;){if(a-e>600){var o=a-e+1,s=r-e+1,l=Math.log(o),f=.5*Math.exp(2*l/3),u=.5*Math.sqrt(l*f*(o-f)/o)*(s-o/2<0?-1:1),m=Math.max(e,Math.floor(r-s*f/o+u)),c=Math.min(a,Math.floor(r+(o-s)*f/o+u));t(n,r,m,c,h)}var p=n[r],d=e,x=a;for(i(n,e,r),h(n[a],p)>0&&i(n,e,a);d<x;){for(i(n,d,x),d++,x--;h(n[d],p)<0;)d++;for(;h(n[x],p)>0;)x--}0===h(n[e],p)?i(n,e,x):i(n,++x,a),x<=r&&(e=x+1),r<=x&&(a=x-1)}}(t,r,e||0,a||t.length-1,h||n)}function i(t,i,n){var r=t[i];t[i]=t[n],t[n]=r}function n(t,i){return t<i?-1:t>i?1:0}var r=function(t){void 0===t&&(t=9),this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function e(t,i,n){if(!n)return i.indexOf(t);for(var r=0;r<i.length;r++)if(n(t,i[r]))return r;return-1}function a(t,i){h(t,0,t.children.length,i,t)}function h(t,i,n,r,e){e||(e=p(null)),e.minX=1/0,e.minY=1/0,e.maxX=-1/0,e.maxY=-1/0;for(var a=i;a<n;a++){var h=t.children[a];o(e,t.leaf?r(h):h)}return e}function o(t,i){return t.minX=Math.min(t.minX,i.minX),t.minY=Math.min(t.minY,i.minY),t.maxX=Math.max(t.maxX,i.maxX),t.maxY=Math.max(t.maxY,i.maxY),t}function s(t,i){return t.minX-i.minX}function l(t,i){return t.minY-i.minY}function f(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function u(t){return t.maxX-t.minX+(t.maxY-t.minY)}function m(t,i){return t.minX<=i.minX&&t.minY<=i.minY&&i.maxX<=t.maxX&&i.maxY<=t.maxY}function c(t,i){return i.minX<=t.maxX&&i.minY<=t.maxY&&i.maxX>=t.minX&&i.maxY>=t.minY}function p(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function d(i,n,r,e,a){for(var h=[n,r];h.length;)if(!((r=h.pop())-(n=h.pop())<=e)){var o=n+Math.ceil((r-n)/e/2)*e;t(i,o,n,r,a),h.push(n,o,o,r)}}return r.prototype.all=function(){return this._all(this.data,[])},r.prototype.search=function(t){var i=this.data,n=[];if(!c(t,i))return n;for(var r=this.toBBox,e=[];i;){for(var a=0;a<i.children.length;a++){var h=i.children[a],o=i.leaf?r(h):h;c(t,o)&&(i.leaf?n.push(h):m(t,o)?this._all(h,n):e.push(h))}i=e.pop()}return n},r.prototype.collides=function(t){var i=this.data;if(!c(t,i))return!1;for(var n=[];i;){for(var r=0;r<i.children.length;r++){var e=i.children[r],a=i.leaf?this.toBBox(e):e;if(c(t,a)){if(i.leaf||m(t,a))return!0;n.push(e)}}i=n.pop()}return!1},r.prototype.load=function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var i=0;i<t.length;i++)this.insert(t[i]);return this}var n=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var r=this.data;this.data=n,n=r}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},r.prototype.insert=function(t){return t&&this._insert(t,this.data.height-1),this},r.prototype.clear=function(){return this.data=p([]),this},r.prototype.remove=function(t,i){if(!t)return this;for(var n,r,a,h=this.data,o=this.toBBox(t),s=[],l=[];h||s.length;){if(h||(h=s.pop(),r=s[s.length-1],n=l.pop(),a=!0),h.leaf){var f=e(t,h.children,i);if(-1!==f)return h.children.splice(f,1),s.push(h),this._condense(s),this}a||h.leaf||!m(h,o)?r?(n++,h=r.children[n],a=!1):h=null:(s.push(h),l.push(n),n=0,r=h,h=h.children[0])}return this},r.prototype.toBBox=function(t){return t},r.prototype.compareMinX=function(t,i){return t.minX-i.minX},r.prototype.compareMinY=function(t,i){return t.minY-i.minY},r.prototype.toJSON=function(){return this.data},r.prototype.fromJSON=function(t){return this.data=t,this},r.prototype._all=function(t,i){for(var n=[];t;)t.leaf?i.push.apply(i,t.children):n.push.apply(n,t.children),t=n.pop();return i},r.prototype._build=function(t,i,n,r){var e,h=n-i+1,o=this._maxEntries;if(h<=o)return a(e=p(t.slice(i,n+1)),this.toBBox),e;r||(r=Math.ceil(Math.log(h)/Math.log(o)),o=Math.ceil(h/Math.pow(o,r-1))),(e=p([])).leaf=!1,e.height=r;var s=Math.ceil(h/o),l=s*Math.ceil(Math.sqrt(o));d(t,i,n,l,this.compareMinX);for(var f=i;f<=n;f+=l){var u=Math.min(f+l-1,n);d(t,f,u,s,this.compareMinY);for(var m=f;m<=u;m+=s){var c=Math.min(m+s-1,u);e.children.push(this._build(t,m,c,r-1))}}return a(e,this.toBBox),e},r.prototype._chooseSubtree=function(t,i,n,r){for(;r.push(i),!i.leaf&&r.length-1!==n;){for(var e=1/0,a=1/0,h=void 0,o=0;o<i.children.length;o++){var s=i.children[o],l=f(s),u=(m=t,c=s,(Math.max(c.maxX,m.maxX)-Math.min(c.minX,m.minX))*(Math.max(c.maxY,m.maxY)-Math.min(c.minY,m.minY))-l);u<a?(a=u,e=l<e?l:e,h=s):u===a&&l<e&&(e=l,h=s)}i=h||i.children[0]}var m,c;return i},r.prototype._insert=function(t,i,n){var r=n?t:this.toBBox(t),e=[],a=this._chooseSubtree(r,this.data,i,e);for(a.children.push(t),o(a,r);i>=0&&e[i].children.length>this._maxEntries;)this._split(e,i),i--;this._adjustParentBBoxes(r,e,i)},r.prototype._split=function(t,i){var n=t[i],r=n.children.length,e=this._minEntries;this._chooseSplitAxis(n,e,r);var h=this._chooseSplitIndex(n,e,r),o=p(n.children.splice(h,n.children.length-h));o.height=n.height,o.leaf=n.leaf,a(n,this.toBBox),a(o,this.toBBox),i?t[i-1].children.push(o):this._splitRoot(n,o)},r.prototype._splitRoot=function(t,i){this.data=p([t,i]),this.data.height=t.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},r.prototype._chooseSplitIndex=function(t,i,n){for(var r,e,a,o,s,l,u,m=1/0,c=1/0,p=i;p<=n-i;p++){var d=h(t,0,p,this.toBBox),x=h(t,p,n,this.toBBox),v=(e=d,a=x,o=void 0,s=void 0,l=void 0,u=void 0,o=Math.max(e.minX,a.minX),s=Math.max(e.minY,a.minY),l=Math.min(e.maxX,a.maxX),u=Math.min(e.maxY,a.maxY),Math.max(0,l-o)*Math.max(0,u-s)),M=f(d)+f(x);v<m?(m=v,r=p,c=M<c?M:c):v===m&&M<c&&(c=M,r=p)}return r||n-i},r.prototype._chooseSplitAxis=function(t,i,n){var r=t.leaf?this.compareMinX:s,e=t.leaf?this.compareMinY:l;this._allDistMargin(t,i,n,r)<this._allDistMargin(t,i,n,e)&&t.children.sort(r)},r.prototype._allDistMargin=function(t,i,n,r){t.children.sort(r);for(var e=this.toBBox,a=h(t,0,i,e),s=h(t,n-i,n,e),l=u(a)+u(s),f=i;f<n-i;f++){var m=t.children[f];o(a,t.leaf?e(m):m),l+=u(a)}for(var c=n-i-1;c>=i;c--){var p=t.children[c];o(s,t.leaf?e(p):p),l+=u(s)}return l},r.prototype._adjustParentBBoxes=function(t,i,n){for(var r=n;r>=0;r--)o(i[r],t)},r.prototype._condense=function(t){for(var i=t.length-1,n=void 0;i>=0;i--)0===t[i].children.length?i>0?(n=t[i-1].children).splice(n.indexOf(t[i]),1):this.clear():a(t[i],this.toBBox)},r});\n","function E () {\n  // Keep this empty so it's easier to inherit from\n  // (via https://github.com/lipsmack from https://github.com/scottcorgan/tiny-emitter/issues/3)\n}\n\nE.prototype = {\n  on: function (name, callback, ctx) {\n    var e = this.e || (this.e = {});\n\n    (e[name] || (e[name] = [])).push({\n      fn: callback,\n      ctx: ctx\n    });\n\n    return this;\n  },\n\n  once: function (name, callback, ctx) {\n    var self = this;\n    function listener () {\n      self.off(name, listener);\n      callback.apply(ctx, arguments);\n    };\n\n    listener._ = callback\n    return this.on(name, listener, ctx);\n  },\n\n  emit: function (name) {\n    var data = [].slice.call(arguments, 1);\n    var evtArr = ((this.e || (this.e = {}))[name] || []).slice();\n    var i = 0;\n    var len = evtArr.length;\n\n    for (i; i < len; i++) {\n      evtArr[i].fn.apply(evtArr[i].ctx, data);\n    }\n\n    return this;\n  },\n\n  off: function (name, callback) {\n    var e = this.e || (this.e = {});\n    var evts = e[name];\n    var liveEvents = [];\n\n    if (evts && callback) {\n      for (var i = 0, len = evts.length; i < len; i++) {\n        if (evts[i].fn !== callback && evts[i].fn._ !== callback)\n          liveEvents.push(evts[i]);\n      }\n    }\n\n    // Remove event from queue to prevent memory leak\n    // Suggested by https://github.com/lazd\n    // Ref: https://github.com/scottcorgan/tiny-emitter/commit/c6ebfaa9bc973b33d110a84a307742b7cf94c953#commitcomment-5024910\n\n    (liveEvents.length)\n      ? e[name] = liveEvents\n      : delete e[name];\n\n    return this;\n  }\n};\n\nmodule.exports = E;\nmodule.exports.TinyEmitter = E;\n","'use strict';\n\n// do not edit .js files directly - edit src/index.jst\n\n\n\nmodule.exports = function equal(a, b) {\n  if (a === b) return true;\n\n  if (a && b && typeof a == 'object' && typeof b == 'object') {\n    if (a.constructor !== b.constructor) return false;\n\n    var length, i, keys;\n    if (Array.isArray(a)) {\n      length = a.length;\n      if (length != b.length) return false;\n      for (i = length; i-- !== 0;)\n        if (!equal(a[i], b[i])) return false;\n      return true;\n    }\n\n\n\n    if (a.constructor === RegExp) return a.source === b.source && a.flags === b.flags;\n    if (a.valueOf !== Object.prototype.valueOf) return a.valueOf() === b.valueOf();\n    if (a.toString !== Object.prototype.toString) return a.toString() === b.toString();\n\n    keys = Object.keys(a);\n    length = keys.length;\n    if (length !== Object.keys(b).length) return false;\n\n    for (i = length; i-- !== 0;)\n      if (!Object.prototype.hasOwnProperty.call(b, keys[i])) return false;\n\n    for (i = length; i-- !== 0;) {\n      var key = keys[i];\n\n      if (!equal(a[key], b[key])) return false;\n    }\n\n    return true;\n  }\n\n  // true if both NaN, false otherwise\n  return a!==a && b!==b;\n};\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// Unique ID creation requires a high quality random # generator. In the browser we therefore\n// require the crypto API and do not support built-in fallback to lower quality random number\n// generators (like Math.random()).\nvar getRandomValues;\nvar rnds8 = new Uint8Array(16);\nexport default function rng() {\n  // lazy load so that environments that need to polyfill have a chance to do so\n  if (!getRandomValues) {\n    // getRandomValues needs to be invoked in a context where \"this\" is a Crypto implementation. Also,\n    // find the complete implementation of crypto (msCrypto) on IE11.\n    getRandomValues = typeof crypto !== 'undefined' && crypto.getRandomValues && crypto.getRandomValues.bind(crypto) || typeof msCrypto !== 'undefined' && typeof msCrypto.getRandomValues === 'function' && msCrypto.getRandomValues.bind(msCrypto);\n\n    if (!getRandomValues) {\n      throw new Error('crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported');\n    }\n  }\n\n  return getRandomValues(rnds8);\n}","const SIM_EVENTS = {\n  touchstart: 'mousedown',\n  touchmove: 'mousemove',\n  touchend: 'mouseup'\n}\n\nexport const isTouchDevice = () =>\n  'ontouchstart' in window ||\n    navigator.maxTouchPoints > 0 ||\n      navigator.msMaxTouchPoints > 0;\n\nexport const enableTouchTranslation = el => {\n\n  let pressAndHoldTrigger = null;\n\n  const simulateEvent = (type, e) => new MouseEvent(type, {\n    screenX: e.screenX,\n    screenY: e.screenY,\n    clientX: e.clientX,\n    clientY: e.clientY,\n    pageX: e.pageX,\n    pageY: e.pageY,\n    bubbles: true\n  });\n\n  const touchHandler = evt => {\n    const touch = evt.changedTouches[0];\n    const simulatedEvent = simulateEvent(SIM_EVENTS[evt.type], touch);\n\n    touch.target.dispatchEvent(simulatedEvent);\n    evt.preventDefault();\n\n    if (evt.type === 'touchstart' || evt.type === 'touchmove') {\n      pressAndHoldTrigger && clearTimeout(pressAndHoldTrigger);\n\n      pressAndHoldTrigger = setTimeout(() => {\n        const simulatedEvent = simulateEvent('dblclick', touch);\n        touch.target.dispatchEvent(simulatedEvent);\n      }, 800);\n    }\n\n    if (evt.type === 'touchend')\n      pressAndHoldTrigger && clearTimeout(pressAndHoldTrigger);\n  }\n\n  el.addEventListener('touchstart', touchHandler, true);\n  el.addEventListener('touchmove', touchHandler, true);\n  el.addEventListener('touchend', touchHandler, true);\n  el.addEventListener('touchcancel', touchHandler, true);\n\n}","export const SVG_NAMESPACE = 'http://www.w3.org/2000/svg';\n\nconst getClassNames = el => {\n  const attr = el.getAttribute('class');\n  return attr ? new Set(attr.split(' ')) : new Set();\n}\n\n// IE11 doesn't support adding/removing classes to SVG elements except \n// via .setAttribute\nexport const addClass = (el, className) => {\n  const classNames = getClassNames(el);\n  classNames.add(className);\n  el.setAttribute('class', Array.from(classNames).join(' '));\n}\n\nexport const removeClass = (el, className) => {\n  const classNames = getClassNames(el);\n  classNames.delete(className);\n\n  if (classNames.size === 0)\n    el.removeAttribute('class');\n  else\n    el.setAttribute('class', Array.from(classNames).join(' '));\n}\n\nexport const hasClass = (el, className) =>\n  getClassNames(el).has(className);","export default /^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;","import REGEX from './regex.js';\n\nfunction validate(uuid) {\n  return typeof uuid === 'string' && REGEX.test(uuid);\n}\n\nexport default validate;","import validate from './validate.js';\n/**\n * Convert array of 16 byte values to UUID string format of the form:\n * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\n */\n\nvar byteToHex = [];\n\nfor (var i = 0; i < 256; ++i) {\n  byteToHex.push((i + 0x100).toString(16).substr(1));\n}\n\nfunction stringify(arr) {\n  var offset = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;\n  // Note: Be careful editing this code!  It's been tuned for performance\n  // and works in ways you may not expect. See https://github.com/uuidjs/uuid/pull/434\n  var uuid = (byteToHex[arr[offset + 0]] + byteToHex[arr[offset + 1]] + byteToHex[arr[offset + 2]] + byteToHex[arr[offset + 3]] + '-' + byteToHex[arr[offset + 4]] + byteToHex[arr[offset + 5]] + '-' + byteToHex[arr[offset + 6]] + byteToHex[arr[offset + 7]] + '-' + byteToHex[arr[offset + 8]] + byteToHex[arr[offset + 9]] + '-' + byteToHex[arr[offset + 10]] + byteToHex[arr[offset + 11]] + byteToHex[arr[offset + 12]] + byteToHex[arr[offset + 13]] + byteToHex[arr[offset + 14]] + byteToHex[arr[offset + 15]]).toLowerCase(); // Consistency check for valid UUID.  If this throws, it's likely due to one\n  // of the following:\n  // - One or more input array values don't map to a hex octet (leading to\n  // \"undefined\" in the uuid)\n  // - Invalid input values for the RFC `version` or `variant` fields\n\n  if (!validate(uuid)) {\n    throw TypeError('Stringified UUID is invalid');\n  }\n\n  return uuid;\n}\n\nexport default stringify;","import rng from './rng.js';\nimport stringify from './stringify.js';\n\nfunction v4(options, buf, offset) {\n  options = options || {};\n  var rnds = options.random || (options.rng || rng)(); // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`\n\n  rnds[6] = rnds[6] & 0x0f | 0x40;\n  rnds[8] = rnds[8] & 0x3f | 0x80; // Copy bytes to buffer, if provided\n\n  if (buf) {\n    offset = offset || 0;\n\n    for (var i = 0; i < 16; ++i) {\n      buf[offset + i] = rnds[i];\n    }\n\n    return buf;\n  }\n\n  return stringify(rnds);\n}\n\nexport default v4;","import { v4 as uuid } from 'uuid';\nimport equals from 'fast-deep-equal';\n\nexport default class WebAnnotation {\n\n  constructor(annotation, opts) {\n    this.underlying = annotation;\n    this.opts = opts;\n  }\n\n  /** For convenience - creates an empty web annotation **/\n  static create = args => {\n    const stub = {\n      '@context': 'http://www.w3.org/ns/anno.jsonld',\n      'type': 'Annotation',\n      'id': `#${uuid()}`,\n      'body': []\n    };\n\n    return new WebAnnotation({ ...stub, ...args });\n  }\n\n  /** Creates a copy of this annotation **/\n  clone = (opt_props, opt_opts) => {\n    return new WebAnnotation({ ...this.underlying, ...opt_props}, { ...this.opts, ...opt_opts });\n  }\n\n  /** An equality check based on the underlying object **/\n  isEqual(other) {\n    if (other?.type !== 'Annotation') {\n      return false;\n    } else if (this.underlying === other.underlying) {\n      return true;\n    } else if (!this.underlying.id || !other.underlying.id) {\n      return false;\n    } else {\n      return equals(this.underlying, other.underlying);\n    }\n  }\n  getStyle(){\n    return this.opts?.style;\n  }\n  get readOnly() {\n    return this.opts?.readOnly;\n  }\n\n  /*************************************/ \n  /* Getters to forward properties of  */\n  /* the underlying annotation         */\n  /*************************************/\n\n  get id() {\n    return this.underlying.id; \n  }\n\n  get type() {\n    return this.underlying.type;\n  }\n\n  get motivation() {\n    return this.underlying.motivation;\n  }\n\n  get body() {\n    return this.underlying.body;\n  }\n\n  get target() {\n    return this.underlying.target;\n  }\n\n  /** Same as .body, but guaranteed to return an array **/\n  get bodies() {\n    return (Array.isArray(this.underlying.body)) ?\n      this.underlying.body : [ this.underlying.body ];\n  }\n\n  setState(state){\n    for (const [key, value] of Object.entries(state)){\n      this.opts[key] = value;\n    }\n  }\n\n  /** Only bodies are meant to be mutated by the application **/\n  set bodies(bodies) {\n    this.underlying.body = bodies;\n  }\n\n  /** Same as .target, but guaranteed to return an array **/\n  get targets() {\n    return (Array.isArray(this.underlying.target)) ?\n      this.underlying.target : [ this.underlying.target ];\n  }\n  \n  /*****************************************/ \n  /* Various access helpers and shorthands */\n  /*****************************************/\n\n  /** Selector of the given type **/\n  selector = type => {\n    const { target } = this.underlying;\n\n    if (target.selector) {\n      // Normalize to array\n      const selectors = Array.isArray(target.selector) ?\n        target.selector : [ target.selector ];\n\n      return selectors.find(s => s.type === type);\n    }\n  }\n\n  /** Shorthand for the 'exact' field of the TextQuoteSelector **/\n  get quote() {\n    return this.selector('TextQuoteSelector').exact;\n  }\n\n  /** Shorthand for the 'start' field of the TextPositionSelector **/\n  get start() {\n    return this.selector('TextPositionSelector').start;\n  }\n\n  /** Shorthand for the 'end' field of the TextPositionSelector **/\n  get end() {\n    return this.selector('TextPositionSelector').end;\n  }\n  \n}\n","import WebAnnotation from './WebAnnotation';\nimport { v4 as uuid } from 'uuid';\nimport equals from 'fast-deep-equal';\n\n/**\n * An \"annotation in draft mode\". Really the same\n * data structure, but as a separate class so we can\n * tell things apart properly.\n */\nexport default class Selection {\n\n  constructor(target, body) {\n    this.underlying = {\n      type: 'Selection',\n      body: body || [],\n      target\n    }\n  }\n\n  /** Creates a copy of this selection **/\n  clone = opt_props => {\n    // Deep-clone\n    const cloned = new Selection();\n    cloned.underlying = JSON.parse(JSON.stringify(this.underlying));  \n\n    if (opt_props)\n      cloned.underlying = { ...cloned.underlying, ...opt_props };\n\n    return cloned;\n  }\n\n  get type() {\n    return this.underlying.type;\n  }\n\n  get body() {\n    return this.underlying.body;\n  }\n\n  get target() {\n    return this.underlying.target;\n  }\n\n  get targets() {\n    return (Array.isArray(this.underlying.target)) ?\n      this.underlying.target : [ this.underlying.target ];\n  }\n\n  /** For consistency with WebAnnotation **/\n  isEqual(other) {\n    if (!other) {\n      return false;\n    } else {\n      return equals(this.underlying, other.underlying);\n    }\n  }\n  \n  get bodies() {\n    return (Array.isArray(this.underlying.body)) ?\n      this.underlying.body : [ this.underlying.body ];\n  }\n\n  selector = type => {\n    const { target } = this.underlying;\n\n    if (target.selector) {\n      // Normalize to array\n      const selectors = Array.isArray(target.selector) ?\n        target.selector : [ target.selector ];\n\n      return selectors.find(s => s.type === type);\n    }\n  }\n\n  /** Shorthand for the 'exact' field of the TextQuoteSelector **/\n  get quote() {\n    return this.selector('TextQuoteSelector').exact;\n  }\n\n  /*******************************************/ \n  /* Selection-specific properties & methods */\n  /*******************************************/\n\n  get isSelection() {\n    return true;\n  }\n\n  toAnnotation = () => {\n    const a = Object.assign({}, this.underlying, {\n      '@context': 'http://www.w3.org/ns/anno.jsonld',\n      'type': 'Annotation',\n      'id': `#${uuid()}`\n    });\n\n    return new WebAnnotation(a);\n  }\n\n}","import EventEmitter from 'tiny-emitter';\nimport { isTouchDevice } from '../util/Touch';\nimport { SVG_NAMESPACE } from '../util/SVG';\n\nconst IMPLEMENTATION_MISSING = \"An implementation is missing\";\n\nconst isTouch = isTouchDevice();\n\n/**\n * A commmon base class for Tools and EditableShapes\n */\nexport class ToolLike extends EventEmitter {\n\n  constructor(g, config, env) {\n    super();\n    this.contourPoints = []\n    this.svg = g.closest('svg');\n\n    this.g = g;\n    this.config = config;\n    this.env = env;\n\n    // Default image scale\n    this.scale = 1;\n\n    // Bit of a hack. If we are dealing with a 'real' image, we enable\n    // reponsive mode. OpenSeadragon handles scaling in a different way,\n    // so we don't need responsive mode.\n    const { image } = env;\n    if (image instanceof Element || image instanceof HTMLDocument)\n      this.enableResponsive();\n  }\n\n  /**\n   * Implementations MAY extend this (calling super),\n   * to destroy SVG elements, mask, etc.\n   */\n  destroy() {\n    if (this.resizeObserver)\n      this.resizeObserver.disconnect();\n\n    this.resizeObserver = null;\n  }\n\n  enableResponsive = () => {\n    if (window.ResizeObserver) {\n      this.resizeObserver = new ResizeObserver(() => {\n        const svgBounds = this.svg.getBoundingClientRect();\n        const { width, height } = this.svg.viewBox.baseVal;\n\n        this.scale = Math.max(\n          width / svgBounds.width,\n          height / svgBounds.height\n        );\n\n        if (this.onScaleChanged)\n          this.onScaleChanged(this.scale);\n      });\n\n      this.resizeObserver.observe(this.svg.parentNode);\n    }\n  }\n\n  getSVGPoint = evt => {\n    const pt = this.svg.createSVGPoint();\n\n    if (isTouch) {\n      const bbox = this.svg.getBoundingClientRect();\n\n      const x = evt.clientX - bbox.x;\n      const y = evt.clientY - bbox.y;\n\n      const { left, top } = this.svg.getBoundingClientRect();\n      pt.x = x + left;\n      pt.y = y + top;\n\n      return pt.matrixTransform(this.g.getScreenCTM().inverse());\n    } else {\n      pt.x = evt.offsetX;\n      pt.y = evt.offsetY;\n\n      return pt.matrixTransform(this.g.getCTM().inverse());\n    }\n  }\n\n  /*********************************/\n  /*  Helpers for drawing handles  */\n  /*********************************/\n\n  drawHandle = (x, y) => {\n    const containerGroup = document.createElementNS(SVG_NAMESPACE, 'g');\n    containerGroup.setAttribute('class', 'a9s-handle');\n\n    const group = document.createElementNS(SVG_NAMESPACE, 'g');\n\n    const drawCircle = r => {\n      const c = document.createElementNS(SVG_NAMESPACE, 'circle');\n      c.setAttribute('cx', x);\n      c.setAttribute('cy', y);\n      c.setAttribute('r', r);\n      return c;\n    }\n\n    const radius = this.config.handleRadius || 6;\n\n    const inner = drawCircle(radius);\n    inner.setAttribute('class', 'a9s-handle-inner')\n\n    const outer = drawCircle(radius + 1);\n    outer.setAttribute('class', 'a9s-handle-outer')\n\n    group.appendChild(outer);\n    group.appendChild(inner);\n\n    containerGroup.appendChild(group);\n    return containerGroup;\n  }\n\n  setHandleXY = (handle, x, y) => {\n    const inner = handle.querySelector('.a9s-handle-inner');\n    inner.setAttribute('cx', x);\n    inner.setAttribute('cy', y);\n\n    const outer = handle.querySelector('.a9s-handle-outer');\n    outer.setAttribute('cx', x);\n    outer.setAttribute('cy', y);\n  }\n\n  getHandleXY = handle => {\n    const outer = handle.querySelector('.a9s-handle-outer');\n    return {\n      x: parseFloat(outer.getAttribute('cx')),\n      y: parseFloat(outer.getAttribute('cy'))\n    }\n  }\n\n  scaleHandle = handle => {\n    const inner = handle.querySelector('.a9s-handle-inner');\n    const outer = handle.querySelector('.a9s-handle-outer');\n\n    const radius = this.scale * (this.config.handleRadius || 6);\n    inner.setAttribute('r', radius);\n    outer.setAttribute('r', radius);\n  }\n\n}\n\n/**\n * Base class that adds some convenience stuff for tool plugins.\n */\nexport default class Tool extends ToolLike {\n\n  constructor(g, config, env) {\n    super(g, config, env);\n    this.contourPoints = []\n    // We'll keep a flag set to false until\n    // the user has started moving, so we can\n    // fire the startSelection event\n    this.started = false;\n  }\n  setContourPoints(contourPoints){\n    this.contourPoints = contourPoints\n  }\n  attachListeners = ({ mouseMove, mouseUp, dblClick }) => {\n    // Handle SVG conversion on behalf of tool implementations\n    if (mouseMove) {\n      this.mouseMove = evt => {\n        const { x , y } = this.getSVGPoint(evt);\n\n        if (!this.started) {\n          this.emit('startSelection', { x, y });\n          this.started = true;\n        }\n\n        mouseMove(x, y, evt);\n      }\n\n      // Mouse move goes on SVG element\n      this.svg.addEventListener('mousemove', this.mouseMove);\n    }\n\n    if (mouseUp) {\n      this.mouseUp = evt => {\n        if (evt.button !== 0) return;  // left click\n        const { x , y } = this.getSVGPoint(evt);\n        mouseUp(x, y, evt);\n      }\n\n      // Mouse up goes on doc, so we capture events outside, too\n      document.addEventListener('mouseup', this.mouseUp);\n    }\n\n    if (dblClick) {\n      this.dblClick = evt => {\n        const { x , y } = this.getSVGPoint(evt);\n        dblClick(x, y, evt);\n      }\n\n      document.addEventListener('dblclick', this.dblClick);\n    }\n\n  }\n\n  detachListeners = () => {\n    if (this.mouseMove)\n      this.svg.removeEventListener('mousemove', this.mouseMove);\n\n    if (this.mouseUp)\n      document.removeEventListener('mouseup', this.mouseUp);\n\n    if (this.dblClick)\n      document.removeEventListener('dblclick', this.dblClick);\n  }\n\n  /**\n   * If startOnSingleClick is true, the tool starts on single click\n   * as well as drag. If false, starting strictly requires drag!\n   */\n  start = (evt, startOnSingleClick, contourpoints) => {\n    // Handle SVG conversion on behalf of tool implementations\n    const { x , y } = this.getSVGPoint(evt);\n    this.startDrawing(x, y, startOnSingleClick, evt, contourpoints);\n  }\n\n  /**\n   * Tool implementations MUST override these\n   */\n\n  get isDrawing() {\n    throw new Error(IMPLEMENTATION_MISSING);\n  }\n\n  startDrawing = evt => {\n    throw new Error(IMPLEMENTATION_MISSING);\n  }\n\n  createEditableShape = (annotation, formatters) => {\n    throw new Error(IMPLEMENTATION_MISSING);\n  }\n\n}\n\n// In addition, Tool implementations need to implement the following static methods\n\n// Tool.identifier = '...'\n\nTool.supports = annotation => {\n  throw new Error(IMPLEMENTATION_MISSING);\n}\n\n// Just some convenience shortcuts to client-core, for quicker\n// importing in plugins. (In a way, the intention is to make the\n// Tool class serve as a kind of mini-SDK).\nexport { default as Selection } from '@recogito/recogito-client-core/src/Selection';\nexport { default as WebAnnotation } from '@recogito/recogito-client-core/src/WebAnnotation';\n","import { ToolLike } from './Tool';\n\nconst IMPLEMENTATION_MISSING = \"An implementation is missing\";\n\nexport default class EditableShape extends ToolLike {\n\n  constructor(annotation, g, config, env) {\n    super(g, config, env);\n\n    this.annotation = annotation;\n  }\n  \n  /**\n   * Implementations MUST override this method!\n   * \n   * Must return the 'g' element with the a9s-annotation class.\n   */\n  get element() {\n    throw new Error(IMPLEMENTATION_MISSING);\n  }\n\n  /**\n   * Implementations MUST override this method!\n   * \n   * The annotation argument MUST be used to update\n   * the current state of the shape. It MUST NOT\n   * be stored as 'this.annotation'! 'this.annotation'\n   * MUST remain the original annotation at the time\n   * this EditableShape was created, because we will\n   * need it again in case the user cancels editing.\n   * \n   * Thinking of it in React terms, 'this.annotation'\n   * has the same purpose as props.annotation, whereas\n   * this method affects state.\n   */\n  updateState = annotation => {\n    throw new Error(IMPLEMENTATION_MISSING);\n  }\n\n}\n","import { SVG_NAMESPACE, addClass } from '../util/SVG';\n\n/** \n * Parses a W3C Web Annotation FragmentSelector conforming\n * to the Media Fragments spec. Supports (well-formed) xywh=pixel\n * and xywh=percent fragments. \n */\nexport const parseRectFragment = (annotation, image) => {\n  const selector = annotation.selector('FragmentSelector');\n\n  if (selector?.conformsTo.startsWith('http://www.w3.org/TR/media-frags')) {\n    const { value } = selector;\n  \n    const format = value.includes(':') ? value.substring(value.indexOf('=') + 1, value.indexOf(':')) : 'pixel';\n    const coords = value.includes(':') ? value.substring(value.indexOf(':') + 1) : value.substring(value.indexOf('=') + 1);\n\n    let [ x, y, w, h ] = coords.split(',').map(parseFloat);\n\n    if (format.toLowerCase() === 'percent') {\n      x = x * image.naturalWidth  / 100;\n      y = y * image.naturalHeight / 100;\n      w = w * image.naturalWidth  / 100;\n      h = h * image.naturalHeight / 100;\n    }\n\n    return { x, y, w, h };\n  }\n}\n\n/** \n * Serializes a (x, y, w, h)-tuple as Media Fragment selector\n * using pixel coordinates.\n */\nconst toPixelRectFragment = (x, y, w, h, image) => ({\n  source: image?.src,\n  selector: {\n    type: \"FragmentSelector\",\n    conformsTo: \"http://www.w3.org/TR/media-frags/\",\n    value: `xywh=pixel:${x},${y},${w},${h}`\n  }\n});\n\n/** \n * Serializes a (x, y, w, h)-tuple as Media Fragment selector \n * using percent coordinates.\n */\nconst toPercentRectFragment = (x, y, w, h, image) => {\n  const px = x / image.naturalWidth  * 100;\n  const py = y / image.naturalHeight * 100;\n  const pw = w / image.naturalWidth  * 100;\n  const ph = h / image.naturalHeight * 100;\n\n  return {\n    source: image.src,\n    selector: {\n      type: \"FragmentSelector\",\n      conformsTo: \"http://www.w3.org/TR/media-frags/\",\n      value: `xywh=percent:${px},${py},${pw},${ph}`\n    }\n  }\n}\n\nexport const toRectFragment = (x, y, w, h, image, fragmentUnit) =>\n  fragmentUnit?.toLowerCase() === 'percent' ?\n    toPercentRectFragment(x, y, w, h, image) :\n    toPixelRectFragment(x, y, w, h, image);\n\n/** Shorthand to apply the given (x, y, w, h) to the SVG shape **/\nconst setXYWH = (shape, x, y, w, h) => {\n  shape.setAttribute('x', x);\n  shape.setAttribute('y', y);\n  shape.setAttribute('width', w);\n  shape.setAttribute('height', h);\n}\n\n\nconst setPointXY = (shape, x, y) => {\n  shape.setAttribute('cx', x);\n  shape.setAttribute('cy', y);\n  shape.setAttribute('r', 7); // TODO make configurable\n}\n\nexport const drawRectMask = (imageDimensions, x, y, w, h) => {\n  const mask = document.createElementNS(SVG_NAMESPACE, 'path');\n  mask.setAttribute('fill-rule', 'evenodd');\n\n  const { naturalWidth, naturalHeight } = imageDimensions;\n  mask.setAttribute('d', `M0 0 h${naturalWidth} v${naturalHeight} h-${naturalWidth} z M${x} ${y} h${w} v${h} h-${w} z`);\n\n  return mask;\n}\n\nexport const setRectMaskSize = (mask, imageDimensions, x, y, w, h) => {\n  const { naturalWidth, naturalHeight } = imageDimensions;\n  mask.setAttribute('d', `M0 0 h${naturalWidth} v${naturalHeight} h-${naturalWidth} z M${x} ${y} h${w} v${h} h-${w} z`);\n}\n\n/** \n * Draws an SVG rectangle, either from an annotation, or an\n * (x, y, w, h)-tuple.\n */\nexport const drawRect = (arg1, arg2, arg3, arg4) => {\n  const { x, y, w, h } = arg1.type === 'Annotation' || arg1.type === 'Selection' ?\n    parseRectFragment(arg1, arg2) : { x: arg1, y: arg2, w: arg3, h: arg4 };\n\n  const g = document.createElementNS(SVG_NAMESPACE, 'g');\n\n  if (w === 0 && h === 0) {\n    // Edge case: rect is actually a point\n    addClass(g, 'a9s-point');\n    addClass(g, 'a9s-non-scaling');\n    g.setAttribute('transform-origin', `${x} ${y}`);\n\n    const outerPoint  = document.createElementNS(SVG_NAMESPACE, 'circle');\n    const innerPoint  = document.createElementNS(SVG_NAMESPACE, 'circle');\n\n    innerPoint.setAttribute('class', 'a9s-inner');\n    setPointXY(innerPoint, x, y);\n\n    outerPoint.setAttribute('class', 'a9s-outer');\n    setPointXY(outerPoint, x, y);\n\n    g.appendChild(outerPoint);\n    g.appendChild(innerPoint);  \n  } else {\n    const outerRect = document.createElementNS(SVG_NAMESPACE, 'rect');\n    const innerRect = document.createElementNS(SVG_NAMESPACE, 'rect');\n\n    innerRect.setAttribute('class', 'a9s-inner');\n    setXYWH(innerRect, x, y, w, h);\n\n    outerRect.setAttribute('class', 'a9s-outer');\n    setXYWH(outerRect, x, y, w, h);\n\n    g.appendChild(outerRect);\n    g.appendChild(innerRect);\n  }\n\n  return g;\n}\n\n/** Gets the (x, y, w, h)-values from the attributes of the SVG group **/\nexport const getRectSize = g => {\n  const outer = g.querySelector('.a9s-outer');\n\n  if (outer.nodeName === 'rect') {\n    const x = parseFloat(outer.getAttribute('x'));\n    const y = parseFloat(outer.getAttribute('y'));\n    const w = parseFloat(outer.getAttribute('width'));\n    const h = parseFloat(outer.getAttribute('height'));\n\n    return { x, y, w, h };\n  } else {\n    const x = parseFloat(outer.getAttribute('cx'));\n    const y = parseFloat(outer.getAttribute('cy'));\n\n    return { x, y, w: 0, h: 0 };\n  }\n}\n\n/** Applies the (x, y, w, h)-values to the rects in the SVG group **/\nexport const setRectSize = (g, x, y, w, h) => {\n  const inner = g.querySelector('.a9s-inner');\n  const outer = g.querySelector('.a9s-outer');\n\n  if (outer.nodeName === 'rect') {\n    setXYWH(inner, x, y, w, h);\n    setXYWH(outer, x, y, w, h);  \n  } else {\n    setPointXY(inner, x, y);\n    setPointXY(outer, x, y);\n  }\n}\n\n/** \n * Shorthand to get the area (rectangle w x h) from the \n * annotation's fragment selector. \n */\nexport const rectArea = (annotation, image) => {\n  const { w, h } = parseRectFragment(annotation, image);\n  return w * h;\n}\n\n","import { toRectFragment } from '@recogito/annotorious/src/selectors/RectFragment';\n\nexport const isPoint = annotation =>\n  annotation.target.renderedVia?.name === 'point';\n\nexport const toFragment = (x, y, image, fragmentUnit) => ({\n  ...toRectFragment(x, y, 0, 0, image, fragmentUnit),\n  renderedVia: {\n    name: 'point'\n  }\n});","import EditableShape from '@recogito/annotorious/src/tools/EditableShape';\nimport { parseRectFragment } from '@recogito/annotorious/src/selectors/RectFragment';\nimport { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\nimport { toFragment } from './Point';\n\nexport default class EditablePoint extends EditableShape {\n\n  constructor(annotation, g, config, env) {\n    super(annotation, g, config, env);\n\n    this.svg.addEventListener('mousemove', this.onMouseMove);\n    this.svg.addEventListener('mouseup', this.onMouseUp);\n\n    const { x, y } = parseRectFragment(annotation, env.image);\n\n    this.container = document.createElementNS(SVG_NAMESPACE, 'g');\n\n    this.elementGroup = document.createElementNS(SVG_NAMESPACE, 'g');\n    this.elementGroup.setAttribute('class', 'a9s-annotation editable selected');\n\n    this.point = this.drawHandle(x, y);\n    this.point.addEventListener('mousedown', this.onGrab);\n    \n    this.elementGroup.appendChild(this.point);\n\n    this.container.appendChild(this.elementGroup);\n    g.appendChild(this.container);\n\n    // true if te mouse has grabbed the point\n    this.isGrabbed = false;\n  }\n\n  onScaleChanged = () => \n    this.scaleHandle(this.point);\n\n  get element() {\n    return this.elementGroup;\n  }\n\n  onGrab = () => {\n    this.isGrabbed = true;\n  }\n\n  onMouseMove = evt => {\n    if (evt.button !== 0) return;  // left click\n\n    if (this.isGrabbed) {\n      const {x, y} = this.getSVGPoint(evt);\n\n      this.setHandleXY(this.point, x, y);\n\n      const target = toFragment(x, y, this.env.image, this.config.fragmentUnit);\n      this.emit('update', target);\n    }\n  }\n\n  onMouseUp = () => {\n    this.isGrabbed = false;\n  }\n\n  updateState = annotation => {\n    const { x, y } = parseRectFragment(annotation, this.env.image);\n    this.setHandleXY(this.point, x, y);\n  }\n\n  destroy() {\n    this.svg.removeEventListener('mousemove', this.onMouseMove);\n    this.svg.removeEventListener('mouseup', this.onMouseUp);\n\n    this.container.parentNode.removeChild(this.container);\n    super.destroy();\n  }\n\n}","import Tool, { Selection } from '@recogito/annotorious/src/tools/Tool';\nimport EditablePoint from './EditablePoint';\nimport { toFragment, isPoint } from './Point';\n\nexport default class PointTool extends Tool {\n\n  constructor(g, config, env) {\n    super(g, config, env);\n  }\n\n  startDrawing = (x, y, _, evt) => {\n    // The top-most existing annotation at this position (if any) \n    const annotation = evt.target.closest('.a9s-annotation')?.annotation;\n\n    // The point drawing tool will ALWAYS create a point annotation,\n    // regardless of whether there's already an annotation underneath.\n    // UNLESS the annotation underneath is itself a point!\n    if (!annotation || !isPoint(annotation)) {\n      const element = this.drawHandle(x, y);\n      this.scaleHandle(element);\n\n      this.g.appendChild(element);\n\n      element.annotation = new Selection(toFragment(x, y, this.env.image, this.config.fragmentUnit));\n\n      this.emit('complete', element);\n    } else {\n      this.emit('cancel')\n    }\n  }\n\n  stop = () => {\n    // Nothing to do\n  }\n\n  get isDrawing() {\n    // Point selection is an instant action - the\n    // tool is never an 'drawing' state\n    return false;\n  }\n  \n  createEditableShape = annotation =>\n    new EditablePoint(annotation, this.g, this.config, this.env);\n\n}\n\nPointTool.identifier = 'point';\n\nPointTool.supports = annotation => {\n  // Not needed, since the target.renderedVia property will be evaluated first\n  return false;\n}","import { SVG_NAMESPACE } from '../util/SVG';\n\n/** Helper that forces an un-namespaced node to SVG **/\nconst insertSVGNamespace = originalDoc => {\n  // Serialize and parse for the namespace to take effect on every node\n  const serializer = new XMLSerializer();\n  const str = serializer.serializeToString(originalDoc.documentElement);\n\n  // Doesn't seem that there's a clean cross-browser way for this...\n  const namespaced = str.replace('<svg>', `<svg xmlns=\"${SVG_NAMESPACE}\">`);\n\n  const parser = new DOMParser();\n  const namespacedDoc = parser.parseFromString(namespaced, \"image/svg+xml\");\n  return namespacedDoc.documentElement;\n}\n\nconst sanitize = doc => {\n  // Cf. https://github.com/mattkrick/sanitize-svg#readme  \n  // for the basic approach\n  const cleanEl = el => {\n    Array.from(el.attributes).forEach(attr => {\n      if (attr.name.startsWith('on'))\n        el.removeAttribute(attr.name)\n    });\n  }\n\n  // Remove script tags\n  const scripts = doc.getElementsByTagName('script');\n  Array.from(scripts).reverse().forEach(el =>\n    el.parentNode.removeChild(el));\n\n  // Remove on... attributes\n  cleanEl(doc);\n  Array.from(doc.querySelectorAll('*')).forEach(cleanEl);\n\n  return doc;\n}\n\nexport const svgFragmentToShape = annotation => {\n  const selector = annotation.selector('SvgSelector');\n  if (selector) {\n    const parser = new DOMParser();\n\n    // Parse the XML document, assuming SVG\n    const { value } = selector;\n    const doc = parser.parseFromString(value, \"image/svg+xml\");\n\n    // SVG needs a namespace declaration - check if it's set or insert if not\n    const isPrefixDeclared = doc.lookupPrefix(SVG_NAMESPACE); // SVG declared via prefix\n    const isDefaultNamespaceSVG = doc.lookupNamespaceURI(null); // SVG declared as default namespace\n\n    if (isPrefixDeclared || isDefaultNamespaceSVG) {\n      return sanitize(doc).firstChild;\n    } else {\n      return sanitize(insertSVGNamespace(doc)).firstChild;\n    }\n  }\n}\n\nexport const drawEmbeddedSVG = annotation => {\n  const shape = svgFragmentToShape(annotation);\n\n  // Because we're nitpicky, we don't just draw the shape,\n  // but duplicate it, so we can have inner and an outer lines\n  const g = document.createElementNS(SVG_NAMESPACE, 'g');\n\n  const inner = shape.cloneNode(true);\n  inner.setAttribute('class', 'a9s-inner');\n\n  const outer = shape.cloneNode(true);\n  outer.setAttribute('class', 'a9s-outer');\n\n  g.appendChild(outer);\n  g.appendChild(inner);\n\n  return g;\n}\n\nexport const toSVGTarget = (shape, image) => {\n  const inner = shape.querySelector('.a9s-inner').cloneNode(true);\n  inner.removeAttribute('class');\n  inner.removeAttribute('xmlns');\n\n  let serialized = inner.outerHTML || new XMLSerializer().serializeToString(inner);\n  serialized = serialized.replace(` xmlns=\"${SVG_NAMESPACE}\"`, '');\n\n  return {\n    source: image?.src,\n    selector: {\n      type: \"SvgSelector\",\n      value: `<svg>${serialized}</svg>`\n    }\n  }\n}\n\nexport const svgArea = annotation => {\n  const shape = svgFragmentToShape(annotation);\n  const nodeName = shape.nodeName.toLowerCase();\n\n  if (nodeName === 'polygon') \n    return polygonArea(shape);\n  else if (nodeName === 'circle')\n    return circleArea(shape);\n  else if (nodeName === 'ellipse')\n    return ellipseArea(shape);\n  else if (nodeName == 'path')\n    return pathArea(shape);\n  else\n    throw `Unsupported SVG shape type: ${nodeName}`;\n}\n\nexport const getAreaOfPoints = points =>{\n  let area = 0;\n  let j = points.length - 1;\n\n  for (let i=0; i < points.length; i++) {\n    area += (points[j][0] + points[i][0]) * (points[j][1] - points[i][1]);\n    j = i;\n  }\n\n  return Math.abs(0.5 * area);\n}\n\nexport const pointInsidePoygon = (point, polygon) => {\n  \n  var n=polygon.length,\n  is_in=false,\n  x=point[0],\n  y=point[1],\n  x1,x2,y1,y2;\n\nfor(var i=0; i < n-1; ++i){\n  x1=polygon[i][0];\n  x2=polygon[i+1][0];\n  y1=polygon[i][1];\n  y2=polygon[i+1][1];\n\n  if(y < y1 != y < y2 && x < (x2-x1) * (y-y1) / (y2-y1) + x1){\n      is_in=!is_in;\n  }\n}\n\nreturn is_in;\n};\n\nexport const isHole = (polygon1, polygon2) => {\n  // Algorithm checks, if polygon1 is in polygon2\n  for (var point of polygon1){\n    if (!pointInsidePoygon(point, polygon2)) return false\n  }\n  return true;\n}\n\nconst polygonArea = polygon => {\n  const points = polygon.getAttribute('points')\n    .split(' ') // Split x/y tuples\n    .map(xy => xy.split(',').map(str => parseFloat(str.trim())));\n  return getAreaOfPoints(points)\n}\n\nconst circleArea = circle => {\n  const r = circle.getAttribute('r');\n  return r * r * Math.PI;\n}\n\nconst ellipseArea = ellipse => {\n  const rx = ellipse.getAttribute('rx');\n  const ry = ellipse.getAttribute('ry');\n  return rx * ry * Math.PI;\n}\n\nconst pathArea = path => {\n  if (path.getAttribute('d').toUpperCase().includes(\"Z\")){\n    var allcoords = path.getAttribute('d')\n    var polygons =allcoords.split('M');\n    var multiPolygon = []\n    polygons.forEach(function (polygon, index) {\n      if (polygon.length>0){\n        let coords = []\n        polygon=polygon.replace(/ Z/g,\"Z\")\n        polygon=polygon.replace(/Z /g,\"Z\")\n        polygon=polygon.replace(/Z/g,\"\")\n        polygon=polygon.replace(/L /g,\"L\")\n        polygon=polygon.replace(/ L/g,\"L\")\n        var coordsString = polygon.split(\"L\")\n        coordsString.forEach(function(coord, index){\n          coords.push([parseFloat(coord.split(\",\")[0]),parseFloat(coord.split(\",\")[1])]);\n        });\n        if (coords[0] !== coords[coords.length - 1]){\n          coords.push(coords[0])\n        }\n        multiPolygon.push(coords)\n      }\n    })\nif (multiPolygon.length > 1){\n      var area = 0\n      for (let poly1 of multiPolygon) {\n        for (let poly2 of multiPolygon) {\n          if (poly1 !== poly2) {\n            if (isHole(poly1, poly2)) {\n              area -= getAreaOfPoints(poly1)\n            } else {\n              area += getAreaOfPoints(poly1)\n            }\n          }\n        }\n      }\n      return area\n    } else if (multiPolygon.length === 1){\n      return getAreaOfPoints(multiPolygon[0])\n    } else {\n      return 0\n    }\n  } else {\n    const pointList = path.getAttribute('d').split('L');\n    let area = 0;\n  \n    if(pointList.length > 1) {\n      var point = pointList[pointList.length - 1].trim().split(' ');\n      let lastX = parseFloat(point[0]);\n      let lastY = parseFloat(point[1]);\n  \n      point = pointList[0].substring(1).trim().split(' ');\n      let x = parseFloat(point[0]);\n      let y = parseFloat(point[1]);\n      area += (lastX + x) * (lastY - y);\n      lastX = x;\n      lastY = y;\n  \n      for (let i = 1; i < pointList.length; i++) {\n        point = pointList[i].trim().split(' ');\n        x = parseFloat(point[0]);\n        y = parseFloat(point[1]);\n        area += (lastX + x) * (lastY - y);\n        lastX = x;\n        lastY = y;\n      }\n    }\n  \n    return Math.abs(0.5 * area);\n  }\n\n}","import { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\n\n/** Shorthand to apply the given (x, y, r) to the SVG shape **/\nconst setXYR = (shape, x, y, r) => {  \n  shape.setAttribute('cx', x);\n  shape.setAttribute('cy', y);\n  shape.setAttribute('r', r);\n}\n\n/** \n * Draws an SVG circle, either from an annotation, or an\n * (cx, cy, r)-tuple.\n */\nexport const drawCircle = (cx, cy, r) => {\n  const g = document.createElementNS(SVG_NAMESPACE, 'g');\n  const outerCircle  = document.createElementNS(SVG_NAMESPACE, 'circle');\n  const innerCircle  = document.createElementNS(SVG_NAMESPACE, 'circle');\n\n  innerCircle.setAttribute('class', 'a9s-inner');\n  setXYR(innerCircle, cx, cy, r);\n\n  outerCircle.setAttribute('class', 'a9s-outer');\n  setXYR(outerCircle, cx, cy, r);\n\n  g.appendChild(outerCircle);\n  g.appendChild(innerCircle);\n\n  return g;\n}\n\nexport const setCircleSize = (g, cx, cy, r) => {\n  const innerCircle = g.querySelector('.a9s-inner');\n  const outerCircle = g.querySelector('.a9s-outer');\n  \n  setXYR(innerCircle, cx, cy, r);\n  setXYR(outerCircle, cx, cy, r);\n}\n\nexport const getCircleSize = g => {\n  const outerCircle = g.querySelector('.a9s-outer');\n\n  const cx = parseFloat(outerCircle.getAttribute('cx'));\n  const cy = parseFloat(outerCircle.getAttribute('cy'));\n  const r = parseFloat(outerCircle.getAttribute('r'));\n  \n  return { cx, cy, r };\n}","import { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\nimport { getCircleSize } from './Circle';\n\nexport default class CircleMask {\n\n  constructor(imageDimensions, circle) {\n    this.w = imageDimensions.naturalWidth;\n    this.h = imageDimensions.naturalHeight;\n\n    this.circle = circle;\n\n    const { cx, cy, r } = getCircleSize(this.circle);\n    const tx = ((cx + r) > this.w) ? this.w - r : cx;\n    const ty = ((cy + r) > this.h) ? this.h - r : cy + r;\n\n    this.mask = document.createElementNS(SVG_NAMESPACE, 'path');\n    this.mask.setAttribute('fill-rule', 'evenodd');    \n    this.mask.setAttribute('class', 'a9s-selection-mask');\n\n    this.mask.setAttribute('d', `M0 0 h${this.w} v${this.h} h-${this.w} z M${tx} ${ty} a ${r} ${r} 0 1 1 1 0`);\n  }\n\n  redraw = () => {\n    const { cx, cy, r } = getCircleSize(this.circle);\n\n    const tx = ((cx + r) > this.w) ? this.w - r : cx;\n    const ty = ((cy + r) > this.h) ? this.h - r : cy + r;\n\n    this.mask.setAttribute('d', `M0 0 h${this.w} v${this.h} h-${this.w} z M${tx} ${ty} a ${r} ${r} 0 1 1 1 0`);\n  }\n\n  get element() {\n    return this.mask;\n  }\n\n  destroy = () =>\n    this.mask.parentNode.removeChild(this.mask)\n\n}","import { Selection } from '@recogito/annotorious/src/tools/Tool';\nimport { toSVGTarget } from '@recogito/annotorious/src/selectors/EmbeddedSVG';\nimport { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\nimport { drawCircle, setCircleSize } from './Circle';\nimport Mask from './CircleMask';\n\n/**\n * A 'rubberband' selection tool for creating a circle by\n * clicking and dragging.\n */\nexport default class RubberbandCircle {\n\n  constructor(anchorX, anchorY, g, env) {\n    this.anchor = [ anchorX, anchorY ];\n\n    this.env = env;\n\n    this.group = document.createElementNS(SVG_NAMESPACE, 'g');\n\n    this.circle = drawCircle(anchorX, anchorY, 2);\n    this.circle.setAttribute('class', 'a9s-selection');\n\n    this.mask = new Mask(env.image, this.circle);\n\n    // We make the selection transparent to \n    // pointer events because it would interfere with the \n    // rendered annotations' mouseleave/enter events\n    this.group.style.pointerEvents = 'none';\n\n    // Additionally, selection remains hidden until \n    // the user actually moves the mouse\n    this.group.style.display = 'none';\n\n    this.group.appendChild(this.mask.element);\n    this.group.appendChild(this.circle);\n\n    g.appendChild(this.group);\n  }\n\n  get element() {\n    return this.circle;\n  }\n\n  dragTo = (oppositeX, oppositeY) => {\n    const { naturalWidth, naturalHeight } = this.env.image;\n\n    // Make visible\n    this.group.style.display = null;\n\n    const w = oppositeX - this.anchor[0];\n    const h = oppositeY - this.anchor[1];\n    const r = Math.max(1, Math.pow(w ** 2 + h ** 2, 0.5) / 2);\n\n    const cx = this.anchor[0] + w / 2;\n    const cy = this.anchor[1] + h / 2;\n\n    if ((cx-r < 0 || cx + r > naturalWidth) || (cy-r < 0 || cy + r > naturalHeight)) return;\n    \n    setCircleSize(this.circle, cx, cy, r);\n    this.mask.redraw();\n  }\n\n  getBoundingClientRect = () => \n    this.circle.getBoundingClientRect();\n\n  toSelection = () => {\n    return new Selection(toSVGTarget(this.group, this.env.image));\n  }\n\n  destroy = () => {\n    this.group.parentNode.removeChild(this.group);\n\n    this.mask = null;\n    this.circle = null;\n    this.group = null;\n  }\n\n}","import { addClass, SVG_NAMESPACE } from './SVG';\n\nconst isFirefox = /firefox/i.test(navigator.userAgent);\n\nconst formatSvgEl = (svgEl, x, y, w, h) => {\n  svgEl.setAttribute('width', w);\n  svgEl.setAttribute('height', h);\n\n  // Argh - Firefox produces broken SVG bounds for nested SVG\n  if (isFirefox) {\n    svgEl.setAttribute('x', 0);\n    svgEl.setAttribute('y', 0);\n    svgEl.setAttribute('transform', `translate(${x}, ${y})`);  \n  } else {\n    svgEl.setAttribute('x', x);\n    svgEl.setAttribute('y', y);\n  }\n}\n\nconst appendFormatterEl = (formatterEl, shape) => {\n  const { x, y, width, height } = shape.getBBox();\n\n  const svgEl = document.createElementNS(SVG_NAMESPACE, 'svg');\n  svgEl.setAttribute('class', 'a9s-formatter-el');\n\n  formatSvgEl(svgEl, x, y, width, height);\n\n  const g = document.createElementNS(SVG_NAMESPACE, 'g');\n  g.appendChild(formatterEl);y\n\n  svgEl.appendChild(g);\n  \n  shape.append(svgEl);\n}\n\n/**\n * A formatter is a user-defined function that takes an annotation as input,\n * and returns either a string, or an object. If a string is returned, this\n * will be appended to the annotation element CSS class list. Otherwise, the\n * object can have the following properties: \n * \n * - 'className' added to the CSS class list\n * - 'data-*' added as data attributes\n * - 'style' a list of CSS styles (in the form of a string) \n */\n export const setCustomStyle = (shape, annotation) => {\n  if (annotation.getStyle){\n    const style = annotation.getStyle();\n    if (style){\n      for (var i = 0; i < shape.children.length; i++){\n        if (shape.children[i].classList.contains(\"a9s-inner\")){\n          for (let [key, value] of Object.entries(style.inner)){\n            shape.children[i].style[key] = value\n          }\n        } else if (shape.children[i].classList.contains(\"a9s-outer\")){\n          for (let [key, value] of Object.entries(style.outer)){\n            shape.children[i].style[key] = value\n          }\n        }\n      }\n    }  \n  }\n  return shape\n}\nexport const format = (shape, annotation, formatters) => {\n  // The formatter can be undefined\n  if (!formatters)\n    return shape;\n\n  // Merge outputs from all formatter functions into one object\n  const format = formatters.reduce((merged, fn) => {\n    const format = fn(annotation);\n    \n    if (!format)\n      return merged;\n\n    if (typeof format === 'string' || format instanceof String) {\n      merged.className = merged.className ? `${merged.className} ${format}` : format; \n    } else if (format.nodeType === Node.ELEMENT_NODE) {\n      merged.elements = merged.elements ? [...merged.elements, format] : [format];\n    } else {\n      const { className, style, element } = format;\n\n      if (className)\n        merged.className = merged.className ? `${merged.className} ${className}` : className;\n\n      if (style)\n        merged.style = merged.style ? `${merged.style} ${style}` : style;\n\n      if (element)\n        merged.elements = merged.elements ? [...merged.elements, element] : [element];\n    }\n\n    // Copy data attributes\n    for (const key in format) {\n      if (format.hasOwnProperty(key) && key.startsWith('data-')) {\n        merged[key] = format[key];\n      }\n    }\n\n    return merged;\n  }, {});\n\n  const { className, style, elements } = format;\n\n  if (className)\n    addClass(shape, className);\n\n  if (style) {\n    const outer = shape.querySelector('.a9s-outer');\n    const inner = shape.querySelector('.a9s-inner');\n\n    if (outer && inner) {\n      outer.setAttribute('style', 'display:none');\n      inner.setAttribute('style', style);\n    } else {\n      shape.setAttribute('style', style);\n    }\n  }\n\n  if (elements)\n    elements.forEach(el => appendFormatterEl(el, shape));\n\n  for (const key in format) {\n    if (format.hasOwnProperty(key) && key.startsWith('data-')) {\n      shape.setAttribute(key, format[key]);\n    }\n  }\n}\n\nexport const setFormatterElSize = (group, x, y, w, h) => {\n  const formatterEl = group.querySelector('.a9s-formatter-el');\n  if (formatterEl)\n    formatSvgEl(formatterEl, x, y, w, h);\n}","import EditableShape from '@recogito/annotorious/src/tools/EditableShape';\nimport { drawEmbeddedSVG, svgFragmentToShape, toSVGTarget } from '@recogito/annotorious/src/selectors/EmbeddedSVG';\nimport { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\nimport { format, setFormatterElSize } from '@recogito/annotorious/src/util/Formatting';\nimport { getCircleSize, setCircleSize } from './Circle';\nimport Mask from './CircleMask';\n\n/**\n * An editable circle shape.\n */\nexport default class EditableCircle extends EditableShape {\n\n  constructor(annotation, g, config, env) {\n    super(annotation, g, config, env);\n\n    this.svg.addEventListener('mousemove', this.onMouseMove);\n    this.svg.addEventListener('mouseup', this.onMouseUp);\n\n    // SVG markup for this class looks like this:\n    // \n    // <g>\n    //   <path class=\"a9s-selection mask\"... />\n    //   <g> <-- return this node as .element\n    //     <circle class=\"a9s-outer\" ... />\n    //     <circle class=\"a9s-inner\" ... />\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //   </g> \n    // </g>\n\n    // 'g' for the editable circle compound shape\n    this.containerGroup = document.createElementNS(SVG_NAMESPACE, 'g');\n\n    this.circle = drawEmbeddedSVG(annotation);\n    this.circle.querySelector('.a9s-inner')\n      .addEventListener('mousedown', this.onGrab(this.circle));\n\n    this.mask = new Mask(env.image, this.circle);\n\n    this.containerGroup.appendChild(this.mask.element);\n\n    // The 'element' = circle + handles\n    this.elementGroup = document.createElementNS(SVG_NAMESPACE, 'g');\n    this.elementGroup.setAttribute('class', 'a9s-annotation editable selected');\n    this.elementGroup.appendChild(this.circle);    \n\n    const { cx, cy, r } = getCircleSize(this.circle);\n\n    this.handles = [\n      [ cx, cy - r ],\n      [ cx + r, cy ],\n      [ cx, cy + r ],\n      [ cx - r, cy ]\n    ].map(t => { \n      const [ x, y ] = t;\n      const handle = this.drawHandle(x, y);\n\n      handle.addEventListener('mousedown', this.onGrab(handle));\n      this.elementGroup.appendChild(handle);\n\n      return handle;\n    });\n\n    this.containerGroup.appendChild(this.elementGroup);\n    g.appendChild(this.containerGroup);\n\n    format(this.circle, annotation, config.formatter);\n\n    // The grabbed element (handle or entire group), if any\n    this.grabbedElem = null; \n\n    // Mouse xy offset inside the shape, if mouse pressed\n    this.grabbedAt = null;\n  }\n\n  setSize = (cx, cy, r) => {\n    setCircleSize(this.circle, cx, cy, r);\n    this.mask.redraw();\n    setFormatterElSize(this.elementGroup, cx, cy, r, r);\n\n    const [ topleft, topright, bottomright, bottomleft] = this.handles;\n    this.setHandleXY(topleft, cx, cy - r);\n    this.setHandleXY(topright, cx + r, cy);\n    this.setHandleXY(bottomright, cx, cy + r);\n    this.setHandleXY(bottomleft, cx - r, cy);\n  }\n\n  stretchCorners = (draggedHandleIdx, anchorHandle, mousePos) => {\n    const anchor = this.getHandleXY(anchorHandle);\n\n    var mouseX = mousePos.x;\n    var mouseY = mousePos.y;\n    var width = 0;\n    var height = 0;\n    var r;\n    if (draggedHandleIdx == 0 || draggedHandleIdx == 2) {\n      mouseX = anchor.x;\n      height = mouseY - anchor.y;\n      r = Math.abs(height) / 2;\n    } else {\n      mouseY = anchor.y;\n      width = mouseX - anchor.x;\n      r = Math.abs(width) / 2;\n    }\n\n    const x = width > 0 ? anchor.x : mouseX;\n    const y = height > 0 ? anchor.y : mouseY;\n    const w = Math.abs(width);\n    const h = Math.abs(height);\n    const cx = x + w/2;\n    const cy = y + h/2;\n\n    setCircleSize(this.circle, cx, cy, r);\n    this.mask.redraw();\n    setFormatterElSize(this.elementGroup, cx, cy, r, r);\n\n    if (draggedHandleIdx == 0 || draggedHandleIdx == 2) {\n      var idx0 = 0;\n      var idx2 = 2;\n      if(draggedHandleIdx == 0 && height > 0 || draggedHandleIdx == 2 && height < 0) {\n        idx0 = 2;\n        idx2 = 0;\n      }\n      this.setHandleXY(this.handles[idx0], cx, cy - r);\n      this.setHandleXY(this.handles[idx2], cx, cy + r);\n      this.setHandleXY(this.handles[1], cx + r, cy);\n      this.setHandleXY(this.handles[3], cx - r, cy);\n    } else {\n      var idx3 = 3;\n      var idx1 = 1;\n      if (draggedHandleIdx == 1 && width > 0 || draggedHandleIdx == 3 && width < 0) {\n        idx3 = 1;\n        idx1 = 3;\n      }\n      this.setHandleXY(this.handles[idx3], cx + r, cy);\n      this.setHandleXY(this.handles[idx1], cx - r, cy);\n      this.setHandleXY(this.handles[0], cx, cy - r);\n      this.setHandleXY(this.handles[2], cx, cy + r);\n    }\n  }\n\n  onGrab = grabbedElem => evt => {\n    this.grabbedElem = grabbedElem; \n    \n    const pos = this.getSVGPoint(evt);\n    const { cx, cy } = getCircleSize(this.circle);\n    \n    this.grabbedAt = { x: pos.x - cx, y: pos.y - cy };\n  }\n\n  onMouseMove = evt => {\n    const constrain = (coord, max) =>\n      coord < 0 ? 0 : ( coord > max ? max : coord);\n\n    if (this.grabbedElem) {\n      const pos = this.getSVGPoint(evt);\n\n      if (this.grabbedElem === this.circle) {\n        const { r } = getCircleSize(this.circle);\n\n        const { naturalWidth, naturalHeight } = this.env.image;\n\n        const cx = Math.max(constrain(pos.x - this.grabbedAt.x, naturalWidth - r), r);\n        const cy = Math.max(constrain(pos.y - this.grabbedAt.y, naturalHeight - r), r);\n\n        this.setSize(cx, cy, r); \n        this.emit('update', toSVGTarget(this.circle, this.env.image)); \n      } else {\n        // Mouse position replaces one of the corner coords, depending\n        // on which handle is the grabbed element\n        const handleIdx = this.handles.indexOf(this.grabbedElem);\n        const oppositeHandle = handleIdx < 2 ? \n          this.handles[handleIdx + 2] : this.handles[handleIdx - 2];\n\n        this.stretchCorners(handleIdx, oppositeHandle, pos);\n        this.emit('update', toSVGTarget(this.circle, this.env.image));\n      }\n    }\n  }\n\n  onMouseUp = () => {\n    this.grabbedElem = null;\n    this.grabbedAt = null;\n  }\n\n  get element() { \n    return this.elementGroup; \n  }\n\n  updateState = annotation => {\n    const shape = svgFragmentToShape(annotation);\n\n    const cx = parseFloat(shape.getAttribute('cx'));\n    const cy = parseFloat(shape.getAttribute('cy'));\n    const r =  parseFloat(shape.getAttribute('r'));\n\n    this.setSize(cx, cy, r);\n  }\n\n  destroy() {\n    this.containerGroup.parentNode.removeChild(this.containerGroup);\n    super.destroy();\n  }\n\n}\n","import Tool from '@recogito/annotorious/src/tools/Tool';\nimport RubberbandCircle from './RubberbandCircle';\nimport EditableCircle from './EditableCircle';\n\n/**\n * A rubberband selector for circle selections.\n */\nexport default class RubberbandCircleTool extends Tool {\n\n  constructor(g, config, env) {\n    super(g, config, env);\n\n    this.rubberband = null;\n  }\n\n  startDrawing = (x, y) => {\n    this.attachListeners({\n      mouseMove: this.onMouseMove,\n      mouseUp: this.onMouseUp\n    });\n\n    this.rubberband = new RubberbandCircle(x, y, this.g, this.env);\n  }\n\n  stop = () => {\n    if (this.rubberband) {\n      this.rubberband.destroy();\n      this.rubberband = null;\n    }\n  }\n\n  onMouseMove = (x, y) =>\n    this.rubberband.dragTo(x, y);\n  \n  onMouseUp = () => {\n    this.detachListeners();\n    this.started = false;\n\n    const { width, height } = this.rubberband.getBoundingClientRect();\n\n    const minWidth = this.config.minSelectionWidth || 4;\n    const minHeight = this.config.minSelectionHeight || 4;\n\n    if (width >= minWidth && height >= minHeight) {\n      // Emit the SVG shape with selection attached    \n      const { element } = this.rubberband;\n      element.annotation = this.rubberband.toSelection();\n\n      // Emit the completed shape...\n      this.emit('complete', element);\n    } else {\n      this.emit('cancel');\n    }\n\n    this.stop();\n  }\n\n  get isDrawing() {\n    return this.rubberband != null;\n  }\n  \n  createEditableShape = annotation =>\n    new EditableCircle(annotation, this.g, this.config, this.env);\n\n}\n\nRubberbandCircleTool.identifier = 'circle';\n\nRubberbandCircleTool.supports = annotation => {\n  const selector = annotation.selector('SvgSelector');\n  if (selector)\n    return selector.value?.match(/^<svg.*<circle/g);\n}","import { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\n\n/** Shorthand to apply the given (x, y, rx, ry) to the SVG shape **/\nconst setXYR = (shape, x, y, rx, ry) => {  \n  shape.setAttribute('cx', x);\n  shape.setAttribute('cy', y);\n  shape.setAttribute('rx', rx);\n  shape.setAttribute('ry', ry);\n}\n\n/** \n * Draws an SVG ellipse, either from an annotation, or an\n * (cx, cy, rx, ry)-tuple.\n */\nexport const drawEllipse = (cx, cy, rx, ry) => {\n  const g = document.createElementNS(SVG_NAMESPACE, 'g');\n  const innerEllipse  = document.createElementNS(SVG_NAMESPACE, 'ellipse');\n  const outerEllipse  = document.createElementNS(SVG_NAMESPACE, 'ellipse');\n\n  innerEllipse.setAttribute('class', 'a9s-inner');\n  setXYR(innerEllipse, cx, cy, rx, ry);\n\n  outerEllipse.setAttribute('class', 'a9s-outer');\n  setXYR(outerEllipse, cx, cy, rx, ry);\n\n  g.appendChild(outerEllipse);\n  g.appendChild(innerEllipse);\n\n  return g;\n}\n\nexport const setEllipseSize = (g, cx, cy, rx, ry) => {\n  const innerEllipse = g.querySelector('.a9s-inner');\n  const outerEllipse = g.querySelector('.a9s-outer');\n\n  setXYR(innerEllipse, cx, cy, rx, ry);\n  setXYR(outerEllipse, cx, cy, rx, ry);\n}\n\nexport const getEllipseSize = g => {\n  const outerEllipse = g.querySelector('.a9s-outer');\n\n  const cx = parseFloat(outerEllipse.getAttribute('cx'));\n  const cy = parseFloat(outerEllipse.getAttribute('cy'));\n  const rx = parseFloat(outerEllipse.getAttribute('rx'));\n  const ry = parseFloat(outerEllipse.getAttribute('ry'));\n  \n  return { cx, cy, rx, ry };\n}","import { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\nimport { getEllipseSize } from './Ellipse';\n\nexport default class EllipseMask {\n\n  constructor(imageDimensions, ellipse) {\n    this.w = imageDimensions.naturalWidth;\n    this.h = imageDimensions.naturalHeight;\n\n    this.ellipse = ellipse;\n\n    const { cx, cy, rx, ry } = getEllipseSize(this.ellipse);\n\n    const ty = cy + ry;\n\n    this.mask = document.createElementNS(SVG_NAMESPACE, 'path');\n    this.mask.setAttribute('fill-rule', 'evenodd');    \n    this.mask.setAttribute('class', 'a9s-selection-mask');\n\n    this.mask.setAttribute('d', `M0 0 h${this.w} v${this.h} h-${this.w} z M${cx} ${ty} a ${rx} ${ry} 0 1 1 1 0`);\n  }\n\n  redraw = () => {\n    const { cx, cy, rx, ry } = getEllipseSize(this.ellipse);\n\n    const ty = cy + ry;\n\n    this.mask.setAttribute('d', `M0 0 h${this.w} v${this.h} h-${this.w} z M${cx} ${ty} a ${rx} ${ry} 0 1 1 1 0`);\n  }\n\n  get element() {\n    return this.mask;\n  }\n\n  destroy = () =>\n    this.mask.parentNode.removeChild(this.mask)\n\n}","import { Selection } from '@recogito/annotorious/src/tools/Tool';\nimport { toSVGTarget } from '@recogito/annotorious/src/selectors/EmbeddedSVG';\nimport { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\nimport { drawEllipse, setEllipseSize } from './Ellipse';\nimport Mask from './EllipseMask';\n\n/**\n * A 'rubberband' selection tool for creating a ellipse by\n * clicking and dragging.\n */\nexport default class RubberbandEllipse {\n\n  constructor(anchorX, anchorY, g, env) {\n    this.anchor = [ anchorX, anchorY ];\n\n    this.env = env;\n\n    this.group = document.createElementNS(SVG_NAMESPACE, 'g');\n\n    this.ellipse = drawEllipse(anchorX, anchorY, 2);\n    this.ellipse.setAttribute('class', 'a9s-selection');\n\n    this.mask = new Mask(env.image, this.ellipse);\n\n    // We make the selection transparent to \n    // pointer events because it would interfere with the \n    // rendered annotations' mouseleave/enter events\n    this.group.style.pointerEvents = 'none';\n\n    // Additionally, selection remains hidden until \n    // the user actually moves the mouse\n    this.group.style.display = 'none';\n\n    this.group.appendChild(this.mask.element);\n    this.group.appendChild(this.ellipse);\n\n    g.appendChild(this.group);\n  }\n\n  get element() {\n    return this.ellipse;\n  }\n\n  dragTo = (oppositeX, oppositeY) => {\n    // Make visible\n    this.group.style.display = null;\n\n    const w = oppositeX - this.anchor[0];\n    const h = oppositeY - this.anchor[1];\n\n    const cx = w > 0 ? this.anchor[0] + w / 2 : oppositeX + w / 2;\n    const cy = h > 0 ? this.anchor[1] + h / 2 : oppositeY + h / 2;\n\n    const rx = Math.abs(w / 2);\n    const ry = Math.abs(h / 2);\n\n    setEllipseSize(this.ellipse, cx, cy, rx, ry);\n    this.mask.redraw();\n  }\n\n  getBoundingClientRect = () => \n    this.ellipse.getBoundingClientRect();\n\n  toSelection = () => {\n    return new Selection(toSVGTarget(this.group, this.env.image));\n  }\n\n  destroy = () => {\n    this.group.parentNode.removeChild(this.group);\n\n    this.mask = null;\n    this.ellipse = null;\n    this.group = null;\n  }\n\n}","import EditableShape from '@recogito/annotorious/src/tools/EditableShape';\nimport { drawEmbeddedSVG, svgFragmentToShape, toSVGTarget } from '@recogito/annotorious/src/selectors/EmbeddedSVG';\nimport { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\nimport { format, setFormatterElSize } from '@recogito/annotorious/src/util/Formatting';\nimport { getEllipseSize, setEllipseSize } from './Ellipse';\nimport Mask from './EllipseMask';\n\n/**\n * An editable ellipse shape.\n */\nexport default class EditableEllipse extends EditableShape {\n\n  constructor(annotation, g, config, env) {\n    super(annotation, g, config, env);\n\n    this.svg.addEventListener('mousemove', this.onMouseMove);\n    this.svg.addEventListener('mouseup', this.onMouseUp);\n\n    // SVG markup for this class looks like this:\n    // \n    // <g>\n    //   <path class=\"a9s-selection mask\"... />\n    //   <g> <-- return this node as .element\n    //     <ellipse class=\"a9s-outer\" ... />\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //   </g> \n    // </g>\n\n    // 'g' for the editable ellipse compound shape\n    this.containerGroup = document.createElementNS(SVG_NAMESPACE, 'g');\n\n    this.ellipse = drawEmbeddedSVG(annotation);\n    this.ellipse.querySelector('.a9s-inner')\n      .addEventListener('mousedown', this.onGrab(this.ellipse));\n\n    this.mask = new Mask(env.image, this.ellipse);\n\n    this.containerGroup.appendChild(this.mask.element);\n\n    // The 'element' = ellipse + handles\n    this.elementGroup = document.createElementNS(SVG_NAMESPACE, 'g');\n    this.elementGroup.setAttribute('class', 'a9s-annotation editable selected');\n    this.elementGroup.appendChild(this.ellipse);    \n\n    const { cx, cy, rx, ry } = getEllipseSize(this.ellipse);\n\n    this.handles = [\n      [ cx, cy - ry ],\n      [ cx + rx, cy ],\n      [ cx, cy + ry ],\n      [ cx - rx, cy ]\n    ].map(t => { \n      const [ x, y ] = t;\n      const handle = this.drawHandle(x, y);\n\n      handle.addEventListener('mousedown', this.onGrab(handle));\n      this.elementGroup.appendChild(handle);\n\n      return handle;\n    });\n\n    this.containerGroup.appendChild(this.elementGroup);\n    g.appendChild(this.containerGroup);\n\n    format(this.ellipse, annotation, config.formatter);\n\n    // The grabbed element (handle or entire group), if any\n    this.grabbedElem = null; \n\n    // Mouse xy offset inside the shape, if mouse pressed\n    this.grabbedAt = null;\n  }\n\n  setSize = (cx, cy, rx, ry) => {\n    setEllipseSize(this.ellipse, cx, cy, rx, ry);\n    this.mask.redraw();\n    setFormatterElSize(this.elementGroup, cx, cy, rx, ry);\n\n    const [ topleft, topright, bottomright, bottomleft] = this.handles;\n    this.setHandleXY(topleft, cx, cy - ry);\n    this.setHandleXY(topright, cx + rx, cy);\n    this.setHandleXY(bottomright, cx, cy + ry);\n    this.setHandleXY(bottomleft, cx - rx, cy);\n  }\n\n  stretchCorners = (draggedHandleIdx, anchorHandle, leftHandle, mousePos) => {\n    const anchor = this.getHandleXY(anchorHandle);\n    const anchorLeft = this.getHandleXY(leftHandle);\n\n    var mouseX = mousePos.x;\n    var mouseY = mousePos.y;\n    var rx = 0;\n    var ry = 0;\n    if(draggedHandleIdx == 0 || draggedHandleIdx == 2) {\n      mouseX = anchor.x;\n    } else {\n      mouseY = anchor.y;\n    }\n\n    const width = mouseX - anchor.x;\n    const height = mouseY - anchor.y;\n    const x = width > 0 ? anchor.x : mouseX;\n    const y = height > 0 ? anchor.y : mouseY;\n    const w = Math.abs(width);\n    const h = Math.abs(height);\n    const cx = x + w/2;\n    const cy = y + h/2;\n    var rx = w/2;\n    var ry = h/2;\n    if(draggedHandleIdx == 0 || draggedHandleIdx == 2) {\n      rx = Math.abs(anchor.x - anchorLeft.x);\n    } else {\n      ry = Math.abs(anchor.y - anchorLeft.y);\n    }\n\n    setEllipseSize(this.ellipse, cx, cy, rx, ry);\n    this.mask.redraw();\n    setFormatterElSize(this.elementGroup, cx, cy, rx, ry);\n\n    if (draggedHandleIdx == 0 || draggedHandleIdx == 2) {\n      var idx0 = 0;\n      var idx2 = 2;\n      if(draggedHandleIdx == 0 && height > 0 || draggedHandleIdx == 2 && height < 0) {\n        idx0 = 2;\n        idx2 = 0;\n      }\n      this.setHandleXY(this.handles[idx0], cx, cy - ry);\n      this.setHandleXY(this.handles[idx2], cx, cy + ry);\n      this.setHandleXY(this.handles[1], cx + rx, cy);\n      this.setHandleXY(this.handles[3], cx - rx, cy);\n    } else {\n      var idx3 = 3;\n      var idx1 = 1;\n      if (draggedHandleIdx == 1 && width > 0 || draggedHandleIdx == 3 && width < 0) {\n        idx3 = 1;\n        idx1 = 3;\n      }\n      this.setHandleXY(this.handles[idx3], cx + rx, cy);\n      this.setHandleXY(this.handles[idx1], cx - rx, cy);\n      this.setHandleXY(this.handles[0], cx, cy - ry);\n      this.setHandleXY(this.handles[2], cx, cy + ry);\n    }\n  }\n\n  onGrab = grabbedElem => evt => {\n    this.grabbedElem = grabbedElem; \n\n    const pos = this.getSVGPoint(evt);\n    const { cx, cy } = getEllipseSize(this.ellipse);\n\n    this.grabbedAt = { x: pos.x - cx, y: pos.y - cy };\n  }\n\n  onMouseMove = evt => {\n    const constrain = (coord, max) =>\n      coord < 0 ? 0 : ( coord > max ? max : coord);\n\n    if (this.grabbedElem) {\n      const pos = this.getSVGPoint(evt);\n\n      if (this.grabbedElem === this.ellipse) {\n        const { rx, ry } = getEllipseSize(this.ellipse);\n\n        const { naturalWidth, naturalHeight } = this.env.image;\n\n        const cx = constrain(pos.x - this.grabbedAt.x, naturalWidth - rx);\n        const cy = constrain(pos.y - this.grabbedAt.y, naturalHeight - ry);\n\n        this.setSize(cx, cy, rx, ry); \n        this.emit('update', toSVGTarget(this.ellipse, this.env.image));\n      } else {\n        // Mouse position replaces one of the corner coords, depending\n        // on which handle is the grabbed element\n        const handleIdx = this.handles.indexOf(this.grabbedElem);\n        const oppositeHandle = handleIdx < 2 ? \n          this.handles[handleIdx + 2] : this.handles[handleIdx - 2];\n        const leftHandle = this.handles[(handleIdx + 3) % 4];\n\n        this.stretchCorners(handleIdx, oppositeHandle, leftHandle, pos);\n        this.emit('update', toSVGTarget(this.ellipse, this.env.image));\n      }\n    }\n  }\n\n  onMouseUp = () => {\n    this.grabbedElem = null;\n    this.grabbedAt = null;\n  }\n\n  get element() { \n    return this.elementGroup; \n  }\n\n  updateState = annotation => {\n    const shape = svgFragmentToShape(annotation);\n\n    const cx = parseFloat(shape.getAttribute('cx'));\n    const cy = parseFloat(shape.getAttribute('cy'));\n    const rx = parseFloat(shape.getAttribute('rx'));\n    const ry = parseFloat(shape.getAttribute('ry'));\n    \n    this.setSize(cx, cy, rx, ry);\n  }\n\n  destroy() {\n    this.containerGroup.parentNode.removeChild(this.containerGroup);\n    super.destroy();\n  }\n\n}","import Tool from '@recogito/annotorious/src/tools/Tool';\nimport RubberbandEllipse from './RubberbandEllipse';\nimport EditableEllipse from './EditableEllipse';\n\n/**\n * A rubberband selector for ellipse selections.\n */\nexport default class RubberbandEllipseTool extends Tool {\n\n  constructor(g, config, env) {\n    super(g, config, env);\n\n    this.rubberband = null;\n  }\n\n  startDrawing = (x, y) => {\n    this.attachListeners({\n      mouseMove: this.onMouseMove,\n      mouseUp: this.onMouseUp\n    });\n\n    this.rubberband = new RubberbandEllipse(x, y, this.g, this.env);\n  }\n\n  stop = () => {\n    if (this.rubberband) {\n      this.rubberband.destroy();\n      this.rubberband = null;\n    }\n  }\n\n  onMouseMove = (x, y) =>\n    this.rubberband.dragTo(x, y);\n  \n  onMouseUp = () => {\n    this.detachListeners();\n    this.started = false;\n\n    const { width, height } = this.rubberband.getBoundingClientRect();\n\n    const minWidth = this.config.minSelectionWidth || 4;\n    const minHeight = this.config.minSelectionHeight || 4;\n\n    if (width >= minWidth && height >= minHeight) {\n      // Emit the SVG shape with selection attached    \n      const { element } = this.rubberband;\n      element.annotation = this.rubberband.toSelection();\n\n      // Emit the completed shape...\n      this.emit('complete', element);\n    } else {\n      this.emit('cancel');\n    }\n\n    this.stop();\n  }\n\n  get isDrawing() {\n    return this.rubberband != null;\n  }\n  \n  createEditableShape = annotation =>\n    new EditableEllipse(annotation, this.g, this.config, this.env);\n\n}\n\nRubberbandEllipseTool.identifier = 'ellipse';\n\nRubberbandEllipseTool.supports = annotation => {\n  const selector = annotation.selector('SvgSelector');\n  if (selector)\n    return selector.value?.match(/^<svg.*<ellipse/g);\n}","import { Selection } from '@recogito/annotorious/src/tools/Tool';\nimport { toSVGTarget } from '@recogito/annotorious/src/selectors/EmbeddedSVG';\nimport { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\n// TODO optional: mask to dim the outside area\n//import Mask from './FreehandMask';\n\n/**\n * A 'rubberband' selection tool for creating freehand drawing by\n * clicking and dragging.\n */\nexport default class RubberbandFreehand {\n\n  constructor(anchor, g, env) {\n    this.points = [ anchor ];\n\n    this.env = env;\n\n    this.group = document.createElementNS(SVG_NAMESPACE, 'g');\n\n    this.freehand = document.createElementNS(SVG_NAMESPACE, 'g');\n    this.freehand.setAttribute('class', 'a9s-selection');\n\n    this.outer = document.createElementNS(SVG_NAMESPACE, 'path');\n    this.outer.setAttribute('class', 'a9s-outer');\n\n    this.inner = document.createElementNS(SVG_NAMESPACE, 'path');\n    this.inner.setAttribute('class', 'a9s-inner');\n\n    this.setPoints(this.points);\n\n   // TODO optional: mask to dim the outside area\n   // this.mask = new Mask(env.image, this.inner);\n\n    this.freehand.appendChild(this.outer);\n    this.freehand.appendChild(this.inner);\n\n    // Additionally, selection remains hidden until \n    // the user actually moves the mouse\n    this.group.style.display = 'none';\n\n   // TODO optional: mask to dim the outside area\n   // this.group.appendChild(this.mask.element);\n    this.group.appendChild(this.freehand);\n\n    g.appendChild(this.group);\n  }\n\n  setPoints = points => {\n    var str = points.map(pt => `L${pt[0]} ${pt[1]}`).join(' ');\n    str = 'M' + str.substring(1);\n    this.outer.setAttribute('d', str);\n    this.inner.setAttribute('d', str);\n  }\n\n  getBoundingClientRect = () =>\n    this.outer.getBoundingClientRect();\n\n  dragTo = xy => {\n    // Make visible\n    this.group.style.display = null;\n\n    //TODO optional: edge smoothing\n\n    this.addPoint(xy);\n\n   // TODO optional: mask to dim the outside area\n   // this.mask.redraw();\n  }\n\n  addPoint = xy => {\n    this.points = [ ...this.points, xy ];\n    this.setPoints(this.points);   \n   // TODO optional: mask to dim the outside area\n   // this.mask.redraw();\n  }\n\n  get element() {\n    return this.freehand;\n  }\n\n  destroy = () => {\n    this.group.parentNode.removeChild(this.group);\n    this.freehand = null;    \n    this.group = null;\n  }\n\n  toSelection = () => {\n    return new Selection(toSVGTarget(this.group, this.env.image));\n  }\n\n}\n","import EditableShape from '@recogito/annotorious/src/tools/EditableShape';\nimport { drawEmbeddedSVG, svgFragmentToShape, toSVGTarget } from '@recogito/annotorious/src/selectors/EmbeddedSVG';\nimport { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\nimport { format, setFormatterElSize } from '@recogito/annotorious/src/util/Formatting';\n// TODO optional: mask to dim the outside area\n//import Mask from './FreehandMask';\n\nconst getPoints = shape => {\n  const pointList = shape.getAttribute('d').split('L');\n  const points = [];\n  if(pointList.length > 0) {\n    var point = pointList[0].substring(1).trim().split(' ');\n    points.push({ x: parseFloat(point[0]), y: parseFloat(point[1]) });\n\n    for (let i = 1; i < pointList.length; i++) {\n      var point = pointList[i].trim().split(' ');\n      points.push({ x: parseFloat(point[0]), y: parseFloat(point[1]) });\n    }\n  }\n\n  return points;\n}\n\nconst getBBox = shape => {\n  return shape.querySelector('.a9s-inner').getBBox();\n}\n\n/**\n * An editable freehand drawing.\n */\nexport default class EditableFreehand extends EditableShape {\n\n  constructor(annotation, g, config, env) {\n    super(annotation, g, config, env);\n\n    this.svg.addEventListener('mousemove', this.onMouseMove);\n    this.svg.addEventListener('mouseup', this.onMouseUp);\n\n    // SVG markup for this class looks like this:\n    // \n    // <g>\n    //   <path class=\"a9s-selection mask\"... />\n    //   <g> <-- return this node as .element\n    //     <polygon class=\"a9s-outer\" ... />\n    //     <polygon class=\"a9s-inner\" ... />\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //     ...\n    //   </g> \n    // </g>\n\n    // 'g' for the editable free drawing compound shape\n    this.containerGroup = document.createElementNS(SVG_NAMESPACE, 'g');\n\n    this.shape = drawEmbeddedSVG(annotation);\n\n   // TODO optional: mask to dim the outside area\n   // this.mask = new Mask(env.image, this.shape.querySelector('.a9s-inner'));\n    \n   // this.containerGroup.appendChild(this.mask.element);\n\n    this.elementGroup = document.createElementNS(SVG_NAMESPACE, 'g');\n    this.elementGroup.setAttribute('class', 'a9s-annotation editable selected');\n    this.elementGroup.appendChild(this.shape);\n\n    this.containerGroup.appendChild(this.elementGroup);\n    g.appendChild(this.containerGroup);\n\n    format(this.shape, annotation, config.formatter);\n\n    this.shape.querySelector('.a9s-inner')\n      .addEventListener('mousedown', this.onGrab(this.shape));\n\n    const { x, y, width, height } = getBBox(this.shape);\n\n    // TODO optional: handles to stretch the shape\n/*    this.handles = [\n      [ x, y ], \n      [ x + width, y ], \n      [ x + width, y + height ], \n      [ x, y + height ]\n    ].map(t => { \n      const [ x, y ] = t;\n      const handle = this.drawHandle(x, y);\n\n      handle.addEventListener('mousedown', this.onGrab(handle));\n      this.elementGroup.appendChild(handle);\n\n      return handle;\n    });*/\n\n    // The grabbed element (handle or entire shape), if any\n    this.grabbedElem = null;\n\n    // Mouse grab point\n    this.grabbedAt = null;\n  }\n\n  setPoints = (points) => {\n    // Not using .toFixed(1) because that will ALWAYS\n    // return one decimal, e.g. \"15.0\" (when we want \"15\")\n    const round = num => Math.round(10 * num) / 10;\n\n    var str = points.map(pt => `L${round(pt.x)} ${round(pt.y)}`).join(' ');\n    str = 'M' + str.substring(1);\n\n    const inner = this.shape.querySelector('.a9s-inner');\n    inner.setAttribute('d', str);\n\n    const outer = this.shape.querySelector('.a9s-outer');\n    outer.setAttribute('d', str);\n\n    const { x, y, width, height } = outer.getBBox();\n\n    // TODO optional: mask to dim the outside area\n    // this.mask.redraw();\n\n    // TODO optional: handles to stretch the shape\n/*    const [ topleft, topright, bottomright, bottomleft] = this.handles;\n\n    this.setHandleXY(topleft, x, y);\n    this.setHandleXY(topright, x + width, y);\n    this.setHandleXY(bottomright, x + width, y + height);\n    this.setHandleXY(bottomleft, x, y + height);*/\n\n    setFormatterElSize(this.elementGroup, x, y, width, height);\n  }\n\n    // TODO optional: handles to stretch the shape\n/*  stretchCorners = (draggedHandleIdx, anchorHandle, mousePos) => {\n    const anchor = this.getHandleXY(anchorHandle);\n  }*/\n\n  onGrab = grabbedElem => evt => {\n    this.grabbedElem = grabbedElem;\n    const pos = this.getSVGPoint(evt);\n    this.grabbedAt = { x: pos.x, y: pos.y };\n  }\n\n  onMouseMove = evt => {\n    const constrain = (coord, delta, max) =>\n      coord + delta < 0 ? -coord : (coord + delta > max ? max - coord : delta);\n\n    if (this.grabbedElem) {\n      const pos = this.getSVGPoint(evt);\n\n      const { x, y, width, height } = getBBox(this.shape);\n\n      if (this.grabbedElem === this.shape) {\n\n        const { naturalWidth, naturalHeight } = this.env.image;\n\n        const dx = constrain(x, pos.x - this.grabbedAt.x, naturalWidth - width);\n        const dy = constrain(y, pos.y - this.grabbedAt.y, naturalHeight - height);\n\n        const inner = this.shape.querySelector('.a9s-inner');\n        const updatedPoints = getPoints(inner).map(pt => ({ x: pt.x + dx, y: pt.y + dy }));\n\n        this.grabbedAt = pos;\n\n        this.setPoints(updatedPoints);\n\n        this.emit('update', toSVGTarget(this.shape, this.env.image));\n      }\n      // TODO optional: handles to stretch the shape\n      /* else {\n        const handleIdx = this.handles.indexOf(this.grabbedElem);\n        const oppositeHandle = handleIdx < 2 ? \n          this.handles[handleIdx + 2] : this.handles[handleIdx - 2];\n\n        this.stretchCorners(handleIdx, oppositeHandle, pos);\n\n        this.emit('update', toSVGTarget(this.shape, this.env.image));\n      }*/\n    }\n  }\n\n  onMouseUp = evt => {\n    this.grabbedElem = null;\n    this.grabbedAt = null;\n  }\n\n  get element() {\n    return this.elementGroup;\n  }\n\n  updateState = annotation => {\n    const points = getPoints(svgFragmentToShape(annotation));\n    this.setPoints(points);\n  }\n\n  destroy = () => {\n    this.containerGroup.parentNode.removeChild(this.containerGroup);\n    super.destroy();\n  }\n\n}\n","import Tool from '@recogito/annotorious/src/tools/Tool';\nimport RubberbandFreehand from './RubberbandFreehand';\nimport EditableFreehand from './EditableFreehand';\n\n/**\n * A rubberband selector for freehand fragments.\n */\nexport default class RubberbandFreehandTool extends Tool {\n\n  constructor(g, config, env) {\n    super(g, config, env);\n\n    this._isDrawing = false;\n  }\n\n  startDrawing = (x, y) => {\n    this._isDrawing = true;\n    \n    this.attachListeners({\n      mouseMove: this.onMouseMove,\n      mouseUp: this.onMouseUp,\n      dblClick: this.onDblClick\n    });\n    \n    this.rubberband = new RubberbandFreehand([ x, y ], this.g, this.env);\n  }\n\n  stop = () => {\n    this.detachListeners();\n    \n    this._isDrawing = false;\n\n    if (this.rubberband) {\n      this.rubberband.destroy();\n      this.rubberband = null;\n    }\n  }\n\n  onMouseMove = (x, y) =>\n    this.rubberband.dragTo([ x, y ]);\n\n  onMouseUp = (x, y) => {\n    this.onDblClick(x, y);\n  }\n\n  onDblClick = (x, y) => {\n    this._isDrawing = false;\n\n    this.rubberband.addPoint([ x, y ]);\n\n    this.detachListeners();\n\n    const { width, height } = this.rubberband.getBoundingClientRect();\n\n    const minWidth = this.config.minSelectionWidth || 4;\n    const minHeight = this.config.minSelectionHeight || 4;\n\n    if (width >= minWidth || height >= minHeight) {\n\n      const shape = this.rubberband.element;\n      shape.annotation = this.rubberband.toSelection();\n\n      this.emit('complete', shape);\n    } else {\n      this.emit('cancel');\n    }\n\n    this.stop();\n  }\n\n  get isDrawing() {\n    return this._isDrawing;\n  }\n\n  createEditableShape = annotation =>\n    new EditableFreehand(annotation, this.g, this.config, this.env);\n\n}\n\nRubberbandFreehandTool.identifier = 'freehand';\n\nRubberbandFreehandTool.supports = annotation => {\n  const selector = annotation.selector('SvgSelector');\n  if (selector)\n    return (selector.value?.match(/^<svg.*<path*/g) && !selector.value.toUpperCase().includes(\"Z\"));\n}","import { Selection } from '@recogito/annotorious/src/tools/Tool';\nimport { toSVGTarget } from '@recogito/annotorious/src/selectors/EmbeddedSVG';\nimport { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\n//import Mask from './MultipolygonMask';\n// TODO optional: mask to dim the outside area\n//import Mask from './multipolygonMask';\n\n/**\n * A 'rubberband' selection tool for creating multipolygon drawing by\n * clicking and dragging.\n */\nexport default class RubberbandMultipolygon {\n\n  constructor(anchor, g, env) {\n    this.points = [];\n    this.points.push([ anchor, anchor ])\n\n    this.env = env;\n\n    this.group = document.createElementNS(SVG_NAMESPACE, 'g');\n\n    this.multipolygon = document.createElementNS(SVG_NAMESPACE, 'g');\n    this.multipolygon.setAttribute('class', 'a9s-selection');\n\n    this.outer = document.createElementNS(SVG_NAMESPACE, 'path');\n    this.outer.setAttribute('class', 'a9s-outer');\n\n    this.inner = document.createElementNS(SVG_NAMESPACE, 'path');\n    this.inner.setAttribute('class', 'a9s-inner');\n\n    this.setPoints(this.points);\n    //this.mask = new Mask(env.image, this.inner);\n\n   // TODO optional: mask to dim the outside area\n   // this.mask = new Mask(env.image, this.inner);\n\n    this.multipolygon.appendChild(this.outer);\n    this.multipolygon.appendChild(this.inner);\n\n    // Additionally, selection remains hidden until \n    // the user actually moves the mouse\n    this.group.style.display = 'none';\n\n    // TODO optional: mask to dim the outside area\n    // this.group.appendChild(this.mask.element);\n    //this.group.appendChild(this.mask.element);\n    this.group.appendChild(this.multipolygon);\n\n    g.appendChild(this.group);\n  }\n\n  setPoints = points => {\n    var attr =\"\";\n    for (var ps of points){\n      var attr2=\"\"\n      if (ps.length>0){\n        for (var p of ps) {\n          if (p){\n            if (attr2===\"\"){\n              attr2  +=`M${p[0]},${p[1]}`;\n            }\n            else{\n              attr2  +=` L${p[0]},${p[1]}`;\n            }\n          }\n        };\n         attr+=attr2\n      }\n    }\n    attr+=\" Z\"\n    this.outer.setAttribute('d', attr);\n    this.inner.setAttribute('d', attr);\n  }\n\n  getBoundingClientRect = () =>{\n    console.log(\"getBoundingClientRect\", this.outer);\n    this.outer.getBoundingClientRect();\n  }\n    dragTo = xy => {\n      // Make visible\n      this.group.style.display = null;\n      const head = this.points[this.points.length - 1].slice(0, this.points[this.points.length - 1].length - 1);\n      var headRest=this.points.slice(0,-1)\n      const rubberband = [ ...head, xy, head[0] ];\n      headRest.push(rubberband)\n      this.setPoints(headRest);\n      //this.mask.redraw();\n    }\n  \n  addPoint = xy => {\n    // Don't add a new point if distance < 2 pixels\n    // console.log(\"Entering addpoint\", this.points[this.points.length - 1].length);\n    if (this.points[this.points.length - 1].length>0){\n      const head = this.points[this.points.length - 1].slice(0, this.points[this.points.length - 1].length - 1);\n      const lastCorner = head[head.length - 1];\n      const dist = Math.pow(xy[0] - lastCorner[0], 2) + Math.pow(xy[1] - lastCorner[1], 2);\n      if (dist > 4) {\n        this.points[this.points.length - 1] = [ ...head, xy, head[0] ];\n        this.setPoints(this.points);   \n        //this.mask.redraw();\n      } \n    } else{\n      this.points[this.points.length - 1] = [xy,xy];\n      // console.log(this.points[this.points.length - 1]);\n      this.setPoints(this.points);\n    }\n  }\n  undo = () => {\n    console.log(\"last\",this.points[this.points.length - 1].length);\n    if (this.points[this.points.length - 1].length>2){\n      this.points[this.points.length - 1].pop();\n    } else {\n      if (this.points.length>1){\n        this.points.pop()\n      }\n    }\n  }\n  newPart = () => {\n    // console.log(\"NewPart triggered\");\n    this.points.push([]);\n    // console.log(\"points after newPart: \", this.points);\n  }\n \n  get element() {\n    return this.multipolygon;\n  }\n\n  destroy = () => {\n    this.group.parentNode.removeChild(this.group);\n    this.multipolygon = null;    \n    this.group = null;\n  }\n\n  toSelection = () => {\n    return new Selection(toSVGTarget(this.group, this.env.image));\n  }\n\n}\n","import EditableShape from '@recogito/annotorious/src/tools/EditableShape';\nimport { svgFragmentToShape, toSVGTarget } from '@recogito/annotorious/src/selectors/EmbeddedSVG';\nimport { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\nimport { format, setFormatterElSize } from '@recogito/annotorious/src/util/Formatting';\n\n// TODO optional: mask to dim the outside area\n//import Mask from './MultipolygonMask';\n\nconst getPoints = (shape) => {\n  // Could just be Array.from(shape.querySelector('.inner').points) but...\n  // IE11 :-(\n  const pointLists = getPointsFromPathValue(shape.querySelector('.a9s-inner').attributes.d.nodeValue)\n  const pointArray = [];\n  for (let pointList of pointLists) {\n    let points = []\n    for (let point of pointList) {\n      let p = {\n        x:parseFloat(point[0]),\n        y:parseFloat(point[1])\n      }\n      points.push(p);\n    }\n    pointArray.push(points);\n  }\n\n  return pointArray;\n}\nconst getPointsFromPathValue = polygon => {\n  var results =polygon.split('M');\n  var allcoords = []\n  results.forEach(function (result, index) {\n    if (result.length>0){\n      let coords = []\n      result=result.replace(/ Z/g,\"Z\")\n      result=result.replace(/Z /g,\"Z\")\n      result=result.replace(/Z/g,\"\")\n      result=result.replace(/L /g,\"L\")\n      result=result.replace(/ L/g,\"L\")\n      var coordsString = result.split(\"L\")\n      coordsString.forEach(function(coord, index){\n        coords.push([parseFloat(coord.split(\",\")[0]).toFixed(2).toString(),parseFloat(coord.split(\",\")[1]).toFixed(2).toString()]);\n      });\n      if (coords[0] !== coords[coords.length - 1]){\n        coords.push(coords[0])\n      }\n      allcoords.push(coords)\n    }\n  });\n  return allcoords\n}\nconst getBBox = shape => {\n  return shape.querySelector('.a9s-inner').getBBox();\n}\nexport const svgFragmentToPoints = annotation => {\n  const svgShape = svgFragmentToShape(annotation);\n  var polygon = svgShape.getAttribute('d')\n  var allcoords =  getPointsFromPathValue(polygon)\n  return allcoords\n  //svgShape.getAttribute('d')\n  //  .split(' ') // Split x/y tuples\n  //  .map(xy => xy.split(',').map(str => parseFloat(str.trim())));\n}\n\nconst drawEmbeddedSVG = annotation => {\n  const shape = svgFragmentToShape(annotation);\n\n  // Hack\n  svgFragmentToPoints(annotation);\n\n  // Because we're nitpicky, we don't just draw the shape,\n  // but duplicate it, so we can have inner and an outer lines\n  const g = document.createElementNS(SVG_NAMESPACE, 'g');\n\n  const inner = shape.cloneNode(true);\n  inner.setAttribute('class', 'a9s-inner');\n\n  const outer = shape.cloneNode(true);\n  outer.setAttribute('class', 'a9s-outer');\n\n  g.appendChild(outer);\n  g.appendChild(inner);\n\n  return g;\n}\n/**\n * An editable multipolygon drawing.\n */\nexport default class EditableMultipolygon extends EditableShape {\n\n  constructor(annotation, g, config, env) {\n    super(annotation, g, config, env);\n\n    this.svg.addEventListener('mousemove', this.onMouseMove);\n    this.svg.addEventListener('mouseup', this.onMouseUp);\n\n    // SVG markup for this class looks like this:\n    // \n    // <g>\n    //   <path class=\"a9s-selection mask\"... />\n    //   <g> <-- return this node as .element\n    //     <polygon class=\"a9s-outer\" ... />\n    //     <polygon class=\"a9s-inner\" ... />\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //     <g class=\"a9s-handle\" ...> ... </g>\n    //     ...\n    //   </g> \n    // </g>\n\n    // 'g' for the editable free drawing compound shape\n    this.containerGroup = document.createElementNS(SVG_NAMESPACE, 'g');\n\n    this.shape = drawEmbeddedSVG(annotation);\n   // TODO optional: mask to dim the outside area\n   // this.mask = new Mask(env.image, this.shape.querySelector('.a9s-inner'));\n    \n   // this.containerGroup.appendChild(this.mask.element);\n\n    this.elementGroup = document.createElementNS(SVG_NAMESPACE, 'g');\n    this.elementGroup.setAttribute('class', 'a9s-annotation editable selected');\n    this.elementGroup.appendChild(this.shape);\n    let pointList = getPoints(this.shape);\n    this.handles = []\n    for (let points of pointList){\n      this.handles.push(points.map(pt => {\n        const handle = this.drawHandle(pt.x, pt.y);\n        handle.addEventListener('mousedown', this.onGrab(handle));\n        this.elementGroup.appendChild(handle);\n        return handle;\n      }))\n    } \n\n\n    this.containerGroup.appendChild(this.elementGroup);\n    g.appendChild(this.containerGroup);\n\n    format(this.shape, annotation, config.formatter);\n\n    this.shape.querySelector('.a9s-inner')\n      .addEventListener('mousedown', this.onGrab(this.shape));\n\n    const { x, y, width, height } = getBBox(this.shape);\n\n    // TODO optional: handles to stretch the shape\n/*    this.handles = [\n      [ x, y ], \n      [ x + width, y ], \n      [ x + width, y + height ], \n      [ x, y + height ]\n    ].map(t => { \n      const [ x, y ] = t;\n      const handle = this.drawHandle(x, y);\n      handle.addEventListener('mousedown', this.onGrab(handle));\n      this.elementGroup.appendChild(handle);\n      return handle;\n    });*/\n\n    // The grabbed element (handle or entire shape), if any\n    this.grabbedElem = null;\n\n    // Mouse grab point\n    this.grabbedAt = null;\n  }\n\n  setPoints = (points) => {\n    const round = num =>\n    Math.round(10 * num) / 10;\n\n    let str = \"\"\n    for (let pointList of points){\n      str += \"M\"\n      let first = true \n      for (let point of pointList){\n        if (first){\n          first = false\n          str += point.x.toString() + \",\" + point.y.toString()\n        } else {\n          str += \" L\" + round(point.x).toString() + \",\" + round(point.y).toString()\n        }\n      }\n      str += \" Z\"\n    }\n    const inner = this.shape.querySelector('.a9s-inner');\n    inner.setAttribute('d', str);\n\n    const outer = this.shape.querySelector('.a9s-outer');\n    outer.setAttribute('d', str);\n\n    // this.mask.redraw();\n\n    const { x, y, width, height } = outer.getBBox();\n    setFormatterElSize(this.elementGroup, x, y, width, height);\n  }\n\n\n    // TODO optional: handles to stretch the shape\n/*  stretchCorners = (draggedHandleIdx, anchorHandle, mousePos) => {\n    const anchor = this.getHandleXY(anchorHandle);\n  }*/\n\n  onGrab = grabbedElem => evt => {\n    this.grabbedElem = grabbedElem;\n    const pos = this.getSVGPoint(evt);\n    this.grabbedAt = { x: pos.x, y: pos.y };\n  }\n\n  onMouseMove = evt => {\n    if (this.grabbedElem) {\n\n      const pos = this.getSVGPoint(evt);\n\n      if (this.grabbedElem === this.shape) {\n        const dx = pos.x - this.grabbedAt.x;\n        const dy = pos.y - this.grabbedAt.y;\n\n        let pointList = getPoints(this.shape)\n\n        const updatedPoints = []\n        for (let points of pointList){\n          updatedPoints.push(points.map(pt =>\n            ({ x: pt.x + dx, y: pt.y + dy })))\n        } \n    \n        this.grabbedAt = pos;\n\n        this.setPoints(updatedPoints);\n        let i = 0\n        for (let updatedPointsList of updatedPoints){\n            updatedPointsList.forEach((pt, idx) => { \n              if (this.handles[i][idx] !== undefined)\n                this.setHandleXY(this.handles[i][idx], pt.x, pt.y)\n            });\n            i+=1\n        }\n        \n        this.emit('update', {\n          ...toSVGTarget(this.shape, this.env.image),\n          renderedVia: {\n            name: 'multipolygon'\n          }\n        });\n      } else {\n        let handleIdx = -1\n        let pointListIDX = 0\n        let found = false\n\n        for (let handle of this.handles){\n          if (handle.indexOf(this.grabbedElem)>0){\n            handleIdx = handle.indexOf(this.grabbedElem);\n            found=true\n          } else {\n            if (!found){\n              pointListIDX += 1\n            }\n          }\n        }\n  \n        let pointList = getPoints(this.shape)\n  \n        const updatedPoints = []\n        let updatedPointsIDX = 0\n        for (let points of pointList){\n          if (updatedPointsIDX === pointListIDX){\n            let newPoints = []\n            points.forEach(function (value, i) {\n              if (i === handleIdx){\n                newPoints.push(pos)\n              } else {\n                newPoints.push(value)\n              }\n            });\n            updatedPoints.push(newPoints)\n          } else {\n            updatedPoints.push(points)\n          }\n          updatedPointsIDX +=1\n        } \n       \n        this.setPoints(updatedPoints);\n        updatedPointsIDX = 0\n        for (let handle of this.handles){\n          if (updatedPointsIDX === pointListIDX){\n\n            this.setHandleXY(handle[handleIdx], pos.x, pos.y);\n          }\n          updatedPointsIDX +=1\n\n        }\n        \n        this.emit('update', {\n          ...toSVGTarget(this.shape, this.env.image),\n          renderedVia: {\n            name: 'multipolygon'\n          }\n        });\n      }\n    }\n  }\n\n  onMouseUp = evt => {\n    this.grabbedElem = null;\n    this.grabbedAt = null;\n  }\n\n  get element() {\n    return this.elementGroup;\n  }\n\n  updateState = annotation => {\n    const points = getPoints(svgFragmentToShape(annotation));\n    this.setPoints(points);\n  }\n\n  destroy = () => {\n    this.containerGroup.parentNode.removeChild(this.containerGroup);\n    super.destroy();\n  }\n\n}","import Tool from '@recogito/annotorious/src/tools/Tool';\nimport RubberbandMultipolygon from './RubberbandMultipolygon';\nimport EditableMultipolygon from './EditableMultipolygon';\n\n/**\n * A rubberband selector for Multipolygon fragments.\n */\nexport default class RubberbandMultipolygonTool extends Tool {\n\n  constructor(g, config, env) {\n    super(g, config, env);\n    this._isDrawing = false;\n    document.addEventListener('keydown', evt => {\n      //console.log(\"keyDown Driggered\",evt);\n      if (evt.key == \"z\" && evt.ctrlKey) {\n        // console.log(\"doing undo\");\n        this.undo();\n      }\n      if (evt.key == 'n') {\n        //console.log(\"n recognized\");\n        this.newPart();\n      }\n    });  }\n\n  startDrawing = (x, y) => {\n    this._isDrawing = true;\n    \n    this.attachListeners({\n      mouseMove: this.onMouseMove,\n      mouseUp: this.onMouseUp,\n      dblClick: this.onDblClick\n    });\n    \n    this.rubberband = new RubberbandMultipolygon([ x, y ], this.g, this.env);\n  }\n\n  stop = () => {\n    this.detachListeners();\n    \n    this._isDrawing = false;\n\n    if (this.rubberband) {\n      this.rubberband.destroy();\n      this.rubberband = null;\n    }\n  }\n  undo = () =>{\n    // console.log(\"rubberband undo\",this.rubberband);\n    if (this.rubberband){\n      this.rubberband.undo();\n\n    }\n    //console.log(this);\n  }\n  newPart = () =>{\n    if (this.rubberband){\n      this.rubberband.newPart();\n\n    }\n    //console.log(this);\n  }\n\n  onMouseMove = (x, y) =>\n    this.rubberband.dragTo([ x, y ]);\n\n  onMouseUp = (x, y, evt) => {\n    if (evt.altKey){\n      this.onDblClick(evt);\n    } else if (evt.ctrlKey) {\n      this.rubberband.undo();\n    } else{\n      const { width, height } = this.rubberband.getBoundingClientRect();\n\n      const minWidth = this.config.minSelectionWidth || 4;\n      const minHeight = this.config.minSelectionHeight || 4;\n      \n      if (width >= minWidth || height >= minHeight) {\n        this.rubberband.addPoint([ x, y ]);\n      } else {\n        this.emit('cancel');\n        this.stop();\n      }\n    }\n  }\n  \n  onDblClick = (x, y) => {\n    this._isDrawing = false;\n\n    this.rubberband.addPoint([ x, y ]);\n\n    const shape = this.rubberband.element;\n    shape.annotation = this.rubberband.toSelection();\n    this.emit('complete', shape);\n\n    this.stop();\n  }\n\n  get isDrawing() {\n    return this._isDrawing;\n  }\n\n  get isDrawing() {\n    return this._isDrawing;\n  }\n\n  createEditableShape = annotation => \n    new EditableMultipolygon(annotation, this.g, this.config, this.env);\n\n}\n\nRubberbandMultipolygonTool.identifier = 'multipolygon';\n\nRubberbandMultipolygonTool.supports = annotation => {\n  console.log(\"supports started\");\n  const selector = annotation.selector('SvgSelector');\n  console.log(\"selector\", selector);\n  console.log(selector.value?.match(/^<svg.*<path d=/g))\n  if (selector)\n    return selector.value?.match(/^<svg.*<path d=/g);\n}","import { Selection, ToolLike } from '@recogito/annotorious/src/tools/Tool';\nimport { toSVGTarget } from '@recogito/annotorious/src/selectors/EmbeddedSVG';\nimport { SVG_NAMESPACE } from '@recogito/annotorious/src/util/SVG';\n//import Mask from './MultipolygonMask';\n// TODO optional: mask to dim the outside area\n//import Mask from './multipolygonMask';\n\n/**\n * A 'rubberband' selection tool for creating multipolygon drawing by\n * clicking and dragging.\n */\nexport default class RubberbandBetterMultipolygon extends ToolLike  {\n\n  constructor(anchor, g, config, env) {\n    super(g, config, env);\n    //super(g, config, env);\n    this.points = [];\n    this.points.push([ anchor, anchor ])\n    this.mousepos = anchor;\n\n    this.env = env;\n    this.scale = 1;\n\n    this.group = document.createElementNS(SVG_NAMESPACE, 'g');\n    this.multipolygon = document.createElementNS(SVG_NAMESPACE, 'g');\n    this.multipolygon.setAttribute('class', 'a9s-selection a9s-multipolygon improved-polygon');\n\n    this.rubberband = document.createElementNS(SVG_NAMESPACE, 'polygon');\n    this.rubberband.setAttribute('class', 'a9s-rubberband');\n\n    this.closeHandle = this.drawHandle(anchor[0], anchor[1]);\n    this.closeHandle.style.display = 'none';\n\n    this.outer = document.createElementNS(SVG_NAMESPACE, 'path');\n    this.outer.setAttribute('class', 'a9s-outer');\n\n    this.inner = document.createElementNS(SVG_NAMESPACE, 'path');\n    this.inner.setAttribute('class', 'a9s-inner');\n\n    this.setPoints(this.points);\n    //this.mask = new Mask(env.image, this.inner);\n\n   // TODO optional: mask to dim the outside area\n   // this.mask = new Mask(env.image, this.inner);\n\n    this.multipolygon.appendChild(this.rubberband)\n    this.multipolygon.appendChild(this.outer);\n    this.multipolygon.appendChild(this.inner);\n    this.multipolygon.appendChild(this.closeHandle);\n\n    // Additionally, selection remains hidden until \n    // the user actually moves the mouse\n    this.group.style.display = 'none';\n\n    // TODO optional: mask to dim the outside area\n    // this.group.appendChild(this.mask.element);\n    //this.group.appendChild(this.mask.element);\n    this.group.appendChild(this.multipolygon);\n\n    g.appendChild(this.group);\n  }\n\n  setPoints = points => {\n    var attr =\"\";\n    for (var ps of points){\n      var attr2=\"\"\n      if (ps.length>0){\n        for (var p of ps) {\n          if (p){\n            if (attr2===\"\"){\n              attr2  +=`M${p[0]},${p[1]}`;\n            }\n            else{\n              attr2  +=` L${p[0]},${p[1]}`;\n            }\n          }\n        };\n         attr+=attr2\n      }\n    }\n    attr+=\" Z\"\n    this.outer.setAttribute('d', attr);\n    this.inner.setAttribute('d', attr);\n  }\n  close = () => {\n    const multipolygon = new multipolygon(toSVGTarget(this.points, this.env.image));\n    this.emit('close', { shape: this.multipolygon, multipolygon });\n  }\n\n  getBoundingClientRect = () => {\n     return this.outer.getBoundingClientRect();\n  }\n\n  dragTo = xy => {\n    // Make visible\n    this.group.style.display = null;\n    this.mousepos = xy;\n    const head = this.points[this.points.length - 1].slice(0, this.points[this.points.length - 1].length - 1);\n    var headRest=this.points.slice(0,-1)\n    const rubberband = [ ...head, xy, head[0] ];\n    headRest.push(rubberband)\n    this.setPoints(headRest);\n    //this.mask.redraw();\n  }\n  onScaleChanged = scale => {\n    this.scale = scale;\n\n    const inner = this.closeHandle.querySelector('.a9s-handle-inner');\n    const outer = this.closeHandle.querySelector('.a9s-handle-outer');\n\n    const radius = scale * (this.config.handleRadius || 6);\n\n    inner.setAttribute('r', radius);\n    outer.setAttribute('r', radius);\n  }\n    \n  addPoint = xy => {\n    // Don't add a new point if distance < 2 pixels\n    if (this.points[this.points.length - 1].length>0){\n      const head = this.points[this.points.length - 1].slice(0, this.points[this.points.length - 1].length - 1);\n      const lastCorner = head[head.length - 1];\n      const dist = Math.pow(xy[0] - lastCorner[0], 2) + Math.pow(xy[1] - lastCorner[1], 2);\n      if (dist > 4) {\n        this.points[this.points.length - 1] = [ ...head, xy, head[0] ];\n        this.setPoints(this.points);   \n        //this.mask.redraw();\n      } \n    } else{\n      this.points[this.points.length - 1] = [xy,xy];\n      this.setPoints(this.points);\n    }\n  }\n  undo = () => {\n    this.pop()\n  }\n\n  isClosable = () => {\n    const d = this.getDistanceToStart();\n    return d < 6 * this.scale;\n  }\n  /** Removes last corner **/\n  pop = () => {\n    if (this.points[this.points.length - 1].length>2){\n      this.points[this.points.length - 1].pop();\n    } else {\n      if (this.points.length>1){\n        this.points.pop()\n      }\n    }\n    this.setPoints(this.points);\n    // this.mask.redraw();\n  }\n\n  newPart = () => {\n    this.points.push([]);\n  }\n \n  get element() {\n    return this.multipolygon;\n  }\n  getDistanceToStart = () => {\n    if (this.points[this.points.length-1].length < 3)\n      return Infinity; // Just return if not at least 3 points\n\n    const dx = Math.abs(this.mousepos[0] - this.points[this.points.length-1][0][0]);\n    const dy = Math.abs(this.mousepos[1] - this.points[this.points.length-1][0][1]);\n\n    return Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2)) / this.scale;\n  }\n\n  destroy = () => {\n    this.group.parentNode.removeChild(this.group);\n    this.multipolygon = null;    \n    this.group = null;\n  }\n  toSelection = () => {\n    return new Selection(toSVGTarget(this.group, this.env.image));\n  }\n\n}\n","/**\n * Computes the area of the polygon defined by\n * the given conrner points.\n * @param {Array} points \n * @returns {number} the area\n */\nexport const polygonArea = points => {\n  let area = 0;\n  let j = points.length - 1;\n\n  for (let i=0; i < points.length; i++) {\n    area += (points[j][0] + points[i][0]) * (points[j][1] - points[i][1]);\n    j = i;\n  }\n\n  return Math.abs(0.5 * area);\n}\n\n/**\n * Hit test: checks if this point is inside the circle.\n * @param {Array} point the point [x, y]\n * @param {number} cx circle center x\n * @param {number} cy circle center y\n * @param {number} r circle radius\n * @returns {boolean} \n */\nexport const pointInCircle = (point, cx, cy, r) => {\n  const dx = point[0] - cx;\n  const dy = point[1] - cy;\n\n  const d = Math.sqrt(dx * dx + dy * dy);\n  return d <= r;\n}\n\n/**\n * Hit test: checks if this point is inside the ellipse.\n * Cf. https://github.com/w8r/point-in-ellipse\n * @param {Array} point the point [x, y] \n * @param {number} cx ellipse center x \n * @param {number} cy ellipse center y\n * @param {number} rx ellipse x radius\n * @param {number} ry ellipse y radius\n * @param {number=} rotation ellipse rotation \n * @returns {boolean}\n */\nexport const pointInEllipse = (point, cx, cy, rx, ry, rotation) => {\n  const rot = rotation || 0;\n\n  const cos = Math.cos(rot);\n  const sin = Math.sin(rot);\n\n  const dx  = point[0] - cx;\n  const dy  = point[1] - cy;\n\n  const tdx = cos * dx + sin * dy;\n  const tdy = sin * dx - cos * dy;\n\n  return (tdx * tdx) / (rx * rx) + (tdy * tdy) / (ry * ry) <= 1;\n}\n\n/**\n * Hit test: checks if this point is inside the polygon.\n * @param {Array} xy the point [x, y]\n * @param {Array<number>} points polygon corner points \n * @returns {boolean}\n */\nexport const pointInsidePoygon = (point, polygon) => {\n  \n  var n=polygon.length,\n  is_in=false,\n  x=point[0],\n  y=point[1],\n  x1,x2,y1,y2;\n\nfor(var i=0; i < n-1; ++i){\n  x1=polygon[i][0];\n  x2=polygon[i+1][0];\n  y1=polygon[i][1];\n  y2=polygon[i+1][1];\n\n  if(y < y1 != y < y2 && x < (x2-x1) * (y-y1) / (y2-y1) + x1){\n      is_in=!is_in;\n  }\n}\n\nreturn is_in;\n};\n\nexport const isHole = (polygon1, polygon2) => {\n  // Algorithm checks, if polygon1 is in polygon2\n  for (var point of polygon1){\n    if (!pointInPolygon(point, polygon2)) return false\n  }\n  return true;\n}\n\nexport const pointInPolygon = (point, polygon) => {\n\n  var n=polygon.length,\n  is_in=false,\n  x=point[0],\n  y=point[1],\n  x1,x2,y1,y2;\n\n  for(var i=0; i < n-1; ++i){\n    x1=polygon[i][0];point\n    x2=polygon[i+1][0];\n    y1=polygon[i][1];\n    y2=polygon[i+1][1];\n\n    if(y < y1 != y < y2 && x < (x2-x1) * (y-y1) / (y2-y1) + x1){\n        is_in=!is_in;\n    }\n  }\n  return is_in;\n};\n\n\n/**\n * Checks if polygon A is contained fully inside polygon B.\n * @param {Array<Array<number>>} polygonA array of points [x, y] \n * @param {Array<Array<number>>} polygonB array of points [x, y]\n * @returns {boolean}\n */\nexport const polygonInPolygon = (polygonA, polygonB) => {\n  for (let point of polygonA) {\n    if (!pointInPolygon(point, polygonB)) \n      return false\n  }\n\n  return true;\n}\n\n/** \n * Hit test: checks if this point is inside the line.\n * @param {Array} xy the point [x, y]\n * @param number x1 line start x\n * @param number y1 line start y\n * @param number x2 line end x\n * @param number y2 line end y\n * @param number buffer around the line\n * @returns {boolean}\n */\nexport const pointInLine = (xy, x1, y1, x2, y2, buffer) => {\n  const x = xy[0];\n  const y = xy[1];\n\n  const dx = x2 - x1;\n  const dy = y2 - y1;\n  const d = Math.sqrt(dx * dx + dy * dy);\n  const cross = Math.abs((x - x1) * dy - (y - y1) * dx);\n  const dist = cross / d;\n\n  return dist <= buffer;\n}\n\n/**\n * A utility helper that parses an SVG path into \n * a list of polygons.\n * @param {SVGElement} path the SVG path\n * @returns {Array<Array<Array<number>>>} list of polygons \n */\nexport const svgPathToPolygons = path => {\n  const commands = path.getAttribute('d')\n    .split(/(?=M|m|L|l|H|h|V|v|Z|z)/g)\n    .map(str => str.trim());\n  const polygons = [];\n\n  let points = [];\n\n  for (let cmd of commands) {\n    const op = cmd.substring(0, 1);\n    let xy\n    if (op.toLowerCase() === 'z') {\n      polygons.push([...points]);\n      points = [];\n    } else {\n      if (cmd.includes(\",\")){\n        xy = cmd.substring(1).split(',').map(str => parseFloat(str.trim()));\n      } else {\n        xy = cmd.substring(1).split(' ').map(str => parseFloat(str.trim()));\n\n      }\n      // Uppercase ops are absolute coords -> transform\n      const isUppercase = op === op.toUpperCase();\n\n      const x = isUppercase ? xy[0] : xy[0] + points[points.length - 1][0];\n      const y = isUppercase ? xy[1] : xy[1] + points[points.length - 1][1];\n\n      points.push([x, y]);\n    }\n  }\n\n  if (points.length > 0) // Unclosed path - close for area computation\n    polygons.push([...points]); \n  return polygons;\n}","import EditableShape from '@recogito/annotorious/src/tools/EditableShape';\nimport { SVG_NAMESPACE, addClass, hasClass, removeClass } from '@recogito/annotorious/src/util/SVG';\nimport { format, setFormatterElSize } from '@recogito/annotorious/src/util/Formatting';\nimport { svgFragmentToShape } from '@recogito/annotorious/src/selectors/EmbeddedSVG';\nimport { pointInPolygon } from '@recogito/annotorious/src/util/Geom2D';\nimport RubberbandBetterMultipolygon from './RubberbandBetterMultipolygon';\n\nimport { toSVGTarget, getPath } from './RubberbandBetterMultipolygonTool';\n\nconst getPointsFromPathValue = polygon => {\n  var results =polygon.split('M');\n  var allcoords = []\n  results.forEach(function (result, index) {\n    if (result.length>0){\n      let coords = []\n      result=result.replace(/ Z/g,\"Z\")\n      result=result.replace(/Z /g,\"Z\")\n      result=result.replace(/Z/g,\"\")\n      result=result.replace(/L /g,\"L\")\n      result=result.replace(/ L/g,\"L\")\n      var coordsString = result.split(\"L\")\n      coordsString.forEach(function(coord, index){\n        coords.push([parseFloat(coord.split(\",\")[0]).toFixed(2).toString(),parseFloat(coord.split(\",\")[1]).toFixed(2).toString()]);\n      });\n      if (coords[0][0] !== coords[coords.length - 1][0] && coords[0][1] !== coords[coords.length - 1][1]){\n        coords.push(coords[0])\n      }\n      allcoords.push(coords)\n    }\n  });\n  return allcoords\n}\n\n\nconst getPoints = (shape) => {\n  // Could just be Array.from(shape.querySelector('.inner').points) but...\n  // IE11 :-(\n  const pointLists = getPointsFromPathValue(shape.querySelector('.a9s-inner').attributes.d.nodeValue)\n  const pointArray = [];\n  for (let pointList of pointLists) {\n    let points = []\n    for (let point of pointList) {\n      let p = {\n        x:parseFloat(point[0]),\n        y:parseFloat(point[1])\n      }\n      points.push(p);\n    }\n    pointArray.push(points)\n  }\n  return pointArray;\n}\n\nconst getBBox = shape => {\n  return shape.querySelector('.a9s-inner').getBBox();\n}\nexport const svgFragmentToPoints = annotation => {\n  const svgShape = svgFragmentToShape(annotation);\n  var polygon = svgShape.getAttribute('d')\n  var allcoords =  getPointsFromPathValue(polygon)\n  return allcoords\n}\n\nconst drawEmbeddedSVG = annotation => {\n  const shape = svgFragmentToShape(annotation);\n  // Hack\n  svgFragmentToPoints(annotation);\n\n  // Because we're nitpicky, we don't just draw the shape,\n  // but duplicate it, so we can have inner and an outer lines\n  const g = document.createElementNS(SVG_NAMESPACE, 'g');\n\n  const inner = shape.cloneNode(true);\n  inner.setAttribute('class', 'a9s-inner');\n\n  const outer = shape.cloneNode(true);\n  outer.setAttribute('class', 'a9s-outer');\n\n  g.appendChild(outer);\n  g.appendChild(inner);\n  return g;\n}\n  \nexport default class EditableBetterMultipolygon extends EditableShape {\n\n  constructor(annotation, g, config, env) {\n    super(annotation, g, config, env);\n    this.svg.addEventListener('mousemove', this.onMouseMove);\n    this.svg.addEventListener('mouseup', this.onMouseUp);\n    // This part is added to track time of annotation process. It is not confirm with W3C-Annotations\n    if (!this.annotation.underlying[\"generated\"]){\n      console.log(\"generated\", Date.now());\n      this.annotation.underlying[\"generated\"] = Date.now()\n    }\n    document.body.addEventListener('keydown', this.onKeyDown);\n\n    // Container wraps the mask + editable shape\n    this.container = document.createElementNS(SVG_NAMESPACE, 'g');\n\n    // The editable shape group\n    this.shape = drawEmbeddedSVG(annotation);\n    this.shape.setAttribute('class', 'a9s-annotation editable selected improved-polygon');\n    this.elementGroup = document.createElementNS(SVG_NAMESPACE, 'g');\n    this.elementGroup.setAttribute('class', 'a9s-annotation editable selected');\n    this.elementGroup.appendChild(this.shape);\n    let cornerList = getPoints(this.shape);\n    this.cornerHandles = []\n    this.midpoints = []\n    for (let corners of cornerList){\n      let midpoints = []\n      this.cornerHandles.push(corners.map((pt, idx) => {\n        midpoints.push(this.createMidpoint(corners, idx));\n        const handle = this.createCornerHandle(pt);\n        return handle;\n      }))\n      this.midpoints.push(midpoints);\n    }\n    this.container.appendChild(this.elementGroup)\n    g.appendChild(this.container);\n    // Format needs to go after everything is added to the DOM\n    format(this.shape, annotation, config.formatter);\n    this.shape.querySelector('.a9s-inner')\n      .addEventListener('mousedown', this.onGrab(this.shape));\n\n    // Grabbed element and grab offset\n    this.grabbedElement = null;\n    this.grabbedAt = null;\n\n    // Selected corners\n    this.selected = [];\n\n    this.lastMouseDown = null;\n  }\n\n  createCornerHandle = pt => {\n    const handle = this.drawHandle(pt.x, pt.y);\n    handle.addEventListener('mousedown', this.onGrab(handle));\n    handle.addEventListener('click', this.onSelectCorner(handle));\n    this.scaleHandle(handle);\n\n    this.elementGroup.appendChild(handle);\n    return handle;\n  }\n\n  createMidpoint = (corners, idx) => {\n    // Create point between this and previous corner\n    const thisCorner = corners[idx];\n    const nextCorner = idx === corners.length - 1 ? corners[0] : corners[idx + 1];\n    const x = (thisCorner.x + nextCorner.x) / 2;\n    const y = (thisCorner.y + nextCorner.y) / 2;\n    const handle = this.drawMidpoint(x, y);\n    handle.addEventListener('mousedown', this.onGrab(handle));\n\n    this.shape.appendChild(handle);\n    return handle;\n  }\n\n  deleteSelected = () => {\n    console.log(\"delete selected\");\n    const points = getPoints(this.shape);\n    \n    if (this.selected.length > 0 ) {\n      let cornerhandlesIDX = -1\n      let updatedPoints = []\n      // Update midpoints\n      let newMidpoints = []\n      for (let midpointList of this.midpoints){\n        let updatedMidpointlist = midpointList.filter((object, i) => {\n          return this.selected.map(object => (object[0] === cornerhandlesIDX && object[1] === i)).indexOf(true) === -1\n        });      \n        let midpointsToDelete = midpointList.filter((object, i) => {\n          return this.selected.map(object => (object[0] === cornerhandlesIDX && object[1] === i)).indexOf(true) > -1\n        });\n        midpointsToDelete.forEach(h => h.parentNode.removeChild(h));\n        if (updatedMidpointlist.length > 2){\n          newMidpoints.push(updatedMidpointlist)\n        }\n      }\n      for (let pointList of points){\n        cornerhandlesIDX += 1\n        let updatedPointlist = pointList.filter((object, i) => {\n          return this.selected.map(object => (object[0] === cornerhandlesIDX && object[1] === i)).indexOf(true) === -1\n        });\n        if (updatedPointlist.length > 2){\n          updatedPoints.push(updatedPointlist)\n        }\n      }\n      cornerhandlesIDX = -1\n      let updatedHandles = []\n      for (let handlesList of this.cornerHandles){\n        cornerhandlesIDX += 1\n        let handlesToDelete = handlesList.filter((object, i) => {\n          if (this.selected.map(object => (object[0] === cornerhandlesIDX && object[1] === i)).indexOf(true) !== -1){\n            return true\n          } else {\n            return false\n          } \n        });\n        let handlesToStay = handlesList.filter((object, i) => {\n          return this.selected.map(object => (object[0] === cornerhandlesIDX && object[1] === i)).indexOf(true) === -1\n        });\n        if (handlesToStay.length > 2){\n          updatedHandles.push(handlesToStay)\n        }\n        handlesToDelete.forEach(h => h.parentNode.removeChild(h));\n      }\n      this.midpoints = newMidpoints\n      // Update corner handles\n\n      this.cornerHandles = updatedHandles\n      this.selected = []\n\n      this.setPoints(updatedPoints);\n      // this.emit('update', toSVGTarget(updatedPoints, this.env.image));\n    }\n  }\n\n  deselectCorners = () =>\n    this.cornerHandles.forEach(h => removeClass(h, 'selected'));\n\n  destroy = () => {\n    this.container.parentNode.removeChild(this.container);\n\n    this.svg.removeEventListener('mousemove', this.onMouseMove);\n    this.svg.removeEventListener('mouseup', this.onMouseUp);\n\n    document.body.removeEventListener('keydown', this.onKeyDown);\n\n    super.destroy();\n  }\n\n  drawMidpoint = (x, y) => {\n    const handle = document.createElementNS(SVG_NAMESPACE, 'circle');\n    handle.setAttribute('class', 'a9s-midpoint');\n    \n    handle.setAttribute('cx', x);\n    handle.setAttribute('cy', y);\n    handle.setAttribute('r', 5 * this.scale);\n\n    return handle;\n  }\n\n  get element() {\n    return this.elementGroup;\n  }\n\n  onAddPoint = pos => {\n    const corners = getPoints(this.shape);\n    let idx = -1\n    let midpointsIDX = -1\n    for (let midpointList of this.midpoints){\n      midpointsIDX += 1\n      idx = midpointList.indexOf(this.grabbedElement);\n      if (idx > -1){\n        break;\n      }\n    }\n    // Updated polygon points\n    let updatedCorners = []\n    let updatedcornerListIdx = -1\n    let midBefore = null\n    let midAfter = null\n    for (let cornerList of corners){\n      updatedcornerListIdx +=1\n      if (updatedcornerListIdx === midpointsIDX){\n        let updatedCornersList = []\n        let updatedcornerIdx = -1\n        for (let corner of cornerList){\n          updatedcornerIdx += 1\n          updatedCornersList.push(corner)     \n          if (updatedcornerIdx === idx){\n            updatedCornersList.push(pos)\n            midBefore = this.createMidpoint(cornerList, updatedcornerIdx -1);\n            midAfter = this.createMidpoint(cornerList, updatedcornerIdx);          \n          }\n        }\n        updatedCorners.push(updatedCornersList)\n      } else {\n        updatedCorners.push(cornerList)\n      }\n      \n    }\n\n    // New corner handle\n    const cornerHandle = this.createCornerHandle(pos);\n    this.cornerHandles[midpointsIDX] = [\n      ...this.cornerHandles[midpointsIDX].slice(0, idx+1),\n      cornerHandle,\n      ...this.cornerHandles[midpointsIDX].slice(idx+1)\n    ];\n    this.midpoints[midpointsIDX] = [\n      ...this.midpoints[midpointsIDX].slice(0, idx),\n      midBefore,\n      midAfter,\n      ...this.midpoints[midpointsIDX].slice(idx + 1)\n    ];\n    // Delete old midpoint\n    this.grabbedElement.parentNode.removeChild(this.grabbedElement);\n    \n    // Make the newly created corner dragged element + selection\n    this.grabbedElement = cornerHandle;\n    //this.onSelectCorner(cornerHandle)();\n\n    // Update shape\n    this.setPoints(updatedCorners);\n  }\n\n  onGrab = element => evt => {\n    if (evt.button !== 0) return;  // left click\n    evt.stopPropagation();\n\n    this.grabbedElement = element;\n    this.grabbedAt = this.getSVGPoint(evt);\n    this.lastMouseDown = new Date().getTime();\n  }\n\n  onKeyDown = ({ which }) => {\n    if (which === 46) {\n      this.deleteSelected();\n    }\n  }\n\n  onMoveShape = pos => {\n    const constrain = (coord, delta, max) =>\n      coord + delta < 0 ? -coord : (coord + delta > max ? max - coord : delta);\n    const { x, y, width, height } = getBBox(this.shape);\n    const { naturalWidth, naturalHeight } = this.env.image;\n\n    const dx = constrain(x, pos.x - this.grabbedAt.x, naturalWidth - width);\n    const dy = constrain(y, pos.y - this.grabbedAt.y, naturalHeight - height);\n    let updatedPoints = []\n    for (let pointlist of getPoints(this.shape)){\n      let newPointList = pointlist.map(pt => ([ pt.x , pt.y ]))\n      if (pointInPolygon([this.grabbedAt.x,this.grabbedAt.y], newPointList)){\n        updatedPoints.push(pointlist.map(pt =>\n          ({ x: pt.x + dx, y: pt.y + dy })))    \n      } else {\n        updatedPoints.push(pointlist)\n      }\n    }\n    this.grabbedAt = pos;\n\n    // Update shape\n    this.setPoints(updatedPoints);\n  }\n\n  onMoveCornerHandle = (pos, evt) => {\n    let handleIdx = -1\n    let cornerHandleIdx = 0\n    for (let cornerHandle of this.cornerHandles){\n      handleIdx = cornerHandle.indexOf(this.grabbedElement);\n      if (handleIdx > -1){ \n        break\n      } else {\n        cornerHandleIdx += 1\n      }\n    }\n    \n    // Update selection\n    if (evt.ctrlKey) {\n      this.selected = Array.from(new Set([...this.selected, handleIdx]));\n    } else if (!this.selected.includes(handleIdx)) {\n      this.selected = [ handleIdx ];\n    }\n\n    // Compute offsets between selected points from current selected\n    const points = getPoints(this.shape);\n\n    const distances = this.selected.map(idx => {\n      const handleXY = points[cornerHandleIdx][handleIdx];\n      const thisXY = points[cornerHandleIdx][idx];\n\n      return {\n        index: idx,\n        dx: thisXY.x - handleXY.x,\n        dy: thisXY.y - handleXY.y\n      }\n    });\n    let cornerHandleIdxUpdate = 0\n    let updatedPoints = []\n    for (let points of getPoints(this.shape)){\n      if (cornerHandleIdxUpdate === cornerHandleIdx){\n        let updatedPointList = points.map((pt, idx) => {\n          if (idx === handleIdx) {\n            // The dragged point\n            return pos;\n          } else if (this.selected.includes(idx)) {\n            const { dx, dy } = distances.find(d => d.index === idx);\n            return {\n              x: pos.x + dx,\n              y: pos.y + dy\n            }\n          } else {\n            // Unchanged\n            return pt;\n          }\n        });\n        updatedPoints.push(updatedPointList);\n      } else {\n        updatedPoints.push(points)\n      }\n      cornerHandleIdxUpdate += 1\n    }\n    this.setPoints(updatedPoints);\n  }\n\n  onMouseMove = evt => {\n    if (this.grabbedElement) {\n      const pos = this.getSVGPoint(evt);\n      if (this.grabbedElement === this.shape) {\n        this.onMoveShape(pos);\n      } else if (hasClass(this.grabbedElement, 'a9s-handle')) {\n        this.onMoveCornerHandle(pos, evt);\n      } else if (hasClass(this.grabbedElement, 'a9s-midpoint')) {\n        this.onAddPoint(pos);\n      }\n\n      this.emit('update', toSVGTarget(getPoints(this.shape), this.env.image));\n    }\n  }\n\n  onMouseUp = evt => {\n    this.grabbedElement = null;\n    this.grabbedAt = null;\n  }\n\n  onScaleChanged = scale => {\n    for (let cornerHandle of this.cornerHandles){\n      cornerHandle.map(this.scaleHandle);\n    }\n    for (let midpoints of this.midpoints){\n      midpoints.map(midpoint => {\n        midpoint.setAttribute('r', 5 * this.scale);\n      });\n    }\n  }\n\n  onSelectCorner = handle => evt => {\n    const isDrag = new Date().getTime() - this.lastMouseDown > 250;\n\n    if (!isDrag) {\n      let cornerhandlesIDX = -1\n      let idx = -1\n      for (let corners of this.cornerHandles){\n        cornerhandlesIDX += 1\n        idx = corners.indexOf(handle);  \n        if (idx > 0) break\n      }\n\n      if (evt?.ctrlKey) {\n        // Toggle\n        if ( this.selected.map(object => (object[0] === cornerhandlesIDX && object[1] === idx)).indexOf(true) > -1) {\n          this.selected = this.selected.filter(i => {\n            return !(i[1] === idx && i[0] === cornerhandlesIDX)\n          });\n        } else \n          this.selected = [...this.selected, [cornerhandlesIDX, idx]];\n      } else { \n        if (this.selected.length === 1 && (this.selected[0][1] === idx && this.selected[0][0] === cornerhandlesIDX)) {\n          this.selected = [];\n        } else {\n          this.selected = [[cornerhandlesIDX, idx ]];\n        }\n      }\n\n      this.setPoints(getPoints(this.shape));\n    }\n  }\n\n  setPoints = points => {\n    // Not using .toFixed(1) because that will ALWAYS\n    // Set polygon points\n    const str = getPath(points);\n    const inner = this.shape.querySelector('.a9s-inner');\n    inner.setAttribute('d', str);\n\n    const outer = this.shape.querySelector('.a9s-outer');\n    outer.setAttribute('d', str);\n\n    // Corner handles\n    let cornerIdx = 0\n    for (let pointList of points){\n      console.log(\"pointList of points\", pointList, points);\n      pointList.forEach((pt, idx) => {\n        this.setHandleXY(this.cornerHandles[cornerIdx][idx], pt.x, pt.y)\n      });\n    // Midpoints\n      for (let idx=0; idx<pointList.length; idx++) {\n        const thisCorner = pointList[idx];\n        const nextCorner = idx === pointList.length - 1 ? pointList[0] : pointList[idx + 1];\n        const x = (thisCorner.x + nextCorner.x) / 2;\n        const y = (thisCorner.y + nextCorner.y) / 2;\n\n        const handle = this.midpoints[cornerIdx][idx];\n        handle.setAttribute('cx', x);\n        handle.setAttribute('cy', y);\n      }\n        cornerIdx +=1\n    }\n    let cornerHandleIdx = -1\n    for (let corners of this.cornerHandles){\n      cornerHandleIdx += 1\n\n      corners.forEach((handle, i) => {\n        \n        const isSelected = this.selected.map(object => (object[0] === cornerHandleIdx && object[1] === i)).indexOf(true) > -1;\n        if (isSelected && !hasClass(handle, 'selectedCorner')) {\n          addClass(handle, 'selectedCorner');\n        } else if (!isSelected && hasClass(handle, 'selectedCorner')) {\n          removeClass(handle, 'selectedCorner');\n        }\n      });  \n    }\n\n    // Resize formatter elements\n    const { x, y, width, height } = outer.getBBox();\n    setFormatterElSize(this.shape, x, y, width, height);\n  }\n\n  updateState = annotation => {\n    const shape = drawEmbeddedSVG(annotation);\n    const points = getPoints(shape);\n    this.setPoints(points);\n  }\n\n}","import RBush from 'rbush';\nimport Tool from '@recogito/annotorious/src/tools/Tool';\nimport RubberbandBetterMultipolygon from './RubberbandBetterMultipolygon';\nimport EditableBetterMultipolygon from './EditableBetterMultipolygon';\nimport { isTouchDevice } from '@recogito/annotorious/src/util/Touch';\n\n/**\n * A rubberband selector for Multipolygon fragments.\n */\nclass MyRBush extends RBush {\n  toBBox([x, y]) { return {minX: x, minY: y, maxX: x, maxY: y}; }\n  compareMinX(a, b) { return a.x - b.x; }\n  compareMinY(a, b) { return a.y - b.y; }\n}\n\nconst isTouch = isTouchDevice();\nexport const getPath = (points) => {\n  const round = num => Math.round(10 * num) / 10;\n  let path = \"\"\n  for (let pointList of points){\n    path += \"M\"\n    let first = true \n    for (let point of pointList){\n      if (first){\n        first = false\n        path += round(point.x).toString() + \",\" + round(point.y).toString()\n      } else {\n        path += \" L\" + round(point.x).toString() + \",\" + round(point.y).toString()\n      }\n    }\n    path += \" Z\"\n  }\n  return path\n}\nexport const toSVGTarget = (points, image) => ({\n  source: image?.src,\n  selector: {\n    type: \"SvgSelector\",\n    value: `<svg><path d=\"${getPath(points)}\" /></svg>`\n  }\n});\n\nexport default class RubberbandBetterMultipolygonTool extends Tool {\n\n  constructor(g, config, env) {\n    super(g, config, env);\n    this._isDrawing = false;\n    this.startTime = -1\n    this.contourPointsFunc = null\n    this.contourPoints = []\n    this.contourPointsRBush = new MyRBush()\n    this.viewer = null\n    window.addEventListener('keydown', evt => {\n      if (evt.key === \"z\" && evt.ctrlKey) {\n        this.undo();\n      } else if (evt.key === 'n' || evt.key === 'p') {\n        this.newPart();\n      }\n    });\n    this._startOnSingleClick = false;\n  }\n  get isDrawing() {\n    return this._isDrawing;\n  }\n\n  startDrawing = (x, y, startOnSingleClick, evt, contourPoints) => {\n    this._isDrawing = true\n    console.log(\"start drawing. startTime:\", Date.now());\n    this.startTime = Date.now()\n    this.contourPoints = contourPoints;\n    if (!startOnSingleClick){\n      this._startOnSingleClick = false \n    } else {\n      this._startOnSingleClick = startOnSingleClick;\n    }\n    this.svg.addEventListener('mousedown', this.onMouseDown);\n    this.attachListeners({\n      mouseMove: this.onMouseMove,\n      mouseUp: this.onMouseUp,\n      dblClick: this.onDblClick\n    });\n    \n    this.rubberband = new RubberbandBetterMultipolygon([ x, y ], this.g, this.config, this.env);\n    this.rubberband.on('close', ({ shape, selection }) => {\n      shape.annotation = selection;\n      this.emit('complete', shape);  \n      this.stop();\n    }); \n  }\n\n  stop = () => {\n    this.detachListeners();\n    \n    this._isDrawing = false;\n\n    if (this.rubberband) {\n      this.rubberband.destroy();\n      this.rubberband = null;\n    }\n  }\n  undo = () =>{\n    if (this.rubberband){\n      this.rubberband.undo();\n\n    }\n  }\n\n\n  newPart = () =>{\n    if (this.rubberband){\n      this.rubberband.newPart();\n\n    }\n  }\n\n  onMouseMove = (x, y, evt) => {\n    this.rubberband.dragTo([ x, y ]);\n    if (false){\n      if (this.contourPoints){\n        if (this.contourPoints.length !== 0){\n          if (this.contourPoints.length > 0){\n            const closest = this.contourPointsRBush.search({\n              minX: (x - 10),\n              minY: (y - 10),\n              maxX: (x + 10),\n              maxY: (y + 10)\n            })\n            let closestPoint = {\n              \"point\": [0,0],\n              \"dist\": 100\n            }\n            for (const closePoint of closest){\n              const dist = Math.hypot(x-closePoint[0], y-closePoint[1])\n              \n              if (dist < closestPoint.dist){\n                closestPoint.point = closePoint\n                closestPoint.dist = dist\n              }\n            }\n            if (closestPoint.dist < 5){\n              this.rubberband.addPoint([ x, y ]);\n            }\n  \n          }\n        } else {\n        }\n      }\n    }\n  }\n  setContourPoints(contourPoints, viewer){\n    this.contourPointsFunc = contourPoints\n    this.viewer = viewer\n  }\n\n  onMouseUp = (x, y, evt) => {\n    if (evt.altKey){\n      this.onDblClickOld(evt);\n    } else if (evt.ctrlKey) {\n      this.rubberband.undo();\n    } else if (evt.shiftKey) {\n      this.newPart();\n    } else{\n      const { width, height } = this.rubberband.getBoundingClientRect();\n\n      const minWidth = this.config.minSelectionWidth || 4;\n      const minHeight = this.config.minSelectionHeight || 4;\n      if (width >= minWidth || height >= minHeight) {\n        this.rubberband.addPoint([ x, y ]);\n      } else {\n        this.emit('cancel');\n        this.stop();\n      }\n    }\n  }\n  onScaleChanged = scale => {\n    \n    if (this.rubberband)\n      this.rubberband.onScaleChanged(scale);\n  }\n  onDblClickOld = (x, y) => {\n    this._isDrawing = false;\n    this.rubberband.addPoint([ x, y ]);\n\n    const shape = this.rubberband.element;\n    shape.annotation = this.rubberband.toSelection();\n    shape.annotation.underlying[\"generated\"] = this.startTime;\n    this.emit('complete', shape);\n\n    this.stop();\n  }\n\n  onDblClick = (x, y) => {\n  }\n\n  createEditableShape = annotation => \n    new EditableBetterMultipolygon(annotation, this.g, this.config, this.env);\n\n}\n\nRubberbandBetterMultipolygonTool.identifier = 'bettermultipolygon';\n\nRubberbandBetterMultipolygonTool.supports = annotation => {\n  const selector = annotation.selector('SvgSelector');\n  if (selector)\n    return selector.value?.match(/^<svg.*<path d=/g);\n}","import PointTool from './point/PointTool';\nimport RubberbandCircleTool from './circle/RubberbandCircleTool';\nimport RubberbandEllipseTool from './ellipse/RubberbandEllipseTool';\nimport RubberbandFreehandTool from './freehand/RubberbandFreehandTool';\nimport RubberbandMultipolygonTool from './multipolygon/RubberbandMultipolygonTool';\nimport RubberbandBetterMultipolygonTool from './betterMultipolygon/RubberbandBetterMultipolygonTool';\n\nconst ALL_TOOLS = new Set([\n  'point',\n  'circle',\n  'ellipse',\n  'freehand',\n  // 'multipolygon',\n  'bettermultipolygon'\n]);\n\nconst SelectorPack = (anno, config) => {\n\n  // Add configured tools, or all\n  const useTools = config?.tools ? \n    new Set(config.tools.map(t => t.toLowerCase())) : ALL_TOOLS;\n  if (useTools.has('circle'))\n    anno.addDrawingTool(RubberbandCircleTool);\n\n  if (useTools.has('point'))\n    anno.addDrawingTool(PointTool);\n\n  if (useTools.has('ellipse'))\n    anno.addDrawingTool(RubberbandEllipseTool);\n  \n  if (useTools.has('freehand'))\n    anno.addDrawingTool(RubberbandFreehandTool);\n  if (useTools.has('bettermultipolygon')){\n    anno.addDrawingTool(RubberbandBetterMultipolygonTool);\n  }\n  if (useTools.has('multipolygon'))\n  anno.addDrawingTool(RubberbandBetterMultipolygonTool);\n\n}\n\nexport default SelectorPack;\n"],"names":["root","factory","exports","module","define","amd","self","i","t","r","e","a","h","n","o","s","l","Math","log","f","exp","u","sqrt","max","floor","min","p","d","x","length","this","_maxEntries","_minEntries","ceil","clear","indexOf","children","minX","minY","maxX","maxY","leaf","m","c","height","pop","push","prototype","all","_all","data","search","toBBox","collides","load","insert","_build","slice","_splitRoot","_insert","remove","splice","_condense","compareMinX","compareMinY","toJSON","fromJSON","apply","pow","_chooseSubtree","_split","_adjustParentBBoxes","_chooseSplitAxis","_chooseSplitIndex","v","M","_allDistMargin","sort","E","on","name","callback","ctx","fn","once","listener","off","arguments","_","emit","call","evtArr","len","evts","liveEvents","TinyEmitter","equal","b","constructor","keys","Array","isArray","RegExp","source","flags","valueOf","Object","toString","hasOwnProperty","key","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","getter","__esModule","definition","defineProperty","enumerable","get","obj","prop","getRandomValues","isTouchDevice","window","navigator","maxTouchPoints","msMaxTouchPoints","SVG_NAMESPACE","getClassNames","el","attr","getAttribute","Set","split","addClass","className","classNames","add","setAttribute","from","join","removeClass","size","removeAttribute","hasClass","has","rnds8","Uint8Array","rng","crypto","bind","msCrypto","Error","uuid","REGEX","byteToHex","substr","options","buf","offset","rnds","random","arr","toLowerCase","validate","TypeError","stringify","WebAnnotation","annotation","opts","opt_props","opt_opts","underlying","type","target","selector","find","other","id","equals","style","readOnly","motivation","body","bodies","state","entries","value","exact","start","end","args","stub","Selection","cloned","JSON","parse","assign","IMPLEMENTATION_MISSING","isTouch","ToolLike","g","config","env","ResizeObserver","resizeObserver","svgBounds","svg","getBoundingClientRect","viewBox","baseVal","width","scale","onScaleChanged","observe","parentNode","evt","pt","createSVGPoint","bbox","clientX","y","clientY","left","top","matrixTransform","getScreenCTM","inverse","offsetX","offsetY","getCTM","containerGroup","document","createElementNS","group","drawCircle","radius","handleRadius","inner","outer","appendChild","handle","querySelector","parseFloat","contourPoints","closest","image","Element","HTMLDocument","enableResponsive","disconnect","EventEmitter","Tool","mouseMove","mouseUp","dblClick","getSVGPoint","started","addEventListener","button","removeEventListener","startOnSingleClick","contourpoints","startDrawing","formatters","supports","EditableShape","parseRectFragment","conformsTo","startsWith","format","includes","substring","map","w","naturalWidth","naturalHeight","toFragment","fragmentUnit","px","py","pw","ph","src","toPercentRectFragment","toPixelRectFragment","toRectFragment","renderedVia","EditablePoint","scaleHandle","point","isGrabbed","setHandleXY","onMouseMove","onMouseUp","container","elementGroup","drawHandle","onGrab","removeChild","PointTool","isPoint","element","identifier","sanitize","doc","cleanEl","attributes","forEach","scripts","getElementsByTagName","reverse","querySelectorAll","svgFragmentToShape","originalDoc","namespaced","parser","DOMParser","parseFromString","isPrefixDeclared","lookupPrefix","isDefaultNamespaceSVG","lookupNamespaceURI","firstChild","XMLSerializer","serializeToString","documentElement","replace","drawEmbeddedSVG","shape","cloneNode","toSVGTarget","serialized","outerHTML","setXYR","setCircleSize","cx","cy","innerCircle","outerCircle","getCircleSize","CircleMask","imageDimensions","circle","tx","ty","mask","RubberbandCircle","anchorX","anchorY","oppositeX","oppositeY","display","anchor","redraw","Mask","pointerEvents","isFirefox","test","userAgent","formatSvgEl","svgEl","reduce","merged","String","nodeType","Node","ELEMENT_NODE","elements","formatterEl","getBBox","append","appendFormatterEl","setFormatterElSize","EditableCircle","handles","topleft","topright","bottomright","bottomleft","draggedHandleIdx","anchorHandle","mousePos","getHandleXY","mouseX","mouseY","abs","idx0","idx2","idx3","idx1","grabbedElem","pos","grabbedAt","constrain","coord","setSize","handleIdx","oppositeHandle","stretchCorners","formatter","RubberbandCircleTool","attachListeners","rubberband","destroy","dragTo","detachListeners","minWidth","minSelectionWidth","minHeight","minSelectionHeight","toSelection","stop","match","rx","ry","setEllipseSize","innerEllipse","outerEllipse","getEllipseSize","EllipseMask","ellipse","RubberbandEllipse","drawEllipse","EditableEllipse","leftHandle","anchorLeft","RubberbandEllipseTool","RubberbandFreehand","points","str","xy","addPoint","setPoints","freehand","getPoints","pointList","trim","EditableFreehand","round","num","delta","dx","dy","updatedPoints","RubberbandFreehandTool","_isDrawing","onDblClick","toUpperCase","RubberbandMultipolygon","ps","attr2","console","head","headRest","lastCorner","multipolygon","pointArray","getPointsFromPathValue","nodeValue","polygon","results","allcoords","result","index","coords","toFixed","EditableMultipolygon","first","idx","pointListIDX","found","updatedPointsIDX","newPoints","svgFragmentToPoints","RubberbandMultipolygonTool","undo","newPart","altKey","ctrlKey","RubberbandBetterMultipolygon","mousepos","closeHandle","getDistanceToStart","Infinity","pointInPolygon","x1","x2","y1","y2","is_in","EditableBetterMultipolygon","onSelectCorner","corners","thisCorner","nextCorner","drawMidpoint","selected","cornerhandlesIDX","newMidpoints","midpoints","midpointList","updatedMidpointlist","filter","object","midpointsToDelete","updatedPointlist","updatedHandles","cornerHandles","handlesList","handlesToDelete","handlesToStay","onKeyDown","midpointsIDX","grabbedElement","updatedCorners","updatedcornerListIdx","midBefore","midAfter","cornerList","updatedCornersList","updatedcornerIdx","corner","createMidpoint","cornerHandle","createCornerHandle","stopPropagation","lastMouseDown","Date","getTime","which","deleteSelected","pointlist","newPointList","cornerHandleIdx","distances","handleXY","thisXY","cornerHandleIdxUpdate","updatedPointList","onMoveShape","onMoveCornerHandle","onAddPoint","midpoint","getPath","cornerIdx","isSelected","now","MyRBush","RBush","path","RubberbandBetterMultipolygonTool","startTime","_startOnSingleClick","onMouseDown","selection","onDblClickOld","shiftKey","contourPointsFunc","contourPointsRBush","viewer","ALL_TOOLS","anno","useTools","tools","addDrawingTool"],"sourceRoot":""}